"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[16],{19:function(e,t,n){n.d(t,{u7:function(){return al},Jj:function(){return uc},IX:function(){return Wu},my:function(){return wu},xU:function(){return hl},Lz:function(){return cc},WA:function(){return S},F8:function(){return hc},$q:function(){return dl},W:function(){return fl},EK:function(){return q},PU:function(){return Rl},l7:function(){return Oe},Ky:function(){return Q},Xb:function(){return $},Cf:function(){return du},K9:function(){return b},Me:function(){return _e},yq:function(){return y},Wi:function(){return uu},ET:function(){return Dl},Ab:function(){return ql},vr:function(){return Pl},Fc:function(){return tc},hJ:function(){return bu},B$:function(){return Tu},at:function(){return yu},oe:function(){return xl},AK:function(){return Fl},TF:function(){return sc},JU:function(){return Eu},ST:function(){return Zu},fH:function(){return Ju},Ix:function(){return rc},Wu:function(){return nl},Lx:function(){return tl},qY:function(){return Yu},GL:function(){return Al},QT:function(){return pl},kl:function(){return wl},Xk:function(){return vl},PL:function(){return Il},UQ:function(){return bl},zN:function(){return Tl},nP:function(){return Ul},b9:function(){return Hc},vh:function(){return Yc},Pb:function(){return ic},L$:function(){return oc},cf:function(){return _l},sc:function(){return Nl},Xo:function(){return jc},IO:function(){return Gc},iE:function(){return xu},Eo:function(){return Su},i3:function(){return Ml},Bt:function(){return Ol},pl:function(){return El},Ub:function(){return m},qK:function(){return gl},TQ:function(){return Jc},e0:function(){return Zc},r7:function(){return Sl},Mx:function(){return nc},ar:function(){return Qc}});var r=n(5816),s=n(8463),i=n(3333),o=n(4444),a=n(3510),u=n(4155);const c="@firebase/firestore";class l{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}l.UNAUTHENTICATED=new l(null),l.GOOGLE_CREDENTIALS=new l("google-credentials-uid"),l.FIRST_PARTY=new l("first-party-uid"),l.MOCK_USER=new l("mock-user");let h="9.13.0";const d=new i.Yd("@firebase/firestore");function f(){return d.logLevel}function m(e){d.setLogLevel(e)}function g(e,...t){if(d.logLevel<=i.in.DEBUG){const n=t.map(w);d.debug(`Firestore (${h}): ${e}`,...n)}}function p(e,...t){if(d.logLevel<=i.in.ERROR){const n=t.map(w);d.error(`Firestore (${h}): ${e}`,...n)}}function y(e,...t){if(d.logLevel<=i.in.WARN){const n=t.map(w);d.warn(`Firestore (${h}): ${e}`,...n)}}function w(e){if("string"==typeof e)return e;try{return t=e,JSON.stringify(t)}catch(t){return e}var t}function v(e="Unexpected state"){const t=`FIRESTORE (${h}) INTERNAL ASSERTION FAILED: `+e;throw p(t),new Error(t)}function I(e,t){e||v()}function b(e,t){e||v()}function T(e,t){return e}const E={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class S extends o.ZR{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class x{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class D{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class _{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(l.UNAUTHENTICATED)))}shutdown(){}}class N{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable((()=>t(this.token.user)))}shutdown(){this.changeListener=null}}class A{constructor(e){this.t=e,this.currentUser=l.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let n=this.i;const r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let s=new x;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new x,e.enqueueRetryable((()=>r(this.currentUser)))};const i=()=>{const t=s;e.enqueueRetryable((async()=>{await t.promise,await r(this.currentUser)}))},o=e=>{g("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((e=>o(e))),setTimeout((()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?o(e):(g("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new x)}}),0),i()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?(g("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(I("string"==typeof t.accessToken),new D(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const e=this.auth&&this.auth.getUid();return I(null===e||"string"==typeof e),new l(e)}}class C{constructor(e,t,n,r){this.h=e,this.l=t,this.m=n,this.g=r,this.type="FirstParty",this.user=l.FIRST_PARTY,this.p=new Map}I(){return this.g?this.g():(I(!("object"!=typeof this.h||null===this.h||!this.h.auth||!this.h.auth.getAuthHeaderValueForFirstParty)),this.h.auth.getAuthHeaderValueForFirstParty([]))}get headers(){this.p.set("X-Goog-AuthUser",this.l);const e=this.I();return e&&this.p.set("Authorization",e),this.m&&this.p.set("X-Goog-Iam-Authorization-Token",this.m),this.p}}class k{constructor(e,t,n,r){this.h=e,this.l=t,this.m=n,this.g=r}getToken(){return Promise.resolve(new C(this.h,this.l,this.m,this.g))}start(e,t){e.enqueueRetryable((()=>t(l.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class R{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class V{constructor(e){this.T=e,this.forceRefresh=!1,this.appCheck=null,this.A=null}start(e,t){const n=e=>{null!=e.error&&g("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.A;return this.A=e.token,g("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable((()=>n(t)))};const r=e=>{g("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.T.onInit((e=>r(e))),setTimeout((()=>{if(!this.appCheck){const e=this.T.getImmediate({optional:!0});e?r(e):g("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(I("string"==typeof e.token),this.A=e.token,new R(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}function L(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let r=0;r<e;r++)n[r]=Math.floor(256*Math.random());return n}class M{static R(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length;let n="";for(;n.length<20;){const r=L(40);for(let s=0;s<r.length;++s)n.length<20&&r[s]<t&&(n+=e.charAt(r[s]%e.length))}return n}}function F(e,t){return e<t?-1:e>t?1:0}function O(e,t,n){return e.length===t.length&&e.every(((e,r)=>n(e,t[r])))}function P(e){return e+"\0"}class q{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new S(E.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new S(E.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new S(E.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new S(E.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return q.fromMillis(Date.now())}static fromDate(e){return q.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new q(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?F(this.nanoseconds,e.nanoseconds):F(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class U{constructor(e){this.timestamp=e}static fromTimestamp(e){return new U(e)}static min(){return new U(new q(0,0))}static max(){return new U(new q(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class B{constructor(e,t,n){void 0===t?t=0:t>e.length&&v(),void 0===n?n=e.length-t:n>e.length-t&&v(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===B.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof B?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),s=t.get(r);if(n<s)return-1;if(n>s)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class K extends B{construct(e,t,n){return new K(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new S(E.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter((e=>e.length>0)))}return new K(t)}static emptyPath(){return new K([])}}const G=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class $ extends B{construct(e,t,n){return new $(e,t,n)}static isValidIdentifier(e){return G.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),$.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new $(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;const s=()=>{if(0===n.length)throw new S(E.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new S(E.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new S(E.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?(i=!i,r++):"."!==t||i?(n+=t,r++):(s(),r++)}if(s(),i)throw new S(E.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new $(t)}static emptyPath(){return new $([])}}class Q{constructor(e){this.path=e}static fromPath(e){return new Q(K.fromString(e))}static fromName(e){return new Q(K.fromString(e).popFirst(5))}static empty(){return new Q(K.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===K.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return K.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new Q(new K(e.slice()))}}class z{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function j(e){return e.fields.find((e=>2===e.kind))}function W(e){return e.fields.filter((e=>2!==e.kind))}z.UNKNOWN_ID=-1;class H{constructor(e,t){this.fieldPath=e,this.kind=t}}class Y{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new Y(0,J.min())}}function X(e,t){const n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,s=U.fromTimestamp(1e9===r?new q(n+1,0):new q(n,r));return new J(s,Q.empty(),t)}function Z(e){return new J(e.readTime,e.key,-1)}class J{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new J(U.min(),Q.empty(),-1)}static max(){return new J(U.max(),Q.empty(),-1)}}function ee(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=Q.comparator(e.documentKey,t.documentKey),0!==n?n:F(e.largestBatchId,t.largestBatchId))}const te="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ne{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}async function re(e){if(e.code!==E.FAILED_PRECONDITION||e.message!==te)throw e;g("LocalStore","Unexpectedly lost primary lease")}class se{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&v(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new se(((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof se?t:se.resolve(t)}catch(e){return se.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):se.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):se.reject(t)}static resolve(e){return new se(((t,n)=>{t(e)}))}static reject(e){return new se(((t,n)=>{n(e)}))}static waitFor(e){return new se(((t,n)=>{let r=0,s=0,i=!1;e.forEach((e=>{++r,e.next((()=>{++s,i&&s===r&&t()}),(e=>n(e)))})),i=!0,s===r&&t()}))}static or(e){let t=se.resolve(!1);for(const n of e)t=t.next((e=>e?se.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,r)=>{n.push(t.call(this,e,r))})),this.waitFor(n)}static mapArray(e,t){return new se(((n,r)=>{const s=e.length,i=new Array(s);let o=0;for(let a=0;a<s;a++){const u=a;t(e[u]).next((e=>{i[u]=e,++o,o===s&&n(i)}),(e=>r(e)))}}))}static doWhile(e,t){return new se(((n,r)=>{const s=()=>{!0===e()?t().next((()=>{s()}),r):n()};s()}))}}class ie{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.P=new x,this.transaction.oncomplete=()=>{this.P.resolve()},this.transaction.onabort=()=>{t.error?this.P.reject(new ue(e,t.error)):this.P.resolve()},this.transaction.onerror=t=>{const n=fe(t.target.error);this.P.reject(new ue(e,n))}}static open(e,t,n,r){try{return new ie(t,e.transaction(r,n))}catch(e){throw new ue(t,e)}}get v(){return this.P.promise}abort(e){e&&this.P.reject(e),this.aborted||(g("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}V(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){const t=this.transaction.objectStore(e);return new le(t)}}class oe{constructor(e,t,n){this.name=e,this.version=t,this.S=n,12.2===oe.D((0,o.z$)())&&p("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return g("SimpleDb","Removing database:",e),he(window.indexedDB.deleteDatabase(e)).toPromise()}static C(){if(!(0,o.hl)())return!1;if(oe.N())return!0;const e=(0,o.z$)(),t=oe.D(e),n=0<t&&t<10,r=oe.k(e),s=0<r&&r<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||n||s)}static N(){var e;return"undefined"!=typeof u&&"YES"===(null===(e=u.env)||void 0===e?void 0:e.O)}static M(e,t){return e.store(t)}static D(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static k(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async F(e){return this.db||(g("SimpleDb","Opening database:",this.name),this.db=await new Promise(((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{const n=e.target.result;t(n)},r.onblocked=()=>{n(new ue(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{const r=t.target.error;"VersionError"===r.name?n(new S(E.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new S(E.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new ue(e,r))},r.onupgradeneeded=e=>{g("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);const t=e.target.result;this.S.$(t,r.transaction,e.oldVersion,this.version).next((()=>{g("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.B&&(this.db.onversionchange=e=>this.B(e)),this.db}L(e){this.B=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){const s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.F(e);const t=ie.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next((e=>(t.V(),e))).catch((e=>(t.abort(e),se.reject(e)))).toPromise();return i.catch((()=>{})),await t.v,i}catch(e){const t=e,n="FirebaseError"!==t.name&&i<3;if(g("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class ae{constructor(e){this.U=e,this.q=!1,this.K=null}get isDone(){return this.q}get G(){return this.K}set cursor(e){this.U=e}done(){this.q=!0}j(e){this.K=e}delete(){return he(this.U.delete())}}class ue extends S{constructor(e,t){super(E.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function ce(e){return"IndexedDbTransactionError"===e.name}class le{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(g("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(g("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),he(n)}add(e){return g("SimpleDb","ADD",this.store.name,e,e),he(this.store.add(e))}get(e){return he(this.store.get(e)).next((t=>(void 0===t&&(t=null),g("SimpleDb","GET",this.store.name,e,t),t)))}delete(e){return g("SimpleDb","DELETE",this.store.name,e),he(this.store.delete(e))}count(){return g("SimpleDb","COUNT",this.store.name),he(this.store.count())}W(e,t){const n=this.options(e,t);if(n.index||"function"!=typeof this.store.getAll){const e=this.cursor(n),t=[];return this.H(e,((e,n)=>{t.push(n)})).next((()=>t))}{const e=this.store.getAll(n.range);return new se(((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}}))}}J(e,t){const n=this.store.getAll(e,null===t?void 0:t);return new se(((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}}))}Y(e,t){g("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.X=!1;const r=this.cursor(n);return this.H(r,((e,t,n)=>n.delete()))}Z(e,t){let n;t?n=e:(n={},t=e);const r=this.cursor(n);return this.H(r,t)}tt(e){const t=this.cursor({});return new se(((n,r)=>{t.onerror=e=>{const t=fe(e.target.error);r(t)},t.onsuccess=t=>{const r=t.target.result;r?e(r.primaryKey,r.value).next((e=>{e?r.continue():n()})):n()}}))}H(e,t){const n=[];return new se(((r,s)=>{e.onerror=e=>{s(e.target.error)},e.onsuccess=e=>{const s=e.target.result;if(!s)return void r();const i=new ae(s),o=t(s.primaryKey,s.value,i);if(o instanceof se){const e=o.catch((e=>(i.done(),se.reject(e))));n.push(e)}i.isDone?r():null===i.G?s.continue():s.continue(i.G)}})).next((()=>se.waitFor(n)))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.X?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function he(e){return new se(((t,n)=>{e.onsuccess=e=>{const n=e.target.result;t(n)},e.onerror=e=>{const t=fe(e.target.error);n(t)}}))}let de=!1;function fe(e){const t=oe.D((0,o.z$)());if(t>=12.2&&t<13){const t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){const e=new S("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return de||(de=!0,setTimeout((()=>{throw e}),0)),e}}return e}class me{constructor(e,t){this.asyncQueue=e,this.et=t,this.task=null}start(){this.nt(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}nt(e){g("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,(async()=>{this.task=null;try{g("IndexBackiller",`Documents written: ${await this.et.st()}`)}catch(e){ce(e)?g("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await re(e)}await this.nt(6e4)}))}}class ge{constructor(e,t){this.localStore=e,this.persistence=t}async st(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(t=>this.it(t,e)))}it(e,t){const n=new Set;let r=t,s=!0;return se.doWhile((()=>!0===s&&r>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next((t=>{if(null!==t&&!n.has(t))return g("IndexBackiller",`Processing collection: ${t}`),this.rt(e,t,r).next((e=>{r-=e,n.add(t)}));s=!1})))).next((()=>t-r))}rt(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next((r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next((n=>{const s=n.changes;return this.localStore.indexManager.updateIndexEntries(e,s).next((()=>this.ot(r,n))).next((n=>(g("IndexBackiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n)))).next((()=>s.size))}))))}ot(e,t){let n=e;return t.changes.forEach(((e,t)=>{const r=Z(t);ee(r,n)>0&&(n=r)})),new J(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class pe{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ut(e),this.ct=e=>t.writeSequenceNumber(e))}ut(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.ct&&this.ct(e),e}}function ye(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function we(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function ve(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}pe.at=-1;class Ie{constructor(e,t){this.comparator=e,this.root=t||Te.EMPTY}insert(e,t){return new Ie(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,Te.BLACK,null,null))}remove(e){return new Ie(this.comparator,this.root.remove(e,this.comparator).copy(null,null,Te.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push(`${t}:${n}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new be(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new be(this.root,e,this.comparator,!1)}getReverseIterator(){return new be(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new be(this.root,e,this.comparator,!0)}}class be{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class Te{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:Te.RED,this.left=null!=r?r:Te.EMPTY,this.right=null!=s?s:Te.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new Te(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;const s=n(e,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return Te.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return Te.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,Te.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,Te.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw v();if(this.right.isRed())throw v();const e=this.left.check();if(e!==this.right.check())throw v();return e+(this.isRed()?0:1)}}Te.EMPTY=null,Te.RED=!0,Te.BLACK=!1,Te.EMPTY=new class{constructor(){this.size=0}get key(){throw v()}get value(){throw v()}get color(){throw v()}get left(){throw v()}get right(){throw v()}copy(e,t,n,r,s){return this}insert(e,t,n){return new Te(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Ee{constructor(e){this.comparator=e,this.data=new Ie(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new Se(this.data.getIterator())}getIteratorFrom(e){return new Se(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof Ee))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new Ee(this.comparator);return t.data=e,t}}class Se{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function xe(e){return e.hasNext()?e.getNext():void 0}class De{constructor(e){this.fields=e,e.sort($.comparator)}static empty(){return new De([])}unionWith(e){let t=new Ee($.comparator);for(const n of this.fields)t=t.add(n);for(const n of e)t=t.add(n);return new De(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return O(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}function _e(){return"undefined"!=typeof atob}class Ne{constructor(e){this.binaryString=e}static fromBase64String(e){const t=atob(e);return new Ne(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new Ne(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return F(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}Ne.EMPTY_BYTE_STRING=new Ne("");const Ae=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Ce(e){if(I(!!e),"string"==typeof e){let t=0;const n=Ae.exec(e);if(I(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}return{seconds:ke(e.seconds),nanos:ke(e.nanos)}}function ke(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function Re(e){return"string"==typeof e?Ne.fromBase64String(e):Ne.fromUint8Array(e)}function Ve(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function Le(e){const t=e.mapValue.fields.__previous_value__;return Ve(t)?Le(t):t}function Me(e){const t=Ce(e.mapValue.fields.__local_write_time__.timestampValue);return new q(t.seconds,t.nanos)}class Fe{constructor(e,t,n,r,s,i,o,a){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class Oe{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new Oe("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof Oe&&e.projectId===this.projectId&&e.database===this.database}}function Pe(e){return null==e}function qe(e){return 0===e&&1/e==-1/0}function Ue(e){return"number"==typeof e&&Number.isInteger(e)&&!qe(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}const Be={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Ke={nullValue:"NULL_VALUE"};function Ge(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Ve(e)?4:rt(e)?9007199254740991:10:v()}function $e(e,t){if(e===t)return!0;const n=Ge(e);if(n!==Ge(t))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return Me(e).isEqual(Me(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=Ce(e.timestampValue),r=Ce(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return Re(e.bytesValue).isEqual(Re(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return ke(e.geoPointValue.latitude)===ke(t.geoPointValue.latitude)&&ke(e.geoPointValue.longitude)===ke(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return ke(e.integerValue)===ke(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=ke(e.doubleValue),r=ke(t.doubleValue);return n===r?qe(n)===qe(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return O(e.arrayValue.values||[],t.arrayValue.values||[],$e);case 10:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(ye(n)!==ye(r))return!1;for(const s in n)if(n.hasOwnProperty(s)&&(void 0===r[s]||!$e(n[s],r[s])))return!1;return!0}(e,t);default:return v()}}function Qe(e,t){return void 0!==(e.values||[]).find((e=>$e(e,t)))}function ze(e,t){if(e===t)return 0;const n=Ge(e),r=Ge(t);if(n!==r)return F(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return F(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=ke(e.integerValue||e.doubleValue),r=ke(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return je(e.timestampValue,t.timestampValue);case 4:return je(Me(e),Me(t));case 5:return F(e.stringValue,t.stringValue);case 6:return function(e,t){const n=Re(e),r=Re(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),r=t.split("/");for(let s=0;s<n.length&&s<r.length;s++){const e=F(n[s],r[s]);if(0!==e)return e}return F(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=F(ke(e.latitude),ke(t.latitude));return 0!==n?n:F(ke(e.longitude),ke(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return function(e,t){const n=e.values||[],r=t.values||[];for(let s=0;s<n.length&&s<r.length;++s){const e=ze(n[s],r[s]);if(e)return e}return F(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===Be.mapValue&&t===Be.mapValue)return 0;if(e===Be.mapValue)return 1;if(t===Be.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),s=t.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let o=0;o<r.length&&o<i.length;++o){const e=F(r[o],i[o]);if(0!==e)return e;const t=ze(n[r[o]],s[i[o]]);if(0!==t)return t}return F(r.length,i.length)}(e.mapValue,t.mapValue);default:throw v()}}function je(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return F(e,t);const n=Ce(e),r=Ce(t),s=F(n.seconds,r.seconds);return 0!==s?s:F(n.nanos,r.nanos)}function We(e){return He(e)}function He(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=Ce(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?Re(e.bytesValue).toBase64():"referenceValue"in e?(n=e.referenceValue,Q.fromName(n).toString()):"geoPointValue"in e?`geo(${(t=e.geoPointValue).latitude},${t.longitude})`:"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=He(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const s of t)r?r=!1:n+=",",n+=`${s}:${He(e.fields[s])}`;return n+"}"}(e.mapValue):v();var t,n}function Ye(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Xe(e){return!!e&&"integerValue"in e}function Ze(e){return!!e&&"arrayValue"in e}function Je(e){return!!e&&"nullValue"in e}function et(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function tt(e){return!!e&&"mapValue"in e}function nt(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return we(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=nt(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=nt(e.arrayValue.values[n]);return t}return Object.assign({},e)}function rt(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function st(e){return"nullValue"in e?Ke:"booleanValue"in e?{booleanValue:!1}:"integerValue"in e||"doubleValue"in e?{doubleValue:NaN}:"timestampValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in e?{stringValue:""}:"bytesValue"in e?{bytesValue:""}:"referenceValue"in e?Ye(Oe.empty(),Q.empty()):"geoPointValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in e?{arrayValue:{}}:"mapValue"in e?{mapValue:{}}:v()}function it(e){return"nullValue"in e?{booleanValue:!1}:"booleanValue"in e?{doubleValue:NaN}:"integerValue"in e||"doubleValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in e?{stringValue:""}:"stringValue"in e?{bytesValue:""}:"bytesValue"in e?Ye(Oe.empty(),Q.empty()):"referenceValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in e?{arrayValue:{}}:"arrayValue"in e?{mapValue:{}}:"mapValue"in e?Be:v()}function ot(e,t){const n=ze(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function at(e,t){const n=ze(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class ut{constructor(e){this.value=e}static empty(){return new ut({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!tt(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=nt(t)}setAll(e){let t=$.emptyPath(),n={},r=[];e.forEach(((e,s)=>{if(!t.isImmediateParentOf(s)){const e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=s.popLast()}e?n[s.lastSegment()]=nt(e):r.push(s.lastSegment())}));const s=this.getFieldsMap(t);this.applyChanges(s,n,r)}delete(e){const t=this.field(e.popLast());tt(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return $e(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];tt(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){we(t,((t,n)=>e[t]=n));for(const r of n)delete e[r]}clone(){return new ut(nt(this.value))}}function ct(e){const t=[];return we(e.fields,((e,n)=>{const r=new $([e]);if(tt(n)){const e=ct(n.mapValue).fields;if(0===e.length)t.push(r);else for(const n of e)t.push(r.child(n))}else t.push(r)})),new De(t)}class lt{constructor(e,t,n,r,s,i){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.data=s,this.documentState=i}static newInvalidDocument(e){return new lt(e,0,U.min(),U.min(),ut.empty(),0)}static newFoundDocument(e,t,n){return new lt(e,1,t,U.min(),n,0)}static newNoDocument(e,t){return new lt(e,2,t,U.min(),ut.empty(),0)}static newUnknownDocument(e,t){return new lt(e,3,t,U.min(),ut.empty(),2)}convertToFoundDocument(e,t){return this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=ut.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=ut.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=U.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof lt&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new lt(this.key,this.documentType,this.version,this.readTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class ht{constructor(e,t=null,n=[],r=[],s=null,i=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.ht=null}}function dt(e,t=null,n=[],r=[],s=null,i=null,o=null){return new ht(e,t,n,r,s,i,o)}function ft(e){const t=T(e);if(null===t.ht){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>{return(t=e).field.canonicalString()+t.op.toString()+We(t.value);var t})).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),Pe(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((e=>We(e))).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((e=>We(e))).join(",")),t.ht=e}return t.ht}function mt(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let s=0;s<e.orderBy.length;s++)if(!Ct(e.orderBy[s],t.orderBy[s]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let s=0;s<e.filters.length;s++)if(n=e.filters[s],r=t.filters[s],n.op!==r.op||!n.field.isEqual(r.field)||!$e(n.value,r.value))return!1;var n,r;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Rt(e.startAt,t.startAt)&&Rt(e.endAt,t.endAt)}function gt(e){return Q.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function pt(e,t){return e.filters.filter((e=>e instanceof vt&&e.field.isEqual(t)))}function yt(e,t,n){let r=Ke,s=!0;for(const i of pt(e,t)){let e=Ke,t=!0;switch(i.op){case"<":case"<=":e=st(i.value);break;case"==":case"in":case">=":e=i.value;break;case">":e=i.value,t=!1;break;case"!=":case"not-in":e=Ke}ot({value:r,inclusive:s},{value:e,inclusive:t})<0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];ot({value:r,inclusive:s},{value:e,inclusive:n.inclusive})<0&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}function wt(e,t,n){let r=Be,s=!0;for(const i of pt(e,t)){let e=Be,t=!0;switch(i.op){case">=":case">":e=it(i.value),t=!1;break;case"==":case"in":case"<=":e=i.value;break;case"<":e=i.value,t=!1;break;case"!=":case"not-in":e=Be}at({value:r,inclusive:s},{value:e,inclusive:t})>0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];at({value:r,inclusive:s},{value:e,inclusive:n.inclusive})>0&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}class vt extends class{}{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.lt(e,t,n):new It(e,t,n):"array-contains"===t?new St(e,n):"in"===t?new xt(e,n):"not-in"===t?new Dt(e,n):"array-contains-any"===t?new _t(e,n):new vt(e,t,n)}static lt(e,t,n){return"in"===t?new bt(e,n):new Tt(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.ft(ze(t,this.value)):null!==t&&Ge(this.value)===Ge(t)&&this.ft(ze(t,this.value))}ft(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return v()}}dt(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}}class It extends vt{constructor(e,t,n){super(e,t,n),this.key=Q.fromName(n.referenceValue)}matches(e){const t=Q.comparator(e.key,this.key);return this.ft(t)}}class bt extends vt{constructor(e,t){super(e,"in",t),this.keys=Et("in",t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class Tt extends vt{constructor(e,t){super(e,"not-in",t),this.keys=Et("not-in",t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function Et(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>Q.fromName(e.referenceValue)))}class St extends vt{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return Ze(t)&&Qe(t.arrayValue,this.value)}}class xt extends vt{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&Qe(this.value.arrayValue,t)}}class Dt extends vt{constructor(e,t){super(e,"not-in",t)}matches(e){if(Qe(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!Qe(this.value.arrayValue,t)}}class _t extends vt{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Ze(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>Qe(this.value.arrayValue,e)))}}class Nt{constructor(e,t){this.position=e,this.inclusive=t}}class At{constructor(e,t="asc"){this.field=e,this.dir=t}}function Ct(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}function kt(e,t,n){let r=0;for(let s=0;s<e.position.length;s++){const i=t[s],o=e.position[s];if(r=i.field.isKeyField()?Q.comparator(Q.fromName(o.referenceValue),n.key):ze(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function Rt(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!$e(e.position[n],t.position[n]))return!1;return!0}class Vt{constructor(e,t=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this._t=null,this.wt=null,this.startAt,this.endAt}}function Lt(e,t,n,r,s,i,o,a){return new Vt(e,t,n,r,s,i,o,a)}function Mt(e){return new Vt(e)}function Ft(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Ot(e){return e.explicitOrderBy.length>0?e.explicitOrderBy[0].field:null}function Pt(e){for(const t of e.filters)if(t.dt())return t.field;return null}function qt(e){return null!==e.collectionGroup}function Ut(e){const t=T(e);if(null===t._t){t._t=[];const e=Pt(t),n=Ot(t);if(null!==e&&null===n)e.isKeyField()||t._t.push(new At(e)),t._t.push(new At($.keyField(),"asc"));else{let e=!1;for(const n of t.explicitOrderBy)t._t.push(n),n.field.isKeyField()&&(e=!0);if(!e){const e=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";t._t.push(new At($.keyField(),e))}}}return t._t}function Bt(e){const t=T(e);if(!t.wt)if("F"===t.limitType)t.wt=dt(t.path,t.collectionGroup,Ut(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const s of Ut(t)){const t="desc"===s.dir?"asc":"desc";e.push(new At(s.field,t))}const n=t.endAt?new Nt(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new Nt(t.startAt.position,t.startAt.inclusive):null;t.wt=dt(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}return t.wt}function Kt(e,t,n){return new Vt(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Gt(e,t){return mt(Bt(e),Bt(t))&&e.limitType===t.limitType}function $t(e){return`${ft(Bt(e))}|lt:${e.limitType}`}function Qt(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map((e=>{return`${(t=e).field.canonicalString()} ${t.op} ${We(t.value)}`;var t})).join(", ")}]`),Pe(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map((e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e))).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((e=>We(e))).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((e=>We(e))).join(",")),`Target(${t})`}(Bt(e))}; limitType=${e.limitType})`}function zt(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):Q.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of e.explicitOrderBy)if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){const r=kt(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,Ut(e),t))&&!(e.endAt&&!function(e,t,n){const r=kt(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,Ut(e),t))}(e,t)}function jt(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function Wt(e){return(t,n)=>{let r=!1;for(const s of Ut(e)){const e=Ht(s,t,n);if(0!==e)return e;r=r||s.field.isKeyField()}return 0}}function Ht(e,t,n){const r=e.field.isKeyField()?Q.comparator(t.key,n.key):function(e,t,n){const r=t.data.field(e),s=n.data.field(e);return null!==r&&null!==s?ze(r,s):v()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return v()}}function Yt(e,t){if(e.gt){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:qe(t)?"-0":t}}function Xt(e){return{integerValue:""+e}}function Zt(e,t){return Ue(t)?Xt(t):Yt(e,t)}class Jt{constructor(){this._=void 0}}function en(e,t,n){return e instanceof rn?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof sn?on(e,t):e instanceof an?un(e,t):function(e,t){const n=nn(e,t),r=ln(n)+ln(e.yt);return Xe(n)&&Xe(e.yt)?Xt(r):Yt(e.It,r)}(e,t)}function tn(e,t,n){return e instanceof sn?on(e,t):e instanceof an?un(e,t):n}function nn(e,t){return e instanceof cn?Xe(n=t)||function(e){return!!e&&"doubleValue"in e}(n)?t:{integerValue:0}:null;var n}class rn extends Jt{}class sn extends Jt{constructor(e){super(),this.elements=e}}function on(e,t){const n=hn(t);for(const r of e.elements)n.some((e=>$e(e,r)))||n.push(r);return{arrayValue:{values:n}}}class an extends Jt{constructor(e){super(),this.elements=e}}function un(e,t){let n=hn(t);for(const r of e.elements)n=n.filter((e=>!$e(e,r)));return{arrayValue:{values:n}}}class cn extends Jt{constructor(e,t){super(),this.It=e,this.yt=t}}function ln(e){return ke(e.integerValue||e.doubleValue)}function hn(e){return Ze(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class dn{constructor(e,t){this.field=e,this.transform=t}}class fn{constructor(e,t){this.version=e,this.transformResults=t}}class mn{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new mn}static exists(e){return new mn(void 0,e)}static updateTime(e){return new mn(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function gn(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class pn{}function yn(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new _n(e.key,mn.none()):new Tn(e.key,e.data,mn.none());{const n=e.data,r=ut.empty();let s=new Ee($.comparator);for(let e of t.fields)if(!s.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),s=s.add(e)}return new En(e.key,r,new De(s.toArray()),mn.none())}}function wn(e,t,n){e instanceof Tn?function(e,t,n){const r=e.value.clone(),s=xn(e.fieldTransforms,t,n.transformResults);r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof En?function(e,t,n){if(!gn(e.precondition,t))return void t.convertToUnknownDocument(n.version);const r=xn(e.fieldTransforms,t,n.transformResults),s=t.data;s.setAll(Sn(e)),s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function vn(e,t,n,r){return e instanceof Tn?function(e,t,n,r){if(!gn(e.precondition,t))return n;const s=e.value.clone(),i=Dn(e.fieldTransforms,r,t);return s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null}(e,t,n,r):e instanceof En?function(e,t,n,r){if(!gn(e.precondition,t))return n;const s=Dn(e.fieldTransforms,r,t),i=t.data;return i.setAll(Sn(e)),i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map((e=>e.field)))}(e,t,n,r):function(e,t,n){return gn(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}(e,t,n)}function In(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=nn(r.transform,e||null);null!=s&&(null===n&&(n=ut.empty()),n.set(r.field,s))}return n||null}function bn(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&O(e,t,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof sn&&t instanceof sn||e instanceof an&&t instanceof an?O(e.elements,t.elements,$e):e instanceof cn&&t instanceof cn?$e(e.yt,t.yt):e instanceof rn&&t instanceof rn}(e.transform,t.transform)}(e,t)))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class Tn extends pn{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class En extends pn{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function Sn(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=e.data.field(n);t.set(n,r)}})),t}function xn(e,t,n){const r=new Map;I(e.length===n.length);for(let s=0;s<n.length;s++){const i=e[s],o=i.transform,a=t.data.field(i.field);r.set(i.field,tn(o,a,n[s]))}return r}function Dn(e,t,n){const r=new Map;for(const s of e){const e=s.transform,i=n.data.field(s.field);r.set(s.field,en(e,i,t))}return r}class _n extends pn{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Nn extends pn{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class An{constructor(e){this.count=e}}var Cn,kn;function Rn(e){switch(e){default:return v();case E.CANCELLED:case E.UNKNOWN:case E.DEADLINE_EXCEEDED:case E.RESOURCE_EXHAUSTED:case E.INTERNAL:case E.UNAVAILABLE:case E.UNAUTHENTICATED:return!1;case E.INVALID_ARGUMENT:case E.NOT_FOUND:case E.ALREADY_EXISTS:case E.PERMISSION_DENIED:case E.FAILED_PRECONDITION:case E.ABORTED:case E.OUT_OF_RANGE:case E.UNIMPLEMENTED:case E.DATA_LOSS:return!0}}function Vn(e){if(void 0===e)return p("GRPC error has no .code"),E.UNKNOWN;switch(e){case Cn.OK:return E.OK;case Cn.CANCELLED:return E.CANCELLED;case Cn.UNKNOWN:return E.UNKNOWN;case Cn.DEADLINE_EXCEEDED:return E.DEADLINE_EXCEEDED;case Cn.RESOURCE_EXHAUSTED:return E.RESOURCE_EXHAUSTED;case Cn.INTERNAL:return E.INTERNAL;case Cn.UNAVAILABLE:return E.UNAVAILABLE;case Cn.UNAUTHENTICATED:return E.UNAUTHENTICATED;case Cn.INVALID_ARGUMENT:return E.INVALID_ARGUMENT;case Cn.NOT_FOUND:return E.NOT_FOUND;case Cn.ALREADY_EXISTS:return E.ALREADY_EXISTS;case Cn.PERMISSION_DENIED:return E.PERMISSION_DENIED;case Cn.FAILED_PRECONDITION:return E.FAILED_PRECONDITION;case Cn.ABORTED:return E.ABORTED;case Cn.OUT_OF_RANGE:return E.OUT_OF_RANGE;case Cn.UNIMPLEMENTED:return E.UNIMPLEMENTED;case Cn.DATA_LOSS:return E.DATA_LOSS;default:return v()}}(kn=Cn||(Cn={}))[kn.OK=0]="OK",kn[kn.CANCELLED=1]="CANCELLED",kn[kn.UNKNOWN=2]="UNKNOWN",kn[kn.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",kn[kn.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",kn[kn.NOT_FOUND=5]="NOT_FOUND",kn[kn.ALREADY_EXISTS=6]="ALREADY_EXISTS",kn[kn.PERMISSION_DENIED=7]="PERMISSION_DENIED",kn[kn.UNAUTHENTICATED=16]="UNAUTHENTICATED",kn[kn.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",kn[kn.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",kn[kn.ABORTED=10]="ABORTED",kn[kn.OUT_OF_RANGE=11]="OUT_OF_RANGE",kn[kn.UNIMPLEMENTED=12]="UNIMPLEMENTED",kn[kn.INTERNAL=13]="INTERNAL",kn[kn.UNAVAILABLE=14]="UNAVAILABLE",kn[kn.DATA_LOSS=15]="DATA_LOSS";class Ln{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[r,s]of n)if(this.equalsFn(r,e))return s}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let s=0;s<r.length;s++)if(this.equalsFn(r[s][0],e))return void(r[s]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){we(this.inner,((t,n)=>{for(const[r,s]of n)e(r,s)}))}isEmpty(){return ve(this.inner)}size(){return this.innerSize}}const Mn=new Ie(Q.comparator);function Fn(){return Mn}const On=new Ie(Q.comparator);function Pn(...e){let t=On;for(const n of e)t=t.insert(n.key,n);return t}function qn(e){let t=On;return e.forEach(((e,n)=>t=t.insert(e,n.overlayedDocument))),t}function Un(){return Kn()}function Bn(){return Kn()}function Kn(){return new Ln((e=>e.toString()),((e,t)=>e.isEqual(t)))}const Gn=new Ie(Q.comparator),$n=new Ee(Q.comparator);function Qn(...e){let t=$n;for(const n of e)t=t.add(n);return t}const zn=new Ee(F);function jn(){return zn}class Wn{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,Hn.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new Wn(U.min(),r,jn(),Fn(),Qn())}}class Hn{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new Hn(n,t,Qn(),Qn(),Qn())}}class Yn{constructor(e,t,n,r){this.Tt=e,this.removedTargetIds=t,this.key=n,this.Et=r}}class Xn{constructor(e,t){this.targetId=e,this.At=t}}class Zn{constructor(e,t,n=Ne.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Jn{constructor(){this.Rt=0,this.bt=nr(),this.Pt=Ne.EMPTY_BYTE_STRING,this.vt=!1,this.Vt=!0}get current(){return this.vt}get resumeToken(){return this.Pt}get St(){return 0!==this.Rt}get Dt(){return this.Vt}Ct(e){e.approximateByteSize()>0&&(this.Vt=!0,this.Pt=e)}xt(){let e=Qn(),t=Qn(),n=Qn();return this.bt.forEach(((r,s)=>{switch(s){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:v()}})),new Hn(this.Pt,this.vt,e,t,n)}Nt(){this.Vt=!1,this.bt=nr()}kt(e,t){this.Vt=!0,this.bt=this.bt.insert(e,t)}Ot(e){this.Vt=!0,this.bt=this.bt.remove(e)}Mt(){this.Rt+=1}Ft(){this.Rt-=1}$t(){this.Vt=!0,this.vt=!0}}class er{constructor(e){this.Bt=e,this.Lt=new Map,this.Ut=Fn(),this.qt=tr(),this.Kt=new Ee(F)}Gt(e){for(const t of e.Tt)e.Et&&e.Et.isFoundDocument()?this.Qt(t,e.Et):this.jt(t,e.key,e.Et);for(const t of e.removedTargetIds)this.jt(t,e.key,e.Et)}Wt(e){this.forEachTarget(e,(t=>{const n=this.zt(t);switch(e.state){case 0:this.Ht(t)&&n.Ct(e.resumeToken);break;case 1:n.Ft(),n.St||n.Nt(),n.Ct(e.resumeToken);break;case 2:n.Ft(),n.St||this.removeTarget(t);break;case 3:this.Ht(t)&&(n.$t(),n.Ct(e.resumeToken));break;case 4:this.Ht(t)&&(this.Jt(t),n.Ct(e.resumeToken));break;default:v()}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Lt.forEach(((e,n)=>{this.Ht(n)&&t(n)}))}Yt(e){const t=e.targetId,n=e.At.count,r=this.Xt(t);if(r){const e=r.target;if(gt(e))if(0===n){const n=new Q(e.path);this.jt(t,n,lt.newNoDocument(n,U.min()))}else I(1===n);else this.Zt(t)!==n&&(this.Jt(t),this.Kt=this.Kt.add(t))}}te(e){const t=new Map;this.Lt.forEach(((n,r)=>{const s=this.Xt(r);if(s){if(n.current&&gt(s.target)){const t=new Q(s.target.path);null!==this.Ut.get(t)||this.ee(r,t)||this.jt(r,t,lt.newNoDocument(t,e))}n.Dt&&(t.set(r,n.xt()),n.Nt())}}));let n=Qn();this.qt.forEach(((e,t)=>{let r=!0;t.forEachWhile((e=>{const t=this.Xt(e);return!t||2===t.purpose||(r=!1,!1)})),r&&(n=n.add(e))})),this.Ut.forEach(((t,n)=>n.setReadTime(e)));const r=new Wn(e,t,this.Kt,this.Ut,n);return this.Ut=Fn(),this.qt=tr(),this.Kt=new Ee(F),r}Qt(e,t){if(!this.Ht(e))return;const n=this.ee(e,t.key)?2:0;this.zt(e).kt(t.key,n),this.Ut=this.Ut.insert(t.key,t),this.qt=this.qt.insert(t.key,this.ne(t.key).add(e))}jt(e,t,n){if(!this.Ht(e))return;const r=this.zt(e);this.ee(e,t)?r.kt(t,1):r.Ot(t),this.qt=this.qt.insert(t,this.ne(t).delete(e)),n&&(this.Ut=this.Ut.insert(t,n))}removeTarget(e){this.Lt.delete(e)}Zt(e){const t=this.zt(e).xt();return this.Bt.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Mt(e){this.zt(e).Mt()}zt(e){let t=this.Lt.get(e);return t||(t=new Jn,this.Lt.set(e,t)),t}ne(e){let t=this.qt.get(e);return t||(t=new Ee(F),this.qt=this.qt.insert(e,t)),t}Ht(e){const t=null!==this.Xt(e);return t||g("WatchChangeAggregator","Detected inactive target",e),t}Xt(e){const t=this.Lt.get(e);return t&&t.St?null:this.Bt.se(e)}Jt(e){this.Lt.set(e,new Jn),this.Bt.getRemoteKeysForTarget(e).forEach((t=>{this.jt(e,t,null)}))}ee(e,t){return this.Bt.getRemoteKeysForTarget(e).has(t)}}function tr(){return new Ie(Q.comparator)}function nr(){return new Ie(Q.comparator)}const rr={asc:"ASCENDING",desc:"DESCENDING"},sr={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class ir{constructor(e,t){this.databaseId=e,this.gt=t}}function or(e,t){return e.gt?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function ar(e,t){return e.gt?t.toBase64():t.toUint8Array()}function ur(e,t){return or(e,t.toTimestamp())}function cr(e){return I(!!e),U.fromTimestamp(function(e){const t=Ce(e);return new q(t.seconds,t.nanos)}(e))}function lr(e,t){return function(e){return new K(["projects",e.projectId,"databases",e.database])}(e).child("documents").child(t).canonicalString()}function hr(e){const t=K.fromString(e);return I(Vr(t)),t}function dr(e,t){return lr(e.databaseId,t.path)}function fr(e,t){const n=hr(t);if(n.get(1)!==e.databaseId.projectId)throw new S(E.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new S(E.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new Q(yr(n))}function mr(e,t){return lr(e.databaseId,t)}function gr(e){const t=hr(e);return 4===t.length?K.emptyPath():yr(t)}function pr(e){return new K(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function yr(e){return I(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function wr(e,t,n){return{name:dr(e,t),fields:n.value.mapValue.fields}}function vr(e,t,n){const r=fr(e,t.name),s=cr(t.updateTime),i=new ut({mapValue:{fields:t.fields}}),o=lt.newFoundDocument(r,s,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function Ir(e,t){let n;if(t instanceof Tn)n={update:wr(e,t.key,t.value)};else if(t instanceof _n)n={delete:dr(e,t.key)};else if(t instanceof En)n={update:wr(e,t.key,t.data),updateMask:Rr(t.fieldMask)};else{if(!(t instanceof Nn))return v();n={verify:dr(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e,t){const n=t.transform;if(n instanceof rn)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof sn)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof an)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof cn)return{fieldPath:t.field.canonicalString(),increment:n.yt};throw v()}(0,e)))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:ur(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:v()}(e,t.precondition)),n}function br(e,t){const n=t.currentDocument?function(e){return void 0!==e.updateTime?mn.updateTime(cr(e.updateTime)):void 0!==e.exists?mn.exists(e.exists):mn.none()}(t.currentDocument):mn.none(),r=t.updateTransforms?t.updateTransforms.map((t=>function(e,t){let n=null;if("setToServerValue"in t)I("REQUEST_TIME"===t.setToServerValue),n=new rn;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new sn(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new an(e)}else"increment"in t?n=new cn(e,t.increment):v();const r=$.fromServerFormat(t.fieldPath);return new dn(r,n)}(e,t))):[];if(t.update){t.update.name;const s=fr(e,t.update.name),i=new ut({mapValue:{fields:t.update.fields}});if(t.updateMask){const e=function(e){const t=e.fieldPaths||[];return new De(t.map((e=>$.fromServerFormat(e))))}(t.updateMask);return new En(s,i,e,n,r)}return new Tn(s,i,n,r)}if(t.delete){const r=fr(e,t.delete);return new _n(r,n)}if(t.verify){const r=fr(e,t.verify);return new Nn(r,n)}return v()}function Tr(e,t){return{documents:[mr(e,t.path)]}}function Er(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=mr(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=mr(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);const s=function(e){if(0===e.length)return;const t=e.map((e=>function(e){if("=="===e.op){if(et(e.value))return{unaryFilter:{field:Nr(e.field),op:"IS_NAN"}};if(Je(e.value))return{unaryFilter:{field:Nr(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(et(e.value))return{unaryFilter:{field:Nr(e.field),op:"IS_NOT_NAN"}};if(Je(e.value))return{unaryFilter:{field:Nr(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Nr(e.field),op:_r(e.op),value:e.value}}}(e)));return 1===t.length?t[0]:{compositeFilter:{op:"AND",filters:t}}}(t.filters);s&&(n.structuredQuery.where=s);const i=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:Nr(e.field),direction:Dr(e.dir)}}(e)))}(t.orderBy);i&&(n.structuredQuery.orderBy=i);const o=function(e,t){return e.gt||Pe(t)?t:{value:t}}(e,t.limit);var a;return null!==o&&(n.structuredQuery.limit=o),t.startAt&&(n.structuredQuery.startAt={before:(a=t.startAt).inclusive,values:a.position}),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),n}function Sr(e){let t=gr(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){I(1===r);const e=n.from[0];e.allDescendants?s=e.collectionId:t=t.child(e.collectionId)}let i=[];n.where&&(i=xr(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((e=>function(e){return new At(Ar(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e))));let a=null;n.limit&&(a=function(e){let t;return t="object"==typeof e?e.value:e,Pe(t)?null:t}(n.limit));let u=null;n.startAt&&(u=function(e){const t=!!e.before,n=e.values||[];return new Nt(n,t)}(n.startAt));let c=null;return n.endAt&&(c=function(e){const t=!e.before,n=e.values||[];return new Nt(n,t)}(n.endAt)),Lt(t,s,o,i,a,"F",u,c)}function xr(e){return e?void 0!==e.unaryFilter?[kr(e)]:void 0!==e.fieldFilter?[Cr(e)]:void 0!==e.compositeFilter?e.compositeFilter.filters.map((e=>xr(e))).reduce(((e,t)=>e.concat(t))):v():[]}function Dr(e){return rr[e]}function _r(e){return sr[e]}function Nr(e){return{fieldPath:e.canonicalString()}}function Ar(e){return $.fromServerFormat(e.fieldPath)}function Cr(e){return vt.create(Ar(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return v()}}(e.fieldFilter.op),e.fieldFilter.value)}function kr(e){switch(e.unaryFilter.op){case"IS_NAN":const t=Ar(e.unaryFilter.field);return vt.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=Ar(e.unaryFilter.field);return vt.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Ar(e.unaryFilter.field);return vt.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=Ar(e.unaryFilter.field);return vt.create(s,"!=",{nullValue:"NULL_VALUE"});default:return v()}}function Rr(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}function Vr(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}function Lr(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t=Fr(t)),t=Mr(e.get(n),t);return Fr(t)}function Mr(e,t){let n=t;const r=e.length;for(let s=0;s<r;s++){const t=e.charAt(s);switch(t){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=t}}return n}function Fr(e){return e+"\x01\x01"}function Or(e){const t=e.length;if(I(t>=2),2===t)return I("\x01"===e.charAt(0)&&"\x01"===e.charAt(1)),K.emptyPath();const n=t-2,r=[];let s="";for(let i=0;i<t;){const t=e.indexOf("\x01",i);switch((t<0||t>n)&&v(),e.charAt(t+1)){case"\x01":const n=e.substring(i,t);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"\x10":s+=e.substring(i,t),s+="\0";break;case"\x11":s+=e.substring(i,t+1);break;default:v()}i=t+2}return new K(r)}const Pr=["userId","batchId"];function qr(e,t){return[e,Lr(t)]}function Ur(e,t,n){return[e,Lr(t),n]}const Br={},Kr=["prefixPath","collectionGroup","readTime","documentId"],Gr=["prefixPath","collectionGroup","documentId"],$r=["collectionGroup","readTime","prefixPath","documentId"],Qr=["canonicalId","targetId"],zr=["targetId","path"],jr=["path","targetId"],Wr=["collectionId","parent"],Hr=["indexId","uid"],Yr=["uid","sequenceNumber"],Xr=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Zr=["indexId","uid","orderedDocumentKey"],Jr=["userId","collectionPath","documentId"],es=["userId","collectionPath","largestBatchId"],ts=["userId","collectionGroup","largestBatchId"],ns=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],rs=[...ns,"documentOverlays"],ss=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],is=ss,os=[...is,"indexConfiguration","indexState","indexEntries"];class as extends ne{constructor(e,t){super(),this.ie=e,this.currentSequenceNumber=t}}function us(e,t){const n=T(e);return oe.M(n.ie,t)}class cs{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let r=0;r<this.mutations.length;r++){const t=this.mutations[r];t.key.isEqual(e.key)&&wn(t,e,n[r])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=vn(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=vn(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=Bn();return this.mutations.forEach((r=>{const s=e.get(r.key),i=s.overlayedDocument;let o=this.applyToLocalView(i,s.mutatedFields);o=t.has(r.key)?null:o;const a=yn(i,o);null!==a&&n.set(r.key,a),i.isValidDocument()||i.convertToNoDocument(U.min())})),n}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),Qn())}isEqual(e){return this.batchId===e.batchId&&O(this.mutations,e.mutations,((e,t)=>bn(e,t)))&&O(this.baseMutations,e.baseMutations,((e,t)=>bn(e,t)))}}class ls{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){I(e.mutations.length===n.length);let r=Gn;const s=e.mutations;for(let i=0;i<s.length;i++)r=r.insert(s[i].key,n[i].version);return new ls(e,t,n,r)}}class hs{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class ds{constructor(e,t,n,r,s=U.min(),i=U.min(),o=Ne.EMPTY_BYTE_STRING){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(e){return new ds(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(e,t){return new ds(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e)}withLastLimboFreeSnapshotVersion(e){return new ds(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken)}}class fs{constructor(e){this.re=e}}function ms(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:gs(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document=function(e,t){return{name:dr(e,t.key),fields:t.data.value.mapValue.fields,updateTime:or(e,t.version.toTimestamp())}}(e.re,t);else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:ps(t.version)};else{if(!t.isUnknownDocument())return v();r.unknownDocument={path:n.path.toArray(),version:ps(t.version)}}return r}function gs(e){const t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function ps(e){const t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function ys(e){const t=new q(e.seconds,e.nanoseconds);return U.fromTimestamp(t)}function ws(e,t){const n=(t.baseMutations||[]).map((t=>br(e.re,t)));for(let i=0;i<t.mutations.length-1;++i){const e=t.mutations[i];if(i+1<t.mutations.length&&void 0!==t.mutations[i+1].transform){const n=t.mutations[i+1];e.updateTransforms=n.transform.fieldTransforms,t.mutations.splice(i+1,1),++i}}const r=t.mutations.map((t=>br(e.re,t))),s=q.fromMillis(t.localWriteTimeMs);return new cs(t.batchId,s,n,r)}function vs(e){const t=ys(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?ys(e.lastLimboFreeSnapshotVersion):U.min();let r;var s;return void 0!==e.query.documents?(I(1===(s=e.query).documents.length),r=Bt(Mt(gr(s.documents[0])))):r=function(e){return Bt(Sr(e))}(e.query),new ds(r,e.targetId,0,e.lastListenSequenceNumber,t,n,Ne.fromBase64String(e.resumeToken))}function Is(e,t){const n=ps(t.snapshotVersion),r=ps(t.lastLimboFreeSnapshotVersion);let s;s=gt(t.target)?Tr(e.re,t.target):Er(e.re,t.target);const i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:ft(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function bs(e){const t=Sr({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Kt(t,t.limit,"L"):t}function Ts(e,t){return new hs(t.largestBatchId,br(e.re,t.overlayMutation))}function Es(e,t){const n=t.path.lastSegment();return[e,Lr(t.path.popLast()),n]}function Ss(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:ps(r.readTime),documentKey:Lr(r.documentKey.path),largestBatchId:r.largestBatchId}}class xs{getBundleMetadata(e,t){return Ds(e).get(t).next((e=>{if(e)return{id:(t=e).bundleId,createTime:ys(t.createTime),version:t.version};var t}))}saveBundleMetadata(e,t){return Ds(e).put({bundleId:(n=t).id,createTime:ps(cr(n.createTime)),version:n.version});var n}getNamedQuery(e,t){return _s(e).get(t).next((e=>{if(e)return{name:(t=e).name,query:bs(t.bundledQuery),readTime:ys(t.readTime)};var t}))}saveNamedQuery(e,t){return _s(e).put(function(e){return{name:e.name,readTime:ps(cr(e.readTime)),bundledQuery:e.bundledQuery}}(t))}}function Ds(e){return us(e,"bundles")}function _s(e){return us(e,"namedQueries")}class Ns{constructor(e,t){this.It=e,this.userId=t}static oe(e,t){const n=t.uid||"";return new Ns(e,n)}getOverlay(e,t){return As(e).get(Es(this.userId,t)).next((e=>e?Ts(this.It,e):null))}getOverlays(e,t){const n=Un();return se.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){const r=[];return n.forEach(((n,s)=>{const i=new hs(t,s);r.push(this.ue(e,i))})),se.waitFor(r)}removeOverlaysForBatchId(e,t,n){const r=new Set;t.forEach((e=>r.add(Lr(e.getCollectionPath()))));const s=[];return r.forEach((t=>{const r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);s.push(As(e).Y("collectionPathOverlayIndex",r))})),se.waitFor(s)}getOverlaysForCollection(e,t,n){const r=Un(),s=Lr(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return As(e).W("collectionPathOverlayIndex",i).next((e=>{for(const t of e){const e=Ts(this.It,t);r.set(e.getKey(),e)}return r}))}getOverlaysForCollectionGroup(e,t,n,r){const s=Un();let i;const o=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return As(e).Z({index:"collectionGroupOverlayIndex",range:o},((e,t,n)=>{const o=Ts(this.It,t);s.size()<r||o.largestBatchId===i?(s.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>s))}ue(e,t){return As(e).put(function(e,t,n){const[r,s,i]=Es(t,n.mutation.key);return{userId:t,collectionPath:s,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Ir(e.re,n.mutation)}}(this.It,this.userId,t))}}function As(e){return us(e,"documentOverlays")}class Cs{constructor(){}ce(e,t){this.ae(e,t),t.he()}ae(e,t){if("nullValue"in e)this.le(t,5);else if("booleanValue"in e)this.le(t,10),t.fe(e.booleanValue?1:0);else if("integerValue"in e)this.le(t,15),t.fe(ke(e.integerValue));else if("doubleValue"in e){const n=ke(e.doubleValue);isNaN(n)?this.le(t,13):(this.le(t,15),qe(n)?t.fe(0):t.fe(n))}else if("timestampValue"in e){const n=e.timestampValue;this.le(t,20),"string"==typeof n?t.de(n):(t.de(`${n.seconds||""}`),t.fe(n.nanos||0))}else if("stringValue"in e)this._e(e.stringValue,t),this.we(t);else if("bytesValue"in e)this.le(t,30),t.me(Re(e.bytesValue)),this.we(t);else if("referenceValue"in e)this.ge(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.le(t,45),t.fe(n.latitude||0),t.fe(n.longitude||0)}else"mapValue"in e?rt(e)?this.le(t,Number.MAX_SAFE_INTEGER):(this.ye(e.mapValue,t),this.we(t)):"arrayValue"in e?(this.pe(e.arrayValue,t),this.we(t)):v()}_e(e,t){this.le(t,25),this.Ie(e,t)}Ie(e,t){t.de(e)}ye(e,t){const n=e.fields||{};this.le(t,55);for(const r of Object.keys(n))this._e(r,t),this.ae(n[r],t)}pe(e,t){const n=e.values||[];this.le(t,50);for(const r of n)this.ae(r,t)}ge(e,t){this.le(t,37),Q.fromName(e).path.forEach((e=>{this.le(t,60),this.Ie(e,t)}))}le(e,t){e.fe(t)}we(e){e.fe(2)}}function ks(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}function Rs(e){const t=64-function(e){let t=0;for(let n=0;n<8;++n){const r=ks(255&e[n]);if(t+=r,8!==r)break}return t}(e);return Math.ceil(t/8)}Cs.Te=new Cs;class Vs{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ee(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ae(n.value),n=t.next();this.Re()}be(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Pe(n.value),n=t.next();this.ve()}Ve(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ae(e);else if(e<2048)this.Ae(960|e>>>6),this.Ae(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ae(480|e>>>12),this.Ae(128|63&e>>>6),this.Ae(128|63&e);else{const e=t.codePointAt(0);this.Ae(240|e>>>18),this.Ae(128|63&e>>>12),this.Ae(128|63&e>>>6),this.Ae(128|63&e)}}this.Re()}Se(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Pe(e);else if(e<2048)this.Pe(960|e>>>6),this.Pe(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Pe(480|e>>>12),this.Pe(128|63&e>>>6),this.Pe(128|63&e);else{const e=t.codePointAt(0);this.Pe(240|e>>>18),this.Pe(128|63&e>>>12),this.Pe(128|63&e>>>6),this.Pe(128|63&e)}}this.ve()}De(e){const t=this.Ce(e),n=Rs(t);this.xe(1+n),this.buffer[this.position++]=255&n;for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=255&t[r]}Ne(e){const t=this.Ce(e),n=Rs(t);this.xe(1+n),this.buffer[this.position++]=~(255&n);for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=~(255&t[r])}ke(){this.Oe(255),this.Oe(255)}Me(){this.Fe(255),this.Fe(255)}reset(){this.position=0}seed(e){this.xe(e.length),this.buffer.set(e,this.position),this.position+=e.length}$e(){return this.buffer.slice(0,this.position)}Ce(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let r=1;r<t.length;++r)t[r]^=n?255:0;return t}Ae(e){const t=255&e;0===t?(this.Oe(0),this.Oe(255)):255===t?(this.Oe(255),this.Oe(0)):this.Oe(t)}Pe(e){const t=255&e;0===t?(this.Fe(0),this.Fe(255)):255===t?(this.Fe(255),this.Fe(0)):this.Fe(e)}Re(){this.Oe(0),this.Oe(1)}ve(){this.Fe(0),this.Fe(1)}Oe(e){this.xe(1),this.buffer[this.position++]=e}Fe(e){this.xe(1),this.buffer[this.position++]=~e}xe(e){const t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);const r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class Ls{constructor(e){this.Be=e}me(e){this.Be.Ee(e)}de(e){this.Be.Ve(e)}fe(e){this.Be.De(e)}he(){this.Be.ke()}}class Ms{constructor(e){this.Be=e}me(e){this.Be.be(e)}de(e){this.Be.Se(e)}fe(e){this.Be.Ne(e)}he(){this.Be.Me()}}class Fs{constructor(){this.Be=new Vs,this.Le=new Ls(this.Be),this.Ue=new Ms(this.Be)}seed(e){this.Be.seed(e)}qe(e){return 0===e?this.Le:this.Ue}$e(){return this.Be.$e()}reset(){this.Be.reset()}}class Os{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Ke(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new Os(this.indexId,this.documentKey,this.arrayValue,n)}}function Ps(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=qs(e.arrayValue,t.arrayValue),0!==n?n:(n=qs(e.directionalValue,t.directionalValue),0!==n?n:Q.comparator(e.documentKey,t.documentKey)))}function qs(e,t){for(let n=0;n<e.length&&n<t.length;++n){const r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}class Us{constructor(e){this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Ge=e.orderBy,this.Qe=[];for(const t of e.filters){const e=t;e.dt()?this.je=e:this.Qe.push(e)}}We(e){const t=j(e);if(void 0!==t&&!this.ze(t))return!1;const n=W(e);let r=0,s=0;for(;r<n.length&&this.ze(n[r]);++r);if(r===n.length)return!0;if(void 0!==this.je){const e=n[r];if(!this.He(this.je,e)||!this.Je(this.Ge[s++],e))return!1;++r}for(;r<n.length;++r){const e=n[r];if(s>=this.Ge.length||!this.Je(this.Ge[s++],e))return!1}return!0}ze(e){for(const t of this.Qe)if(this.He(t,e))return!0;return!1}He(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;const n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}Je(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}class Bs{constructor(){this.Ye=new Ks}addToCollectionParentIndex(e,t){return this.Ye.add(t),se.resolve()}getCollectionParents(e,t){return se.resolve(this.Ye.getEntries(t))}addFieldIndex(e,t){return se.resolve()}deleteFieldIndex(e,t){return se.resolve()}getDocumentsMatchingTarget(e,t){return se.resolve(null)}getIndexType(e,t){return se.resolve(0)}getFieldIndexes(e,t){return se.resolve([])}getNextCollectionGroupToUpdate(e){return se.resolve(null)}getMinOffset(e,t){return se.resolve(J.min())}getMinOffsetFromCollectionGroup(e,t){return se.resolve(J.min())}updateCollectionGroup(e,t,n){return se.resolve()}updateIndexEntries(e,t){return se.resolve()}}class Ks{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new Ee(K.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new Ee(K.comparator)).toArray()}}const Gs=new Uint8Array(0);class $s{constructor(e,t){this.user=e,this.databaseId=t,this.Xe=new Ks,this.Ze=new Ln((e=>ft(e)),((e,t)=>mt(e,t))),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.Xe.has(t)){const n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener((()=>{this.Xe.add(t)}));const s={collectionId:n,parent:Lr(r)};return Qs(e).put(s)}return se.resolve()}getCollectionParents(e,t){const n=[],r=IDBKeyRange.bound([t,""],[P(t),""],!1,!0);return Qs(e).W(r).next((e=>{for(const r of e){if(r.collectionId!==t)break;n.push(Or(r.parent))}return n}))}addFieldIndex(e,t){const n=js(e),r=function(e){return{indexId:e.indexId,collectionGroup:e.collectionGroup,fields:e.fields.map((e=>[e.fieldPath.canonicalString(),e.kind]))}}(t);delete r.indexId;const s=n.add(r);if(t.indexState){const n=Ws(e);return s.next((e=>{n.put(Ss(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))}))}return s.next()}deleteFieldIndex(e,t){const n=js(e),r=Ws(e),s=zs(e);return n.delete(t.indexId).next((()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))).next((()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))))}getDocumentsMatchingTarget(e,t){const n=zs(e);let r=!0;const s=new Map;return se.forEach(this.tn(t),(t=>this.en(e,t).next((e=>{r&&(r=!!e),s.set(t,e)})))).next((()=>{if(r){let e=Qn();const r=[];return se.forEach(s,((s,i)=>{var o;g("IndexedDbIndexManager",`Using index ${o=s,`id=${o.indexId}|cg=${o.collectionGroup}|f=${o.fields.map((e=>`${e.fieldPath}:${e.kind}`)).join(",")}`} to execute ${ft(t)}`);const a=function(e,t){const n=j(t);if(void 0===n)return null;for(const r of pt(e,n.fieldPath))switch(r.op){case"array-contains-any":return r.value.arrayValue.values||[];case"array-contains":return[r.value]}return null}(i,s),u=function(e,t){const n=new Map;for(const r of W(t))for(const t of pt(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(i,s),c=function(e,t){const n=[];let r=!0;for(const s of W(t)){const t=0===s.kind?yt(e,s.fieldPath,e.startAt):wt(e,s.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new Nt(n,r)}(i,s),l=function(e,t){const n=[];let r=!0;for(const s of W(t)){const t=0===s.kind?wt(e,s.fieldPath,e.endAt):yt(e,s.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new Nt(n,r)}(i,s),h=this.nn(s,i,c),d=this.nn(s,i,l),f=this.sn(s,i,u),m=this.rn(s.indexId,a,h,c.inclusive,d,l.inclusive,f);return se.forEach(m,(s=>n.J(s,t.limit).next((t=>{t.forEach((t=>{const n=Q.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))}))}))))})).next((()=>r))}return se.resolve(null)}))}tn(e){let t=this.Ze.get(e);return t||(t=[e],this.Ze.set(e,t),t)}rn(e,t,n,r,s,i,o){const a=(null!=t?t.length:1)*Math.max(n.length,s.length),u=a/(null!=t?t.length:1),c=[];for(let l=0;l<a;++l){const a=t?this.on(t[l/u]):Gs,h=this.un(e,a,n[l%u],r),d=this.cn(e,a,s[l%u],i),f=o.map((t=>this.un(e,a,t,!0)));c.push(...this.createRange(h,d,f))}return c}un(e,t,n,r){const s=new Os(e,Q.empty(),t,n);return r?s:s.Ke()}cn(e,t,n,r){const s=new Os(e,Q.empty(),t,n);return r?s.Ke():s}en(e,t){const n=new Us(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next((e=>{let t=null;for(const r of e)n.We(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t}))}getIndexType(e,t){let n=2;return se.forEach(this.tn(t),(t=>this.en(e,t).next((e=>{e?0!==n&&e.fields.length<function(e){let t=new Ee($.comparator),n=!1;for(const r of e.filters){const e=r;e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field))}for(const r of e.orderBy)r.field.isKeyField()||(t=t.add(r.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})))).next((()=>n))}an(e,t){const n=new Fs;for(const r of W(e)){const e=t.data.field(r.fieldPath);if(null==e)return null;const s=n.qe(r.kind);Cs.Te.ce(e,s)}return n.$e()}on(e){const t=new Fs;return Cs.Te.ce(e,t.qe(0)),t.$e()}hn(e,t){const n=new Fs;return Cs.Te.ce(Ye(this.databaseId,t),n.qe(function(e){const t=W(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.$e()}sn(e,t,n){if(null===n)return[];let r=[];r.push(new Fs);let s=0;for(const i of W(e)){const e=n[s++];for(const n of r)if(this.ln(t,i.fieldPath)&&Ze(e))r=this.fn(r,i,e);else{const t=n.qe(i.kind);Cs.Te.ce(e,t)}}return this.dn(r)}nn(e,t,n){return this.sn(e,t,n.position)}dn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].$e();return t}fn(e,t,n){const r=[...e],s=[];for(const i of n.arrayValue.values||[])for(const e of r){const n=new Fs;n.seed(e.$e()),Cs.Te.ce(i,n.qe(t.kind)),s.push(n)}return s}ln(e,t){return!!e.filters.find((e=>e instanceof vt&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op)))}getFieldIndexes(e,t){const n=js(e),r=Ws(e);return(t?n.W("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.W()).next((e=>{const t=[];return se.forEach(e,(e=>r.get([e.indexId,this.uid]).next((n=>{t.push(function(e,t){const n=t?new Y(t.sequenceNumber,new J(ys(t.readTime),new Q(Or(t.documentKey)),t.largestBatchId)):Y.empty(),r=e.fields.map((([e,t])=>new H($.fromServerFormat(e),t)));return new z(e.indexId,e.collectionGroup,r,n)}(e,n))})))).next((()=>t))}))}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next((e=>0===e.length?null:(e.sort(((e,t)=>{const n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:F(e.collectionGroup,t.collectionGroup)})),e[0].collectionGroup)))}updateCollectionGroup(e,t,n){const r=js(e),s=Ws(e);return this._n(e).next((e=>r.W("collectionGroupIndex",IDBKeyRange.bound(t,t)).next((t=>se.forEach(t,(t=>s.put(Ss(t.indexId,this.user,e,n))))))))}updateIndexEntries(e,t){const n=new Map;return se.forEach(t,((t,r)=>{const s=n.get(t.collectionGroup);return(s?se.resolve(s):this.getFieldIndexes(e,t.collectionGroup)).next((s=>(n.set(t.collectionGroup,s),se.forEach(s,(n=>this.wn(e,t,n).next((t=>{const s=this.mn(r,n);return t.isEqual(s)?se.resolve():this.gn(e,r,n,t,s)})))))))}))}yn(e,t,n,r){return zs(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.hn(n,t.key),documentKey:t.key.path.toArray()})}pn(e,t,n,r){return zs(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.hn(n,t.key),t.key.path.toArray()])}wn(e,t,n){const r=zs(e);let s=new Ee(Ps);return r.Z({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.hn(n,t)])},((e,r)=>{s=s.add(new Os(n.indexId,t,r.arrayValue,r.directionalValue))})).next((()=>s))}mn(e,t){let n=new Ee(Ps);const r=this.an(t,e);if(null==r)return n;const s=j(t);if(null!=s){const i=e.data.field(s.fieldPath);if(Ze(i))for(const s of i.arrayValue.values||[])n=n.add(new Os(t.indexId,e.key,this.on(s),r))}else n=n.add(new Os(t.indexId,e.key,Gs,r));return n}gn(e,t,n,r,s){g("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);const i=[];return function(e,t,n,r,s){const i=e.getIterator(),o=t.getIterator();let a=xe(i),u=xe(o);for(;a||u;){let e=!1,t=!1;if(a&&u){const r=n(a,u);r<0?t=!0:r>0&&(e=!0)}else null!=a?t=!0:e=!0;e?(r(u),u=xe(o)):t?(s(a),a=xe(i)):(a=xe(i),u=xe(o))}}(r,s,Ps,(r=>{i.push(this.yn(e,t,n,r))}),(r=>{i.push(this.pn(e,t,n,r))})),se.waitFor(i)}_n(e){let t=1;return Ws(e).Z({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((e,n,r)=>{r.done(),t=n.sequenceNumber+1})).next((()=>t))}createRange(e,t,n){n=n.sort(((e,t)=>Ps(e,t))).filter(((e,t,n)=>!t||0!==Ps(e,n[t-1])));const r=[];r.push(e);for(const i of n){const n=Ps(i,e),s=Ps(i,t);if(0===n)r[0]=e.Ke();else if(n>0&&s<0)r.push(i),r.push(i.Ke());else if(s>0)break}r.push(t);const s=[];for(let i=0;i<r.length;i+=2)s.push(IDBKeyRange.bound([r[i].indexId,this.uid,r[i].arrayValue,r[i].directionalValue,Gs,[]],[r[i+1].indexId,this.uid,r[i+1].arrayValue,r[i+1].directionalValue,Gs,[]]));return s}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(Hs)}getMinOffset(e,t){return se.mapArray(this.tn(t),(t=>this.en(e,t).next((e=>e||v())))).next(Hs)}}function Qs(e){return us(e,"collectionParents")}function zs(e){return us(e,"indexEntries")}function js(e){return us(e,"indexConfiguration")}function Ws(e){return us(e,"indexState")}function Hs(e){I(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){const s=e[r].indexState.offset;ee(s,t)<0&&(t=s),n<s.largestBatchId&&(n=s.largestBatchId)}return new J(t.readTime,t.documentKey,n)}const Ys={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Xs{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new Xs(e,Xs.DEFAULT_COLLECTION_PERCENTILE,Xs.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Zs(e,t,n){const r=e.store("mutations"),s=e.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const u=r.Z({range:o},((e,t,n)=>(a++,n.delete())));i.push(u.next((()=>{I(1===a)})));const c=[];for(const l of n.mutations){const e=Ur(t,l.key.path,n.batchId);i.push(s.delete(e)),c.push(l.key)}return se.waitFor(i).next((()=>c))}function Js(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw v();t=e.noDocument}return JSON.stringify(t).length}Xs.DEFAULT_COLLECTION_PERCENTILE=10,Xs.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Xs.DEFAULT=new Xs(41943040,Xs.DEFAULT_COLLECTION_PERCENTILE,Xs.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Xs.DISABLED=new Xs(-1,0,0);class ei{constructor(e,t,n,r){this.userId=e,this.It=t,this.indexManager=n,this.referenceDelegate=r,this.In={}}static oe(e,t,n,r){I(""!==e.uid);const s=e.isAuthenticated()?e.uid:"";return new ei(s,t,n,r)}checkEmpty(e){let t=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return ni(e).Z({index:"userMutationsIndex",range:n},((e,n,r)=>{t=!1,r.done()})).next((()=>t))}addMutationBatch(e,t,n,r){const s=ri(e),i=ni(e);return i.add({}).next((o=>{I("number"==typeof o);const a=new cs(o,t,n,r),u=function(e,t,n){const r=n.baseMutations.map((t=>Ir(e.re,t))),s=n.mutations.map((t=>Ir(e.re,t)));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:s}}(this.It,this.userId,a),c=[];let l=new Ee(((e,t)=>F(e.canonicalString(),t.canonicalString())));for(const e of r){const t=Ur(this.userId,e.key.path,o);l=l.add(e.key.path.popLast()),c.push(i.put(u)),c.push(s.put(t,Br))}return l.forEach((t=>{c.push(this.indexManager.addToCollectionParentIndex(e,t))})),e.addOnCommittedListener((()=>{this.In[o]=a.keys()})),se.waitFor(c).next((()=>a))}))}lookupMutationBatch(e,t){return ni(e).get(t).next((e=>e?(I(e.userId===this.userId),ws(this.It,e)):null))}Tn(e,t){return this.In[t]?se.resolve(this.In[t]):this.lookupMutationBatch(e,t).next((e=>{if(e){const n=e.keys();return this.In[t]=n,n}return null}))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return ni(e).Z({index:"userMutationsIndex",range:r},((e,t,r)=>{t.userId===this.userId&&(I(t.batchId>=n),s=ws(this.It,t)),r.done()})).next((()=>s))}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return ni(e).Z({index:"userMutationsIndex",range:t,reverse:!0},((e,t,r)=>{n=t.batchId,r.done()})).next((()=>n))}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return ni(e).W("userMutationsIndex",t).next((e=>e.map((e=>ws(this.It,e)))))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=qr(this.userId,t.path),r=IDBKeyRange.lowerBound(n),s=[];return ri(e).Z({range:r},((n,r,i)=>{const[o,a,u]=n,c=Or(a);if(o===this.userId&&t.path.isEqual(c))return ni(e).get(u).next((e=>{if(!e)throw v();I(e.userId===this.userId),s.push(ws(this.It,e))}));i.done()})).next((()=>s))}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new Ee(F);const r=[];return t.forEach((t=>{const s=qr(this.userId,t.path),i=IDBKeyRange.lowerBound(s),o=ri(e).Z({range:i},((e,r,s)=>{const[i,o,a]=e,u=Or(o);i===this.userId&&t.path.isEqual(u)?n=n.add(a):s.done()}));r.push(o)})),se.waitFor(r).next((()=>this.En(e,n)))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1,s=qr(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new Ee(F);return ri(e).Z({range:i},((e,t,s)=>{const[i,a,u]=e,c=Or(a);i===this.userId&&n.isPrefixOf(c)?c.length===r&&(o=o.add(u)):s.done()})).next((()=>this.En(e,o)))}En(e,t){const n=[],r=[];return t.forEach((t=>{r.push(ni(e).get(t).next((e=>{if(null===e)throw v();I(e.userId===this.userId),n.push(ws(this.It,e))})))})),se.waitFor(r).next((()=>n))}removeMutationBatch(e,t){return Zs(e.ie,this.userId,t).next((n=>(e.addOnCommittedListener((()=>{this.An(t.batchId)})),se.forEach(n,(t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))))}An(e){delete this.In[e]}performConsistencyCheck(e){return this.checkEmpty(e).next((t=>{if(!t)return se.resolve();const n=IDBKeyRange.lowerBound([this.userId]),r=[];return ri(e).Z({range:n},((e,t,n)=>{if(e[0]===this.userId){const t=Or(e[1]);r.push(t)}else n.done()})).next((()=>{I(0===r.length)}))}))}containsKey(e,t){return ti(e,this.userId,t)}Rn(e){return si(e).get(this.userId).next((e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function ti(e,t,n){const r=qr(t,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return ri(e).Z({range:i,X:!0},((e,n,r)=>{const[i,a,u]=e;i===t&&a===s&&(o=!0),r.done()})).next((()=>o))}function ni(e){return us(e,"mutations")}function ri(e){return us(e,"documentMutations")}function si(e){return us(e,"mutationQueues")}class ii{constructor(e){this.bn=e}next(){return this.bn+=2,this.bn}static Pn(){return new ii(0)}static vn(){return new ii(-1)}}class oi{constructor(e,t){this.referenceDelegate=e,this.It=t}allocateTargetId(e){return this.Vn(e).next((t=>{const n=new ii(t.highestTargetId);return t.highestTargetId=n.next(),this.Sn(e,t).next((()=>t.highestTargetId))}))}getLastRemoteSnapshotVersion(e){return this.Vn(e).next((e=>U.fromTimestamp(new q(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(e){return this.Vn(e).next((e=>e.highestListenSequenceNumber))}setTargetsMetadata(e,t,n){return this.Vn(e).next((r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.Sn(e,r))))}addTargetData(e,t){return this.Dn(e,t).next((()=>this.Vn(e).next((n=>(n.targetCount+=1,this.Cn(t,n),this.Sn(e,n))))))}updateTargetData(e,t){return this.Dn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next((()=>ai(e).delete(t.targetId))).next((()=>this.Vn(e))).next((t=>(I(t.targetCount>0),t.targetCount-=1,this.Sn(e,t))))}removeTargets(e,t,n){let r=0;const s=[];return ai(e).Z(((i,o)=>{const a=vs(o);a.sequenceNumber<=t&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(e,a)))})).next((()=>se.waitFor(s))).next((()=>r))}forEachTarget(e,t){return ai(e).Z(((e,n)=>{const r=vs(n);t(r)}))}Vn(e){return ui(e).get("targetGlobalKey").next((e=>(I(null!==e),e)))}Sn(e,t){return ui(e).put("targetGlobalKey",t)}Dn(e,t){return ai(e).put(Is(this.It,t))}Cn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Vn(e).next((e=>e.targetCount))}getTargetData(e,t){const n=ft(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return ai(e).Z({range:r,index:"queryTargetsIndex"},((e,n,r)=>{const i=vs(n);mt(t,i.target)&&(s=i,r.done())})).next((()=>s))}addMatchingKeys(e,t,n){const r=[],s=ci(e);return t.forEach((t=>{const i=Lr(t.path);r.push(s.put({targetId:n,path:i})),r.push(this.referenceDelegate.addReference(e,n,t))})),se.waitFor(r)}removeMatchingKeys(e,t,n){const r=ci(e);return se.forEach(t,(t=>{const s=Lr(t.path);return se.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(e,n,t)])}))}removeMatchingKeysForTargetId(e,t){const n=ci(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=ci(e);let s=Qn();return r.Z({range:n,X:!0},((e,t,n)=>{const r=Or(e[1]),i=new Q(r);s=s.add(i)})).next((()=>s))}containsKey(e,t){const n=Lr(t.path),r=IDBKeyRange.bound([n],[P(n)],!1,!0);let s=0;return ci(e).Z({index:"documentTargetsIndex",X:!0,range:r},(([e,t],n,r)=>{0!==e&&(s++,r.done())})).next((()=>s>0))}se(e,t){return ai(e).get(t).next((e=>e?vs(e):null))}}function ai(e){return us(e,"targets")}function ui(e){return us(e,"targetGlobal")}function ci(e){return us(e,"targetDocuments")}function li([e,t],[n,r]){const s=F(e,n);return 0===s?F(t,r):s}class hi{constructor(e){this.xn=e,this.buffer=new Ee(li),this.Nn=0}kn(){return++this.Nn}On(e){const t=[e,this.kn()];if(this.buffer.size<this.xn)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();li(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class di{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Mn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Fn(6e4)}stop(){this.Mn&&(this.Mn.cancel(),this.Mn=null)}get started(){return null!==this.Mn}Fn(e){g("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Mn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(async()=>{this.Mn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){ce(e)?g("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await re(e)}await this.Fn(3e5)}))}}class fi{constructor(e,t){this.$n=e,this.params=t}calculateTargetCount(e,t){return this.$n.Bn(e).next((e=>Math.floor(t/100*e)))}nthSequenceNumber(e,t){if(0===t)return se.resolve(pe.at);const n=new hi(t);return this.$n.forEachTarget(e,(e=>n.On(e.sequenceNumber))).next((()=>this.$n.Ln(e,(e=>n.On(e))))).next((()=>n.maxValue))}removeTargets(e,t,n){return this.$n.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.$n.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(g("LruGarbageCollector","Garbage collection skipped; disabled"),se.resolve(Ys)):this.getCacheSize(e).next((n=>n<this.params.cacheSizeCollectionThreshold?(g("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Ys):this.Un(e,t)))}getCacheSize(e){return this.$n.getCacheSize(e)}Un(e,t){let n,r,s,o,a,u,c;const l=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next((t=>(t>this.params.maximumSequenceNumbersToCollect?(g("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,o=Date.now(),this.nthSequenceNumber(e,r)))).next((r=>(n=r,a=Date.now(),this.removeTargets(e,n,t)))).next((t=>(s=t,u=Date.now(),this.removeOrphanedDocuments(e,n)))).next((e=>(c=Date.now(),f()<=i.in.DEBUG&&g("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-l}ms\n\tDetermined least recently used ${r} in `+(a-o)+"ms\n"+`\tRemoved ${s} targets in `+(u-a)+"ms\n"+`\tRemoved ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-l}ms`),se.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:e}))))}}class mi{constructor(e,t){this.db=e,this.garbageCollector=function(e,t){return new fi(e,t)}(this,t)}Bn(e){const t=this.qn(e);return this.db.getTargetCache().getTargetCount(e).next((e=>t.next((t=>e+t))))}qn(e){let t=0;return this.Ln(e,(e=>{t++})).next((()=>t))}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Ln(e,t){return this.Kn(e,((e,n)=>t(n)))}addReference(e,t,n){return gi(e,n)}removeReference(e,t,n){return gi(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return gi(e,t)}Gn(e,t){return function(e,t){let n=!1;return si(e).tt((r=>ti(e,r,t).next((e=>(e&&(n=!0),se.resolve(!e)))))).next((()=>n))}(e,t)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.Kn(e,((i,o)=>{if(o<=t){const t=this.Gn(e,i).next((t=>{if(!t)return s++,n.getEntry(e,i).next((()=>(n.removeEntry(i,U.min()),ci(e).delete([0,Lr(i.path)]))))}));r.push(t)}})).next((()=>se.waitFor(r))).next((()=>n.apply(e))).next((()=>s))}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return gi(e,t)}Kn(e,t){const n=ci(e);let r,s=pe.at;return n.Z({index:"documentTargetsIndex"},(([e,n],{path:i,sequenceNumber:o})=>{0===e?(s!==pe.at&&t(new Q(Or(r)),s),s=o,r=i):s=pe.at})).next((()=>{s!==pe.at&&t(new Q(Or(r)),s)}))}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function gi(e,t){return ci(e).put(function(e,t){return{targetId:0,path:Lr(e.path),sequenceNumber:t}}(t,e.currentSequenceNumber))}class pi{constructor(){this.changes=new Ln((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,lt.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?se.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class yi{constructor(e){this.It=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return bi(e).put(n)}removeEntry(e,t,n){return bi(e).delete(function(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],gs(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next((n=>(n.byteSize+=t,this.Qn(e,n))))}getEntry(e,t){let n=lt.newInvalidDocument(t);return bi(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(Ti(t))},((e,r)=>{n=this.jn(t,r)})).next((()=>n))}Wn(e,t){let n={size:0,document:lt.newInvalidDocument(t)};return bi(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(Ti(t))},((e,r)=>{n={document:this.jn(t,r),size:Js(r)}})).next((()=>n))}getEntries(e,t){let n=Fn();return this.zn(e,t,((e,t)=>{const r=this.jn(e,t);n=n.insert(e,r)})).next((()=>n))}Hn(e,t){let n=Fn(),r=new Ie(Q.comparator);return this.zn(e,t,((e,t)=>{const s=this.jn(e,t);n=n.insert(e,s),r=r.insert(e,Js(t))})).next((()=>({documents:n,Jn:r})))}zn(e,t,n){if(t.isEmpty())return se.resolve();let r=new Ee(Si);t.forEach((e=>r=r.add(e)));const s=IDBKeyRange.bound(Ti(r.first()),Ti(r.last())),i=r.getIterator();let o=i.getNext();return bi(e).Z({index:"documentKeyIndex",range:s},((e,t,r)=>{const s=Q.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;o&&Si(o,s)<0;)n(o,null),o=i.getNext();o&&o.isEqual(s)&&(n(o,t),o=i.hasNext()?i.getNext():null),o?r.j(Ti(o)):r.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getAllFromCollection(e,t,n){const r=[t.popLast().toArray(),t.lastSegment(),gs(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],s=[t.popLast().toArray(),t.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return bi(e).W(IDBKeyRange.bound(r,s,!0)).next((e=>{let t=Fn();for(const n of e){const e=this.jn(Q.fromSegments(n.prefixPath.concat(n.collectionGroup,n.documentId)),n);t=t.insert(e.key,e)}return t}))}getAllFromCollectionGroup(e,t,n,r){let s=Fn();const i=Ei(t,n),o=Ei(t,J.max());return bi(e).Z({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},((e,t,n)=>{const i=this.jn(Q.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);s=s.insert(i.key,i),s.size===r&&n.done()})).next((()=>s))}newChangeBuffer(e){return new vi(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next((e=>e.byteSize))}getMetadata(e){return Ii(e).get("remoteDocumentGlobalKey").next((e=>(I(!!e),e)))}Qn(e,t){return Ii(e).put("remoteDocumentGlobalKey",t)}jn(e,t){if(t){const e=function(e,t){let n;if(t.document)n=vr(e.re,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=Q.fromSegments(t.noDocument.path),r=ys(t.noDocument.readTime);n=lt.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return v();{const e=Q.fromSegments(t.unknownDocument.path),r=ys(t.unknownDocument.version);n=lt.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function(e){const t=new q(e[0],e[1]);return U.fromTimestamp(t)}(t.readTime)),n}(this.It,t);if(!e.isNoDocument()||!e.version.isEqual(U.min()))return e}return lt.newInvalidDocument(e)}}function wi(e){return new yi(e)}class vi extends pi{constructor(e,t){super(),this.Yn=e,this.trackRemovals=t,this.Xn=new Ln((e=>e.toString()),((e,t)=>e.isEqual(t)))}applyChanges(e){const t=[];let n=0,r=new Ee(((e,t)=>F(e.canonicalString(),t.canonicalString())));return this.changes.forEach(((s,i)=>{const o=this.Xn.get(s);if(t.push(this.Yn.removeEntry(e,s,o.readTime)),i.isValidDocument()){const a=ms(this.Yn.It,i);r=r.add(s.path.popLast());const u=Js(a);n+=u-o.size,t.push(this.Yn.addEntry(e,s,a))}else if(n-=o.size,this.trackRemovals){const n=ms(this.Yn.It,i.convertToNoDocument(U.min()));t.push(this.Yn.addEntry(e,s,n))}})),r.forEach((n=>{t.push(this.Yn.indexManager.addToCollectionParentIndex(e,n))})),t.push(this.Yn.updateMetadata(e,n)),se.waitFor(t)}getFromCache(e,t){return this.Yn.Wn(e,t).next((e=>(this.Xn.set(t,{size:e.size,readTime:e.document.readTime}),e.document)))}getAllFromCache(e,t){return this.Yn.Hn(e,t).next((({documents:e,Jn:t})=>(t.forEach(((t,n)=>{this.Xn.set(t,{size:n,readTime:e.get(t).readTime})})),e)))}}function Ii(e){return us(e,"remoteDocumentGlobal")}function bi(e){return us(e,"remoteDocumentsV14")}function Ti(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function Ei(e,t){const n=t.documentKey.path.toArray();return[e,gs(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function Si(e,t){const n=e.path.toArray(),r=t.path.toArray();let s=0;for(let i=0;i<n.length-2&&i<r.length-2;++i)if(s=F(n[i],r[i]),s)return s;return s=F(n.length,r.length),s||(s=F(n[n.length-2],r[r.length-2]),s||F(n[n.length-1],r[r.length-1]))}class xi{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class Di{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next((r=>(n=r,this.getBaseDocument(e,t,n)))).next((e=>(null!==n&&vn(n.mutation,e,De.empty(),q.now()),e)))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.getLocalViewOfDocuments(e,t,Qn()).next((()=>t))))}getLocalViewOfDocuments(e,t,n=Qn()){const r=Un();return this.populateOverlays(e,r,t).next((()=>this.computeViews(e,t,r,n).next((e=>{let t=Pn();return e.forEach(((e,n)=>{t=t.insert(e,n.overlayedDocument)})),t}))))}getOverlayedDocuments(e,t){const n=Un();return this.populateOverlays(e,n,t).next((()=>this.computeViews(e,t,n,Qn())))}populateOverlays(e,t,n){const r=[];return n.forEach((e=>{t.has(e)||r.push(e)})),this.documentOverlayCache.getOverlays(e,r).next((e=>{e.forEach(((e,n)=>{t.set(e,n)}))}))}computeViews(e,t,n,r){let s=Fn();const i=Kn(),o=Kn();return t.forEach(((e,t)=>{const o=n.get(t.key);r.has(t.key)&&(void 0===o||o.mutation instanceof En)?s=s.insert(t.key,t):void 0!==o&&(i.set(t.key,o.mutation.getFieldMask()),vn(o.mutation,t,o.mutation.getFieldMask(),q.now()))})),this.recalculateAndSaveOverlays(e,s).next((e=>(e.forEach(((e,t)=>i.set(e,t))),t.forEach(((e,t)=>{var n;return o.set(e,new xi(t,null!==(n=i.get(e))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(e,t){const n=Kn();let r=new Ie(((e,t)=>e-t)),s=Qn();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>{for(const s of e)s.keys().forEach((e=>{const i=t.get(e);if(null===i)return;let o=n.get(e)||De.empty();o=s.applyToLocalView(i,o),n.set(e,o);const a=(r.get(s.batchId)||Qn()).add(e);r=r.insert(s.batchId,a)}))})).next((()=>{const i=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),a=r.key,u=r.value,c=Bn();u.forEach((e=>{if(!s.has(e)){const r=yn(t.get(e),n.get(e));null!==r&&c.set(e,r),s=s.add(e)}})),i.push(this.documentOverlayCache.saveOverlays(e,a,c))}return se.waitFor(i)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.recalculateAndSaveOverlays(e,t)))}getDocumentsMatchingQuery(e,t,n){return function(e){return Q.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):qt(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next((s=>{const i=r-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-s.size):se.resolve(Un());let o=-1,a=s;return i.next((t=>se.forEach(t,((t,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),s.get(t)?se.resolve():this.getBaseDocument(e,t,n).next((e=>{a=a.insert(t,e)}))))).next((()=>this.populateOverlays(e,t,s))).next((()=>this.computeViews(e,a,t,Qn()))).next((e=>({batchId:o,changes:qn(e)})))))}))}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new Q(t)).next((e=>{let t=Pn();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}getDocumentsMatchingCollectionGroupQuery(e,t,n){const r=t.collectionGroup;let s=Pn();return this.indexManager.getCollectionParents(e,r).next((i=>se.forEach(i,(i=>{const o=function(e,t){return new Vt(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,i.child(r));return this.getDocumentsMatchingCollectionQuery(e,o,n).next((e=>{e.forEach(((e,t)=>{s=s.insert(e,t)}))}))})).next((()=>s))))}getDocumentsMatchingCollectionQuery(e,t,n){let r;return this.remoteDocumentCache.getAllFromCollection(e,t.path,n).next((s=>(r=s,this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId)))).next((e=>{e.forEach(((e,t)=>{const n=t.getKey();null===r.get(n)&&(r=r.insert(n,lt.newInvalidDocument(n)))}));let n=Pn();return r.forEach(((r,s)=>{const i=e.get(r);void 0!==i&&vn(i.mutation,s,De.empty(),q.now()),zt(t,s)&&(n=n.insert(r,s))})),n}))}getBaseDocument(e,t,n){return null===n||1===n.mutation.type?this.remoteDocumentCache.getEntry(e,t):se.resolve(lt.newInvalidDocument(t))}}class _i{constructor(e){this.It=e,this.Zn=new Map,this.ts=new Map}getBundleMetadata(e,t){return se.resolve(this.Zn.get(t))}saveBundleMetadata(e,t){var n;return this.Zn.set(t.id,{id:(n=t).id,version:n.version,createTime:cr(n.createTime)}),se.resolve()}getNamedQuery(e,t){return se.resolve(this.ts.get(t))}saveNamedQuery(e,t){return this.ts.set(t.name,function(e){return{name:e.name,query:bs(e.bundledQuery),readTime:cr(e.readTime)}}(t)),se.resolve()}}class Ni{constructor(){this.overlays=new Ie(Q.comparator),this.es=new Map}getOverlay(e,t){return se.resolve(this.overlays.get(t))}getOverlays(e,t){const n=Un();return se.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){return n.forEach(((n,r)=>{this.ue(e,t,r)})),se.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.es.get(n);return void 0!==r&&(r.forEach((e=>this.overlays=this.overlays.remove(e))),this.es.delete(n)),se.resolve()}getOverlaysForCollection(e,t,n){const r=Un(),s=t.length+1,i=new Q(t.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const e=o.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return se.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let s=new Ie(((e,t)=>e-t));const i=this.overlays.getIterator();for(;i.hasNext();){const e=i.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=s.get(e.largestBatchId);null===t&&(t=Un(),s=s.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=Un(),a=s.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((e,t)=>o.set(e,t))),!(o.size()>=r)););return se.resolve(o)}ue(e,t,n){const r=this.overlays.get(n.key);if(null!==r){const e=this.es.get(r.largestBatchId).delete(n.key);this.es.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new hs(t,n));let s=this.es.get(t);void 0===s&&(s=Qn(),this.es.set(t,s)),this.es.set(t,s.add(n.key))}}class Ai{constructor(){this.ns=new Ee(Ci.ss),this.rs=new Ee(Ci.os)}isEmpty(){return this.ns.isEmpty()}addReference(e,t){const n=new Ci(e,t);this.ns=this.ns.add(n),this.rs=this.rs.add(n)}us(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.cs(new Ci(e,t))}hs(e,t){e.forEach((e=>this.removeReference(e,t)))}ls(e){const t=new Q(new K([])),n=new Ci(t,e),r=new Ci(t,e+1),s=[];return this.rs.forEachInRange([n,r],(e=>{this.cs(e),s.push(e.key)})),s}fs(){this.ns.forEach((e=>this.cs(e)))}cs(e){this.ns=this.ns.delete(e),this.rs=this.rs.delete(e)}ds(e){const t=new Q(new K([])),n=new Ci(t,e),r=new Ci(t,e+1);let s=Qn();return this.rs.forEachInRange([n,r],(e=>{s=s.add(e.key)})),s}containsKey(e){const t=new Ci(e,0),n=this.ns.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class Ci{constructor(e,t){this.key=e,this._s=t}static ss(e,t){return Q.comparator(e.key,t.key)||F(e._s,t._s)}static os(e,t){return F(e._s,t._s)||Q.comparator(e.key,t.key)}}class ki{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.ws=1,this.gs=new Ee(Ci.ss)}checkEmpty(e){return se.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){const s=this.ws;this.ws++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new cs(s,t,n,r);this.mutationQueue.push(i);for(const o of r)this.gs=this.gs.add(new Ci(o.key,s)),this.indexManager.addToCollectionParentIndex(e,o.key.path.popLast());return se.resolve(i)}lookupMutationBatch(e,t){return se.resolve(this.ys(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=this.ps(n),s=r<0?0:r;return se.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return se.resolve(0===this.mutationQueue.length?-1:this.ws-1)}getAllMutationBatches(e){return se.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Ci(t,0),r=new Ci(t,Number.POSITIVE_INFINITY),s=[];return this.gs.forEachInRange([n,r],(e=>{const t=this.ys(e._s);s.push(t)})),se.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new Ee(F);return t.forEach((e=>{const t=new Ci(e,0),r=new Ci(e,Number.POSITIVE_INFINITY);this.gs.forEachInRange([t,r],(e=>{n=n.add(e._s)}))})),se.resolve(this.Is(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;Q.isDocumentKey(s)||(s=s.child(""));const i=new Ci(new Q(s),0);let o=new Ee(F);return this.gs.forEachWhile((e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(o=o.add(e._s)),!0)}),i),se.resolve(this.Is(o))}Is(e){const t=[];return e.forEach((e=>{const n=this.ys(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){I(0===this.Ts(t.batchId,"removed")),this.mutationQueue.shift();let n=this.gs;return se.forEach(t.mutations,(r=>{const s=new Ci(r.key,t.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)})).next((()=>{this.gs=n}))}An(e){}containsKey(e,t){const n=new Ci(t,0),r=this.gs.firstAfterOrEqual(n);return se.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,se.resolve()}Ts(e,t){return this.ps(e)}ps(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}ys(e){const t=this.ps(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class Ri{constructor(e){this.Es=e,this.docs=new Ie(Q.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.Es(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return se.resolve(n?n.document.mutableCopy():lt.newInvalidDocument(t))}getEntries(e,t){let n=Fn();return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():lt.newInvalidDocument(e))})),se.resolve(n)}getAllFromCollection(e,t,n){let r=Fn();const s=new Q(t.child("")),i=this.docs.getIteratorFrom(s);for(;i.hasNext();){const{key:e,value:{document:s}}=i.getNext();if(!t.isPrefixOf(e.path))break;e.path.length>t.length+1||ee(Z(s),n)<=0||(r=r.insert(s.key,s.mutableCopy()))}return se.resolve(r)}getAllFromCollectionGroup(e,t,n,r){v()}As(e,t){return se.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new Vi(this)}getSize(e){return se.resolve(this.size)}}class Vi extends pi{constructor(e){super(),this.Yn=e}applyChanges(e){const t=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?t.push(this.Yn.addEntry(e,r)):this.Yn.removeEntry(n)})),se.waitFor(t)}getFromCache(e,t){return this.Yn.getEntry(e,t)}getAllFromCache(e,t){return this.Yn.getEntries(e,t)}}class Li{constructor(e){this.persistence=e,this.Rs=new Ln((e=>ft(e)),mt),this.lastRemoteSnapshotVersion=U.min(),this.highestTargetId=0,this.bs=0,this.Ps=new Ai,this.targetCount=0,this.vs=ii.Pn()}forEachTarget(e,t){return this.Rs.forEach(((e,n)=>t(n))),se.resolve()}getLastRemoteSnapshotVersion(e){return se.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return se.resolve(this.bs)}allocateTargetId(e){return this.highestTargetId=this.vs.next(),se.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.bs&&(this.bs=t),se.resolve()}Dn(e){this.Rs.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.vs=new ii(t),this.highestTargetId=t),e.sequenceNumber>this.bs&&(this.bs=e.sequenceNumber)}addTargetData(e,t){return this.Dn(t),this.targetCount+=1,se.resolve()}updateTargetData(e,t){return this.Dn(t),se.resolve()}removeTargetData(e,t){return this.Rs.delete(t.target),this.Ps.ls(t.targetId),this.targetCount-=1,se.resolve()}removeTargets(e,t,n){let r=0;const s=[];return this.Rs.forEach(((i,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.Rs.delete(i),s.push(this.removeMatchingKeysForTargetId(e,o.targetId)),r++)})),se.waitFor(s).next((()=>r))}getTargetCount(e){return se.resolve(this.targetCount)}getTargetData(e,t){const n=this.Rs.get(t)||null;return se.resolve(n)}addMatchingKeys(e,t,n){return this.Ps.us(t,n),se.resolve()}removeMatchingKeys(e,t,n){this.Ps.hs(t,n);const r=this.persistence.referenceDelegate,s=[];return r&&t.forEach((t=>{s.push(r.markPotentiallyOrphaned(e,t))})),se.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Ps.ls(t),se.resolve()}getMatchingKeysForTargetId(e,t){const n=this.Ps.ds(t);return se.resolve(n)}containsKey(e,t){return se.resolve(this.Ps.containsKey(t))}}class Mi{constructor(e,t){this.Vs={},this.overlays={},this.Ss=new pe(0),this.Ds=!1,this.Ds=!0,this.referenceDelegate=e(this),this.Cs=new Li(this),this.indexManager=new Bs,this.remoteDocumentCache=function(e){return new Ri(e)}((e=>this.referenceDelegate.xs(e))),this.It=new fs(t),this.Ns=new _i(this.It)}start(){return Promise.resolve()}shutdown(){return this.Ds=!1,Promise.resolve()}get started(){return this.Ds}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Ni,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Vs[e.toKey()];return n||(n=new ki(t,this.referenceDelegate),this.Vs[e.toKey()]=n),n}getTargetCache(){return this.Cs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ns}runTransaction(e,t,n){g("MemoryPersistence","Starting transaction:",e);const r=new Fi(this.Ss.next());return this.referenceDelegate.ks(),n(r).next((e=>this.referenceDelegate.Os(r).next((()=>e)))).toPromise().then((e=>(r.raiseOnCommittedEvent(),e)))}Ms(e,t){return se.or(Object.values(this.Vs).map((n=>()=>n.containsKey(e,t))))}}class Fi extends ne{constructor(e){super(),this.currentSequenceNumber=e}}class Oi{constructor(e){this.persistence=e,this.Fs=new Ai,this.$s=null}static Bs(e){return new Oi(e)}get Ls(){if(this.$s)return this.$s;throw v()}addReference(e,t,n){return this.Fs.addReference(n,t),this.Ls.delete(n.toString()),se.resolve()}removeReference(e,t,n){return this.Fs.removeReference(n,t),this.Ls.add(n.toString()),se.resolve()}markPotentiallyOrphaned(e,t){return this.Ls.add(t.toString()),se.resolve()}removeTarget(e,t){this.Fs.ls(t.targetId).forEach((e=>this.Ls.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.Ls.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}ks(){this.$s=new Set}Os(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return se.forEach(this.Ls,(n=>{const r=Q.fromPath(n);return this.Us(e,r).next((e=>{e||t.removeEntry(r,U.min())}))})).next((()=>(this.$s=null,t.apply(e))))}updateLimboDocument(e,t){return this.Us(e,t).next((e=>{e?this.Ls.delete(t.toString()):this.Ls.add(t.toString())}))}xs(e){return 0}Us(e,t){return se.or([()=>se.resolve(this.Fs.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ms(e,t)])}}class Pi{constructor(e){this.It=e}$(e,t,n,r){const s=new ie("createOrUpgrade",t);n<1&&r>=1&&(function(e){e.createObjectStore("owner")}(e),function(e){e.createObjectStore("mutationQueues",{keyPath:"userId"}),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Pr,{unique:!0}),e.createObjectStore("documentMutations")}(e),qi(e),function(e){e.createObjectStore("remoteDocuments")}(e));let i=se.resolve();return n<3&&r>=3&&(0!==n&&(function(e){e.deleteObjectStore("targetDocuments"),e.deleteObjectStore("targets"),e.deleteObjectStore("targetGlobal")}(e),qi(e)),i=i.next((()=>function(e){const t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:U.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)}(s)))),n<4&&r>=4&&(0!==n&&(i=i.next((()=>function(e,t){return t.store("mutations").W().next((n=>{e.deleteObjectStore("mutations"),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Pr,{unique:!0});const r=t.store("mutations"),s=n.map((e=>r.put(e)));return se.waitFor(s)}))}(e,s)))),i=i.next((()=>{!function(e){e.createObjectStore("clientMetadata",{keyPath:"clientId"})}(e)}))),n<5&&r>=5&&(i=i.next((()=>this.qs(s)))),n<6&&r>=6&&(i=i.next((()=>(function(e){e.createObjectStore("remoteDocumentGlobal")}(e),this.Ks(s))))),n<7&&r>=7&&(i=i.next((()=>this.Gs(s)))),n<8&&r>=8&&(i=i.next((()=>this.Qs(e,s)))),n<9&&r>=9&&(i=i.next((()=>{!function(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e)}))),n<10&&r>=10&&(i=i.next((()=>this.js(s)))),n<11&&r>=11&&(i=i.next((()=>{!function(e){e.createObjectStore("bundles",{keyPath:"bundleId"})}(e),function(e){e.createObjectStore("namedQueries",{keyPath:"name"})}(e)}))),n<12&&r>=12&&(i=i.next((()=>{!function(e){const t=e.createObjectStore("documentOverlays",{keyPath:Jr});t.createIndex("collectionPathOverlayIndex",es,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",ts,{unique:!1})}(e)}))),n<13&&r>=13&&(i=i.next((()=>function(e){const t=e.createObjectStore("remoteDocumentsV14",{keyPath:Kr});t.createIndex("documentKeyIndex",Gr),t.createIndex("collectionGroupIndex",$r)}(e))).next((()=>this.Ws(e,s))).next((()=>e.deleteObjectStore("remoteDocuments")))),n<14&&r>=14&&(i=i.next((()=>this.zs(e,s)))),n<15&&r>=15&&(i=i.next((()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Hr}).createIndex("sequenceNumberIndex",Yr,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Xr}).createIndex("documentKeyIndex",Zr,{unique:!1})}(e)))),i}Ks(e){let t=0;return e.store("remoteDocuments").Z(((e,n)=>{t+=Js(n)})).next((()=>{const n={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}qs(e){const t=e.store("mutationQueues"),n=e.store("mutations");return t.W().next((t=>se.forEach(t,(t=>{const r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.W("userMutationsIndex",r).next((n=>se.forEach(n,(n=>{I(n.userId===t.userId);const r=ws(this.It,n);return Zs(e,t.userId,r).next((()=>{}))}))))}))))}Gs(e){const t=e.store("targetDocuments"),n=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next((e=>{const r=[];return n.Z(((n,s)=>{const i=new K(n),o=function(e){return[0,Lr(e)]}(i);r.push(t.get(o).next((n=>n?se.resolve():(n=>t.put({targetId:0,path:Lr(n),sequenceNumber:e.highestListenSequenceNumber}))(i))))})).next((()=>se.waitFor(r)))}))}Qs(e,t){e.createObjectStore("collectionParents",{keyPath:Wr});const n=t.store("collectionParents"),r=new Ks,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:Lr(r)})}};return t.store("remoteDocuments").Z({X:!0},((e,t)=>{const n=new K(e);return s(n.popLast())})).next((()=>t.store("documentMutations").Z({X:!0},(([e,t,n],r)=>{const i=Or(t);return s(i.popLast())}))))}js(e){const t=e.store("targets");return t.Z(((e,n)=>{const r=vs(n),s=Is(this.It,r);return t.put(s)}))}Ws(e,t){const n=t.store("remoteDocuments"),r=[];return n.Z(((e,n)=>{const s=t.store("remoteDocumentsV14"),i=(o=n,o.document?new Q(K.fromString(o.document.name).popFirst(5)):o.noDocument?Q.fromSegments(o.noDocument.path):o.unknownDocument?Q.fromSegments(o.unknownDocument.path):v()).path.toArray();var o;const a={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(s.put(a))})).next((()=>se.waitFor(r)))}zs(e,t){const n=t.store("mutations"),r=wi(this.It),s=new Mi(Oi.Bs,this.It.re);return n.W().next((e=>{const n=new Map;return e.forEach((e=>{var t;let r=null!==(t=n.get(e.userId))&&void 0!==t?t:Qn();ws(this.It,e).keys().forEach((e=>r=r.add(e))),n.set(e.userId,r)})),se.forEach(n,((e,n)=>{const i=new l(n),o=Ns.oe(this.It,i),a=s.getIndexManager(i),u=ei.oe(i,this.It,a,s.referenceDelegate);return new Di(r,u,o,a).recalculateAndSaveOverlaysForDocumentKeys(new as(t,pe.at),e).next()}))}))}}function qi(e){e.createObjectStore("targetDocuments",{keyPath:zr}).createIndex("documentTargetsIndex",jr,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",Qr,{unique:!0}),e.createObjectStore("targetGlobal")}const Ui="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Bi{constructor(e,t,n,r,s,i,o,a,u,c,l=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Hs=s,this.window=i,this.document=o,this.Js=u,this.Ys=c,this.Xs=l,this.Ss=null,this.Ds=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Zs=null,this.inForeground=!1,this.ti=null,this.ei=null,this.ni=Number.NEGATIVE_INFINITY,this.si=e=>Promise.resolve(),!Bi.C())throw new S(E.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new mi(this,r),this.ii=t+"main",this.It=new fs(a),this.ri=new oe(this.ii,this.Xs,new Pi(this.It)),this.Cs=new oi(this.referenceDelegate,this.It),this.remoteDocumentCache=wi(this.It),this.Ns=new xs,this.window&&this.window.localStorage?this.oi=this.window.localStorage:(this.oi=null,!1===c&&p("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.ui().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new S(E.FAILED_PRECONDITION,Ui);return this.ci(),this.ai(),this.hi(),this.runTransaction("getHighestListenSequenceNumber","readonly",(e=>this.Cs.getHighestSequenceNumber(e)))})).then((e=>{this.Ss=new pe(e,this.Js)})).then((()=>{this.Ds=!0})).catch((e=>(this.ri&&this.ri.close(),Promise.reject(e))))}li(e){return this.si=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.ri.L((async t=>{null===t.newVersion&&await e()}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Hs.enqueueAndForget((async()=>{this.started&&await this.ui()})))}ui(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(e=>Gi(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.fi(e).next((e=>{e||(this.isPrimary=!1,this.Hs.enqueueRetryable((()=>this.si(!1))))}))})).next((()=>this.di(e))).next((t=>this.isPrimary&&!t?this._i(e).next((()=>!1)):!!t&&this.wi(e).next((()=>!0)))))).catch((e=>{if(ce(e))return g("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return g("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1})).then((e=>{this.isPrimary!==e&&this.Hs.enqueueRetryable((()=>this.si(e))),this.isPrimary=e}))}fi(e){return Ki(e).get("owner").next((e=>se.resolve(this.mi(e))))}gi(e){return Gi(e).delete(this.clientId)}async yi(){if(this.isPrimary&&!this.pi(this.ni,18e5)){this.ni=Date.now();const e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(e=>{const t=us(e,"clientMetadata");return t.W().next((e=>{const n=this.Ii(e,18e5),r=e.filter((e=>-1===n.indexOf(e)));return se.forEach(r,(e=>t.delete(e.clientId))).next((()=>r))}))})).catch((()=>[]));if(this.oi)for(const t of e)this.oi.removeItem(this.Ti(t.clientId))}}hi(){this.ei=this.Hs.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.ui().then((()=>this.yi())).then((()=>this.hi()))))}mi(e){return!!e&&e.ownerId===this.clientId}di(e){return this.Ys?se.resolve(!0):Ki(e).get("owner").next((t=>{if(null!==t&&this.pi(t.leaseTimestampMs,5e3)&&!this.Ei(t.ownerId)){if(this.mi(t)&&this.networkEnabled)return!0;if(!this.mi(t)){if(!t.allowTabSynchronization)throw new S(E.FAILED_PRECONDITION,Ui);return!1}}return!(!this.networkEnabled||!this.inForeground)||Gi(e).W().next((e=>void 0===this.Ii(e,5e3).find((e=>{if(this.clientId!==e.clientId){const t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))))})).next((e=>(this.isPrimary!==e&&g("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e)))}async shutdown(){this.Ds=!1,this.Ai(),this.ei&&(this.ei.cancel(),this.ei=null),this.Ri(),this.bi(),await this.ri.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(e=>{const t=new as(e,pe.at);return this._i(t).next((()=>this.gi(t)))})),this.ri.close(),this.Pi()}Ii(e,t){return e.filter((e=>this.pi(e.updateTimeMs,t)&&!this.Ei(e.clientId)))}vi(){return this.runTransaction("getActiveClients","readonly",(e=>Gi(e).W().next((e=>this.Ii(e,18e5).map((e=>e.clientId))))))}get started(){return this.Ds}getMutationQueue(e,t){return ei.oe(e,this.It,t,this.referenceDelegate)}getTargetCache(){return this.Cs}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new $s(e,this.It.re.databaseId)}getDocumentOverlayCache(e){return Ns.oe(this.It,e)}getBundleCache(){return this.Ns}runTransaction(e,t,n){g("IndexedDbPersistence","Starting transaction:",e);const r="readonly"===t?"readonly":"readwrite",s=15===(i=this.Xs)?os:14===i?is:13===i?ss:12===i?rs:11===i?ns:void v();var i;let o;return this.ri.runTransaction(e,r,s,(r=>(o=new as(r,this.Ss?this.Ss.next():pe.at),"readwrite-primary"===t?this.fi(o).next((e=>!!e||this.di(o))).next((t=>{if(!t)throw p(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Hs.enqueueRetryable((()=>this.si(!1))),new S(E.FAILED_PRECONDITION,te);return n(o)})).next((e=>this.wi(o).next((()=>e)))):this.Vi(o).next((()=>n(o)))))).then((e=>(o.raiseOnCommittedEvent(),e)))}Vi(e){return Ki(e).get("owner").next((e=>{if(null!==e&&this.pi(e.leaseTimestampMs,5e3)&&!this.Ei(e.ownerId)&&!this.mi(e)&&!(this.Ys||this.allowTabSynchronization&&e.allowTabSynchronization))throw new S(E.FAILED_PRECONDITION,Ui)}))}wi(e){const t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Ki(e).put("owner",t)}static C(){return oe.C()}_i(e){const t=Ki(e);return t.get("owner").next((e=>this.mi(e)?(g("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):se.resolve()))}pi(e,t){const n=Date.now();return!(e<n-t)&&(!(e>n)||(p(`Detected an update time that is in the future: ${e} > ${n}`),!1))}ci(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ti=()=>{this.Hs.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.ui())))},this.document.addEventListener("visibilitychange",this.ti),this.inForeground="visible"===this.document.visibilityState)}Ri(){this.ti&&(this.document.removeEventListener("visibilitychange",this.ti),this.ti=null)}ai(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.Zs=()=>{this.Ai(),(0,o.G6)()&&navigator.appVersion.match(/Version\/1[45]/)&&this.Hs.enterRestrictedMode(!0),this.Hs.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.Zs))}bi(){this.Zs&&(this.window.removeEventListener("pagehide",this.Zs),this.Zs=null)}Ei(e){var t;try{const n=null!==(null===(t=this.oi)||void 0===t?void 0:t.getItem(this.Ti(e)));return g("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return p("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Ai(){if(this.oi)try{this.oi.setItem(this.Ti(this.clientId),String(Date.now()))}catch(e){p("Failed to set zombie client id.",e)}}Pi(){if(this.oi)try{this.oi.removeItem(this.Ti(this.clientId))}catch(e){}}Ti(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function Ki(e){return us(e,"owner")}function Gi(e){return us(e,"clientMetadata")}function $i(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class Qi{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Si=n,this.Di=r}static Ci(e,t){let n=Qn(),r=Qn();for(const s of t.docChanges)switch(s.type){case 0:n=n.add(s.doc.key);break;case 1:r=r.add(s.doc.key)}return new Qi(e,t.fromCache,n,r)}}class zi{constructor(){this.xi=!1}initialize(e,t){this.Ni=e,this.indexManager=t,this.xi=!0}getDocumentsMatchingQuery(e,t,n,r){return this.ki(e,t).next((s=>s||this.Oi(e,t,r,n))).next((n=>n||this.Mi(e,t)))}ki(e,t){if(Ft(t))return se.resolve(null);let n=Bt(t);return this.indexManager.getIndexType(e,n).next((r=>0===r?null:(null!==t.limit&&1===r&&(t=Kt(t,null,"F"),n=Bt(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next((r=>{const s=Qn(...r);return this.Ni.getDocuments(e,s).next((r=>this.indexManager.getMinOffset(e,n).next((n=>{const i=this.Fi(t,r);return this.$i(t,i,s,n.readTime)?this.ki(e,Kt(t,null,"F")):this.Bi(e,i,t,n)}))))})))))}Oi(e,t,n,r){return Ft(t)||r.isEqual(U.min())?this.Mi(e,t):this.Ni.getDocuments(e,n).next((s=>{const o=this.Fi(t,s);return this.$i(t,o,n,r)?this.Mi(e,t):(f()<=i.in.DEBUG&&g("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),Qt(t)),this.Bi(e,o,t,X(r,-1)))}))}Fi(e,t){let n=new Ee(Wt(e));return t.forEach(((t,r)=>{zt(e,r)&&(n=n.add(r))})),n}$i(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}Mi(e,t){return f()<=i.in.DEBUG&&g("QueryEngine","Using full collection scan to execute query:",Qt(t)),this.Ni.getDocumentsMatchingQuery(e,t,J.min())}Bi(e,t,n,r){return this.Ni.getDocumentsMatchingQuery(e,n,r).next((e=>(t.forEach((t=>{e=e.insert(t.key,t)})),e)))}}class ji{constructor(e,t,n,r){this.persistence=e,this.Li=t,this.It=r,this.Ui=new Ie(F),this.qi=new Ln((e=>ft(e)),mt),this.Ki=new Map,this.Gi=e.getRemoteDocumentCache(),this.Cs=e.getTargetCache(),this.Ns=e.getBundleCache(),this.Qi(n)}Qi(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Di(this.Gi,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Gi.setIndexManager(this.indexManager),this.Li.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.Ui)))}}function Wi(e,t,n,r){return new ji(e,t,n,r)}async function Hi(e,t){const n=T(e);return await n.persistence.runTransaction("Handle user change","readonly",(e=>{let r;return n.mutationQueue.getAllMutationBatches(e).next((s=>(r=s,n.Qi(t),n.mutationQueue.getAllMutationBatches(e)))).next((t=>{const s=[],i=[];let o=Qn();for(const e of r){s.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){i.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return n.localDocuments.getDocuments(e,o).next((e=>({ji:e,removedBatchIds:s,addedBatchIds:i})))}))}))}function Yi(e){const t=T(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.Cs.getLastRemoteSnapshotVersion(e)))}function Xi(e,t,n){let r=Qn(),s=Qn();return n.forEach((e=>r=r.add(e))),t.getEntries(e,r).next((e=>{let r=Fn();return n.forEach(((n,i)=>{const o=e.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(s=s.add(n)),i.isNoDocument()&&i.version.isEqual(U.min())?(t.removeEntry(n,i.readTime),r=r.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(t.addEntry(i),r=r.insert(n,i)):g("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)})),{Wi:r,zi:s}}))}function Zi(e,t){const n=T(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t))))}function Ji(e,t){const n=T(e);return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let r;return n.Cs.getTargetData(e,t).next((s=>s?(r=s,se.resolve(r)):n.Cs.allocateTargetId(e).next((s=>(r=new ds(t,s,0,e.currentSequenceNumber),n.Cs.addTargetData(e,r).next((()=>r)))))))})).then((e=>{const r=n.Ui.get(e.targetId);return(null===r||e.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.Ui=n.Ui.insert(e.targetId,e),n.qi.set(t,e.targetId)),e}))}async function eo(e,t,n){const r=T(e),s=r.Ui.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,(e=>r.persistence.referenceDelegate.removeTarget(e,s)))}catch(e){if(!ce(e))throw e;g("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.Ui=r.Ui.remove(t),r.qi.delete(s.target)}function to(e,t,n){const r=T(e);let s=U.min(),i=Qn();return r.persistence.runTransaction("Execute query","readonly",(e=>function(e,t,n){const r=T(e),s=r.qi.get(n);return void 0!==s?se.resolve(r.Ui.get(s)):r.Cs.getTargetData(t,n)}(r,e,Bt(t)).next((t=>{if(t)return s=t.lastLimboFreeSnapshotVersion,r.Cs.getMatchingKeysForTargetId(e,t.targetId).next((e=>{i=e}))})).next((()=>r.Li.getDocumentsMatchingQuery(e,t,n?s:U.min(),n?i:Qn()))).next((e=>(so(r,jt(t),e),{documents:e,Hi:i})))))}function no(e,t){const n=T(e),r=T(n.Cs),s=n.Ui.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",(e=>r.se(e,t).next((e=>e?e.target:null))))}function ro(e,t){const n=T(e),r=n.Ki.get(t)||U.min();return n.persistence.runTransaction("Get new document changes","readonly",(e=>n.Gi.getAllFromCollectionGroup(e,t,X(r,-1),Number.MAX_SAFE_INTEGER))).then((e=>(so(n,t,e),e)))}function so(e,t,n){let r=e.Ki.get(t)||U.min();n.forEach(((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)})),e.Ki.set(t,r)}async function io(e,t,n=Qn()){const r=await Ji(e,Bt(bs(t.bundledQuery))),s=T(e);return s.persistence.runTransaction("Save named query","readwrite",(e=>{const i=cr(t.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.Ns.saveNamedQuery(e,t);const o=r.withResumeToken(Ne.EMPTY_BYTE_STRING,i);return s.Ui=s.Ui.insert(o.targetId,o),s.Cs.updateTargetData(e,o).next((()=>s.Cs.removeMatchingKeysForTargetId(e,r.targetId))).next((()=>s.Cs.addMatchingKeys(e,n,r.targetId))).next((()=>s.Ns.saveNamedQuery(e,t)))}))}function oo(e,t){return`firestore_clients_${e}_${t}`}function ao(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function uo(e,t){return`firestore_targets_${e}_${t}`}class co{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Zi(e,t,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new S(r.error.code,r.error.message))),i?new co(e,t,r.state,s):(p("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}tr(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class lo{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Zi(e,t){const n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new S(n.error.code,n.error.message))),s?new lo(e,n.state,r):(p("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}tr(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class ho{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Zi(e,t){const n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=jn();for(let i=0;r&&i<n.activeTargetIds.length;++i)r=Ue(n.activeTargetIds[i]),s=s.add(n.activeTargetIds[i]);return r?new ho(e,s):(p("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class fo{constructor(e,t){this.clientId=e,this.onlineState=t}static Zi(e){const t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new fo(t.clientId,t.onlineState):(p("SharedClientState",`Failed to parse online state: ${e}`),null)}}class mo{constructor(){this.activeTargetIds=jn()}er(e){this.activeTargetIds=this.activeTargetIds.add(e)}nr(e){this.activeTargetIds=this.activeTargetIds.delete(e)}tr(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class go{constructor(e,t,n,r,s){this.window=e,this.Hs=t,this.persistenceKey=n,this.sr=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ir=this.rr.bind(this),this.ur=new Ie(F),this.started=!1,this.cr=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.ar=oo(this.persistenceKey,this.sr),this.hr=function(e){return`firestore_sequence_number_${e}`}(this.persistenceKey),this.ur=this.ur.insert(this.sr,new mo),this.lr=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.dr=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this._r=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.wr=function(e){return`firestore_online_state_${e}`}(this.persistenceKey),this.mr=function(e){return`firestore_bundle_loaded_v2_${e}`}(this.persistenceKey),this.window.addEventListener("storage",this.ir)}static C(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.vi();for(const n of e){if(n===this.sr)continue;const e=this.getItem(oo(this.persistenceKey,n));if(e){const t=ho.Zi(n,e);t&&(this.ur=this.ur.insert(t.clientId,t))}}this.gr();const t=this.storage.getItem(this.wr);if(t){const e=this.yr(t);e&&this.pr(e)}for(const n of this.cr)this.rr(n);this.cr=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(e){this.setItem(this.hr,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Ir(this.ur)}isActiveQueryTarget(e){let t=!1;return this.ur.forEach(((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)})),t}addPendingMutation(e){this.Tr(e,"pending")}updateMutationState(e,t,n){this.Tr(e,t,n),this.Er(e)}addLocalQueryTarget(e){let t="not-current";if(this.isActiveQueryTarget(e)){const n=this.storage.getItem(uo(this.persistenceKey,e));if(n){const r=lo.Zi(e,n);r&&(t=r.state)}}return this.Ar.er(e),this.gr(),t}removeLocalQueryTarget(e){this.Ar.nr(e),this.gr()}isLocalQueryTarget(e){return this.Ar.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(uo(this.persistenceKey,e))}updateQueryState(e,t,n){this.Rr(e,t,n)}handleUserChange(e,t,n){t.forEach((e=>{this.Er(e)})),this.currentUser=e,n.forEach((e=>{this.addPendingMutation(e)}))}setOnlineState(e){this.br(e)}notifyBundleLoaded(e){this.Pr(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ir),this.removeItem(this.ar),this.started=!1)}getItem(e){const t=this.storage.getItem(e);return g("SharedClientState","READ",e,t),t}setItem(e,t){g("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){g("SharedClientState","REMOVE",e),this.storage.removeItem(e)}rr(e){const t=e;if(t.storageArea===this.storage){if(g("SharedClientState","EVENT",t.key,t.newValue),t.key===this.ar)return void p("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Hs.enqueueRetryable((async()=>{if(this.started){if(null!==t.key)if(this.lr.test(t.key)){if(null==t.newValue){const e=this.vr(t.key);return this.Vr(e,null)}{const e=this.Sr(t.key,t.newValue);if(e)return this.Vr(e.clientId,e)}}else if(this.dr.test(t.key)){if(null!==t.newValue){const e=this.Dr(t.key,t.newValue);if(e)return this.Cr(e)}}else if(this._r.test(t.key)){if(null!==t.newValue){const e=this.Nr(t.key,t.newValue);if(e)return this.kr(e)}}else if(t.key===this.wr){if(null!==t.newValue){const e=this.yr(t.newValue);if(e)return this.pr(e)}}else if(t.key===this.hr){const e=function(e){let t=pe.at;if(null!=e)try{const n=JSON.parse(e);I("number"==typeof n),t=n}catch(e){p("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(t.newValue);e!==pe.at&&this.sequenceNumberHandler(e)}else if(t.key===this.mr){const e=this.Or(t.newValue);await Promise.all(e.map((e=>this.syncEngine.Mr(e))))}}else this.cr.push(t)}))}}get Ar(){return this.ur.get(this.sr)}gr(){this.setItem(this.ar,this.Ar.tr())}Tr(e,t,n){const r=new co(this.currentUser,e,t,n),s=ao(this.persistenceKey,this.currentUser,e);this.setItem(s,r.tr())}Er(e){const t=ao(this.persistenceKey,this.currentUser,e);this.removeItem(t)}br(e){const t={clientId:this.sr,onlineState:e};this.storage.setItem(this.wr,JSON.stringify(t))}Rr(e,t,n){const r=uo(this.persistenceKey,e),s=new lo(e,t,n);this.setItem(r,s.tr())}Pr(e){const t=JSON.stringify(Array.from(e));this.setItem(this.mr,t)}vr(e){const t=this.lr.exec(e);return t?t[1]:null}Sr(e,t){const n=this.vr(e);return ho.Zi(n,t)}Dr(e,t){const n=this.dr.exec(e),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return co.Zi(new l(s),r,t)}Nr(e,t){const n=this._r.exec(e),r=Number(n[1]);return lo.Zi(r,t)}yr(e){return fo.Zi(e)}Or(e){return JSON.parse(e)}async Cr(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Fr(e.batchId,e.state,e.error);g("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}kr(e){return this.syncEngine.$r(e.targetId,e.state,e.error)}Vr(e,t){const n=t?this.ur.insert(e,t):this.ur.remove(e),r=this.Ir(this.ur),s=this.Ir(n),i=[],o=[];return s.forEach((e=>{r.has(e)||i.push(e)})),r.forEach((e=>{s.has(e)||o.push(e)})),this.syncEngine.Br(i,o).then((()=>{this.ur=n}))}pr(e){this.ur.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Ir(e){let t=jn();return e.forEach(((e,n)=>{t=t.unionWith(n.activeTargetIds)})),t}}class po{constructor(){this.Lr=new mo,this.Ur={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.Lr.er(e),this.Ur[e]||"not-current"}updateQueryState(e,t,n){this.Ur[e]=t}removeLocalQueryTarget(e){this.Lr.nr(e)}isLocalQueryTarget(e){return this.Lr.activeTargetIds.has(e)}clearQueryState(e){delete this.Ur[e]}getAllActiveQueryTargets(){return this.Lr.activeTargetIds}isActiveQueryTarget(e){return this.Lr.activeTargetIds.has(e)}start(){return this.Lr=new mo,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class yo{qr(e){}shutdown(){}}class wo{constructor(){this.Kr=()=>this.Gr(),this.Qr=()=>this.jr(),this.Wr=[],this.zr()}qr(e){this.Wr.push(e)}shutdown(){window.removeEventListener("online",this.Kr),window.removeEventListener("offline",this.Qr)}zr(){window.addEventListener("online",this.Kr),window.addEventListener("offline",this.Qr)}Gr(){g("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.Wr)e(0)}jr(){g("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.Wr)e(1)}static C(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const vo={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Io{constructor(e){this.Hr=e.Hr,this.Jr=e.Jr}Yr(e){this.Xr=e}Zr(e){this.eo=e}onMessage(e){this.no=e}close(){this.Jr()}send(e){this.Hr(e)}so(){this.Xr()}io(e){this.eo(e)}ro(e){this.no(e)}}class bo extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http";this.oo=t+"://"+e.host,this.uo="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}get co(){return!1}ao(e,t,n,r,s){const i=this.ho(e,t);g("RestConnection","Sending: ",i,n);const o={};return this.lo(o,r,s),this.fo(e,i,o,n).then((e=>(g("RestConnection","Received: ",e),e)),(t=>{throw y("RestConnection",`${e} failed with error: `,t,"url: ",i,"request:",n),t}))}_o(e,t,n,r,s,i){return this.ao(e,t,n,r,s)}lo(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+h,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}ho(e,t){const n=vo[e];return`${this.oo}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams}fo(e,t,n,r){return new Promise(((s,i)=>{const o=new a.JJ;o.setWithCredentials(!0),o.listenOnce(a.tw.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case a.jK.NO_ERROR:const t=o.getResponseJson();g("Connection","XHR received:",JSON.stringify(t)),s(t);break;case a.jK.TIMEOUT:g("Connection",'RPC "'+e+'" timed out'),i(new S(E.DEADLINE_EXCEEDED,"Request time out"));break;case a.jK.HTTP_ERROR:const n=o.getStatus();if(g("Connection",'RPC "'+e+'" failed with status:',n,"response text:",o.getResponseText()),n>0){const e=o.getResponseJson().error;if(e&&e.status&&e.message){const t=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(E).indexOf(t)>=0?t:E.UNKNOWN}(e.status);i(new S(t,e.message))}else i(new S(E.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new S(E.UNAVAILABLE,"Connection failed."));break;default:v()}}finally{g("Connection",'RPC "'+e+'" completed.')}}));const u=JSON.stringify(r);o.send(t,"POST",u,n,15)}))}wo(e,t,n){const r=[this.oo,"/","google.firestore.v1.Firestore","/",e,"/channel"],s=(0,a.UE)(),i=(0,a.FJ)(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(o.xmlHttpFactory=new a.zI({})),this.lo(o.initMessageHeaders,t,n),o.encodeInitMessageHeaders=!0;const u=r.join("");g("Connection","Creating WebChannel: "+u,o);const c=s.createWebChannel(u,o);let l=!1,h=!1;const d=new Io({Hr:e=>{h?g("Connection","Not sending because WebChannel is closed:",e):(l||(g("Connection","Opening WebChannel transport."),c.open(),l=!0),g("Connection","WebChannel sending:",e),c.send(e))},Jr:()=>c.close()}),f=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return f(c,a.ii.EventType.OPEN,(()=>{h||g("Connection","WebChannel transport opened.")})),f(c,a.ii.EventType.CLOSE,(()=>{h||(h=!0,g("Connection","WebChannel transport closed"),d.io())})),f(c,a.ii.EventType.ERROR,(e=>{h||(h=!0,y("Connection","WebChannel transport errored:",e),d.io(new S(E.UNAVAILABLE,"The operation could not be completed")))})),f(c,a.ii.EventType.MESSAGE,(e=>{var t;if(!h){const n=e.data[0];I(!!n);const r=n,s=r.error||(null===(t=r[0])||void 0===t?void 0:t.error);if(s){g("Connection","WebChannel received error:",s);const e=s.status;let t=function(e){const t=Cn[e];if(void 0!==t)return Vn(t)}(e),n=s.message;void 0===t&&(t=E.INTERNAL,n="Unknown error status: "+e+" with message "+s.message),h=!0,d.io(new S(t,n)),c.close()}else g("Connection","WebChannel received:",n),d.ro(n)}})),f(i,a.ju.STAT_EVENT,(e=>{e.stat===a.kN.PROXY?g("Connection","Detected buffering proxy"):e.stat===a.kN.NOPROXY&&g("Connection","Detected no buffering proxy")})),setTimeout((()=>{d.so()}),0),d}}function To(){return"undefined"!=typeof window?window:null}function Eo(){return"undefined"!=typeof document?document:null}function So(e){return new ir(e,!0)}class xo{constructor(e,t,n=1e3,r=1.5,s=6e4){this.Hs=e,this.timerId=t,this.mo=n,this.yo=r,this.po=s,this.Io=0,this.To=null,this.Eo=Date.now(),this.reset()}reset(){this.Io=0}Ao(){this.Io=this.po}Ro(e){this.cancel();const t=Math.floor(this.Io+this.bo()),n=Math.max(0,Date.now()-this.Eo),r=Math.max(0,t-n);r>0&&g("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Io} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.To=this.Hs.enqueueAfterDelay(this.timerId,r,(()=>(this.Eo=Date.now(),e()))),this.Io*=this.yo,this.Io<this.mo&&(this.Io=this.mo),this.Io>this.po&&(this.Io=this.po)}Po(){null!==this.To&&(this.To.skipDelay(),this.To=null)}cancel(){null!==this.To&&(this.To.cancel(),this.To=null)}bo(){return(Math.random()-.5)*this.Io}}class Do{constructor(e,t,n,r,s,i,o,a){this.Hs=e,this.vo=n,this.Vo=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.So=0,this.Do=null,this.Co=null,this.stream=null,this.xo=new xo(e,t)}No(){return 1===this.state||5===this.state||this.ko()}ko(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Oo()}async stop(){this.No()&&await this.close(0)}Mo(){this.state=0,this.xo.reset()}Fo(){this.ko()&&null===this.Do&&(this.Do=this.Hs.enqueueAfterDelay(this.vo,6e4,(()=>this.$o())))}Bo(e){this.Lo(),this.stream.send(e)}async $o(){if(this.ko())return this.close(0)}Lo(){this.Do&&(this.Do.cancel(),this.Do=null)}Uo(){this.Co&&(this.Co.cancel(),this.Co=null)}async close(e,t){this.Lo(),this.Uo(),this.xo.cancel(),this.So++,4!==e?this.xo.reset():t&&t.code===E.RESOURCE_EXHAUSTED?(p(t.toString()),p("Using maximum backoff delay to prevent overloading the backend."),this.xo.Ao()):t&&t.code===E.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.qo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Zr(t)}qo(){}auth(){this.state=1;const e=this.Ko(this.So),t=this.So;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([e,n])=>{this.So===t&&this.Go(e,n)}),(t=>{e((()=>{const e=new S(E.UNKNOWN,"Fetching auth token failed: "+t.message);return this.Qo(e)}))}))}Go(e,t){const n=this.Ko(this.So);this.stream=this.jo(e,t),this.stream.Yr((()=>{n((()=>(this.state=2,this.Co=this.Hs.enqueueAfterDelay(this.Vo,1e4,(()=>(this.ko()&&(this.state=3),Promise.resolve()))),this.listener.Yr())))})),this.stream.Zr((e=>{n((()=>this.Qo(e)))})),this.stream.onMessage((e=>{n((()=>this.onMessage(e)))}))}Oo(){this.state=5,this.xo.Ro((async()=>{this.state=0,this.start()}))}Qo(e){return g("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}Ko(e){return t=>{this.Hs.enqueueAndForget((()=>this.So===e?t():(g("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class _o extends Do{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.It=s}jo(e,t){return this.connection.wo("Listen",e,t)}onMessage(e){this.xo.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const r=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:v()}(t.targetChange.targetChangeType||"NO_CHANGE"),s=t.targetChange.targetIds||[],i=function(e,t){return e.gt?(I(void 0===t||"string"==typeof t),Ne.fromBase64String(t||"")):(I(void 0===t||t instanceof Uint8Array),Ne.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(e){const t=void 0===e.code?E.UNKNOWN:Vn(e.code);return new S(t,e.message||"")}(o);n=new Zn(r,s,i,a||null)}else if("documentChange"in t){t.documentChange;const r=t.documentChange;r.document,r.document.name,r.document.updateTime;const s=fr(e,r.document.name),i=cr(r.document.updateTime),o=new ut({mapValue:{fields:r.document.fields}}),a=lt.newFoundDocument(s,i,o),u=r.targetIds||[],c=r.removedTargetIds||[];n=new Yn(u,c,a.key,a)}else if("documentDelete"in t){t.documentDelete;const r=t.documentDelete;r.document;const s=fr(e,r.document),i=r.readTime?cr(r.readTime):U.min(),o=lt.newNoDocument(s,i),a=r.removedTargetIds||[];n=new Yn([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const r=t.documentRemove;r.document;const s=fr(e,r.document),i=r.removedTargetIds||[];n=new Yn([],i,s,null)}else{if(!("filter"in t))return v();{t.filter;const e=t.filter;e.targetId;const r=e.count||0,s=new An(r),i=e.targetId;n=new Xn(i,s)}}return n}(this.It,e),n=function(e){if(!("targetChange"in e))return U.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?U.min():t.readTime?cr(t.readTime):U.min()}(e);return this.listener.Wo(t,n)}zo(e){const t={};t.database=pr(this.It),t.addTarget=function(e,t){let n;const r=t.target;return n=gt(r)?{documents:Tr(e,r)}:{query:Er(e,r)},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0?n.resumeToken=ar(e,t.resumeToken):t.snapshotVersion.compareTo(U.min())>0&&(n.readTime=or(e,t.snapshotVersion.toTimestamp())),n}(this.It,e);const n=function(e,t){const n=function(e,t){switch(t){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return v()}}(0,t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.It,e);n&&(t.labels=n),this.Bo(t)}Ho(e){const t={};t.database=pr(this.It),t.removeTarget=e,this.Bo(t)}}class No extends Do{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.It=s,this.Jo=!1}get Yo(){return this.Jo}start(){this.Jo=!1,this.lastStreamToken=void 0,super.start()}qo(){this.Jo&&this.Xo([])}jo(e,t){return this.connection.wo("Write",e,t)}onMessage(e){if(I(!!e.streamToken),this.lastStreamToken=e.streamToken,this.Jo){this.xo.reset();const t=function(e,t){return e&&e.length>0?(I(void 0!==t),e.map((e=>function(e,t){let n=e.updateTime?cr(e.updateTime):cr(t);return n.isEqual(U.min())&&(n=cr(t)),new fn(n,e.transformResults||[])}(e,t)))):[]}(e.writeResults,e.commitTime),n=cr(e.commitTime);return this.listener.Zo(n,t)}return I(!e.writeResults||0===e.writeResults.length),this.Jo=!0,this.listener.tu()}eu(){const e={};e.database=pr(this.It),this.Bo(e)}Xo(e){const t={streamToken:this.lastStreamToken,writes:e.map((e=>Ir(this.It,e)))};this.Bo(t)}}class Ao extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.It=r,this.nu=!1}su(){if(this.nu)throw new S(E.FAILED_PRECONDITION,"The client has already been terminated.")}ao(e,t,n){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,s])=>this.connection.ao(e,t,n,r,s))).catch((e=>{throw"FirebaseError"===e.name?(e.code===E.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new S(E.UNKNOWN,e.toString())}))}_o(e,t,n,r){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,i])=>this.connection._o(e,t,n,s,i,r))).catch((e=>{throw"FirebaseError"===e.name?(e.code===E.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new S(E.UNKNOWN,e.toString())}))}terminate(){this.nu=!0}}class Co{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.iu=0,this.ru=null,this.ou=!0}uu(){0===this.iu&&(this.cu("Unknown"),this.ru=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.ru=null,this.au("Backend didn't respond within 10 seconds."),this.cu("Offline"),Promise.resolve()))))}hu(e){"Online"===this.state?this.cu("Unknown"):(this.iu++,this.iu>=1&&(this.lu(),this.au(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.cu("Offline")))}set(e){this.lu(),this.iu=0,"Online"===e&&(this.ou=!1),this.cu(e)}cu(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}au(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.ou?(p(t),this.ou=!1):g("OnlineStateTracker",t)}lu(){null!==this.ru&&(this.ru.cancel(),this.ru=null)}}class ko{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.fu=[],this.du=new Map,this._u=new Set,this.wu=[],this.mu=s,this.mu.qr((e=>{n.enqueueAndForget((async()=>{Uo(this)&&(g("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=T(e);t._u.add(4),await Vo(t),t.gu.set("Unknown"),t._u.delete(4),await Ro(t)}(this))}))})),this.gu=new Co(n,r)}}async function Ro(e){if(Uo(e))for(const t of e.wu)await t(!0)}async function Vo(e){for(const t of e.wu)await t(!1)}function Lo(e,t){const n=T(e);n.du.has(t.targetId)||(n.du.set(t.targetId,t),qo(n)?Po(n):sa(n).ko()&&Fo(n,t))}function Mo(e,t){const n=T(e),r=sa(n);n.du.delete(t),r.ko()&&Oo(n,t),0===n.du.size&&(r.ko()?r.Fo():Uo(n)&&n.gu.set("Unknown"))}function Fo(e,t){e.yu.Mt(t.targetId),sa(e).zo(t)}function Oo(e,t){e.yu.Mt(t),sa(e).Ho(t)}function Po(e){e.yu=new er({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),se:t=>e.du.get(t)||null}),sa(e).start(),e.gu.uu()}function qo(e){return Uo(e)&&!sa(e).No()&&e.du.size>0}function Uo(e){return 0===T(e)._u.size}function Bo(e){e.yu=void 0}async function Ko(e){e.du.forEach(((t,n)=>{Fo(e,t)}))}async function Go(e,t){Bo(e),qo(e)?(e.gu.hu(t),Po(e)):e.gu.set("Unknown")}async function $o(e,t,n){if(e.gu.set("Online"),t instanceof Zn&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const r of t.targetIds)e.du.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.du.delete(r),e.yu.removeTarget(r))}(e,t)}catch(n){g("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await Qo(e,n)}else if(t instanceof Yn?e.yu.Gt(t):t instanceof Xn?e.yu.Yt(t):e.yu.Wt(t),!n.isEqual(U.min()))try{const t=await Yi(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.yu.te(t);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=e.du.get(r);s&&e.du.set(r,s.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach((t=>{const n=e.du.get(t);if(!n)return;e.du.set(t,n.withResumeToken(Ne.EMPTY_BYTE_STRING,n.snapshotVersion)),Oo(e,t);const r=new ds(n.target,t,1,n.sequenceNumber);Fo(e,r)})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){g("RemoteStore","Failed to raise snapshot:",t),await Qo(e,t)}}async function Qo(e,t,n){if(!ce(t))throw t;e._u.add(1),await Vo(e),e.gu.set("Offline"),n||(n=()=>Yi(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{g("RemoteStore","Retrying IndexedDB access"),await n(),e._u.delete(1),await Ro(e)}))}function zo(e,t){return t().catch((n=>Qo(e,n,t)))}async function jo(e){const t=T(e),n=ia(t);let r=t.fu.length>0?t.fu[t.fu.length-1].batchId:-1;for(;Wo(t);)try{const e=await Zi(t.localStore,r);if(null===e){0===t.fu.length&&n.Fo();break}r=e.batchId,Ho(t,e)}catch(e){await Qo(t,e)}Yo(t)&&Xo(t)}function Wo(e){return Uo(e)&&e.fu.length<10}function Ho(e,t){e.fu.push(t);const n=ia(e);n.ko()&&n.Yo&&n.Xo(t.mutations)}function Yo(e){return Uo(e)&&!ia(e).No()&&e.fu.length>0}function Xo(e){ia(e).start()}async function Zo(e){ia(e).eu()}async function Jo(e){const t=ia(e);for(const n of e.fu)t.Xo(n.mutations)}async function ea(e,t,n){const r=e.fu.shift(),s=ls.from(r,t,n);await zo(e,(()=>e.remoteSyncer.applySuccessfulWrite(s))),await jo(e)}async function ta(e,t){t&&ia(e).Yo&&await async function(e,t){if(Rn(n=t.code)&&n!==E.ABORTED){const n=e.fu.shift();ia(e).Mo(),await zo(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await jo(e)}var n}(e,t),Yo(e)&&Xo(e)}async function na(e,t){const n=T(e);n.asyncQueue.verifyOperationInProgress(),g("RemoteStore","RemoteStore received new credentials");const r=Uo(n);n._u.add(3),await Vo(n),r&&n.gu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n._u.delete(3),await Ro(n)}async function ra(e,t){const n=T(e);t?(n._u.delete(2),await Ro(n)):t||(n._u.add(2),await Vo(n),n.gu.set("Unknown"))}function sa(e){return e.pu||(e.pu=function(e,t,n){const r=T(e);return r.su(),new _o(t,r.connection,r.authCredentials,r.appCheckCredentials,r.It,n)}(e.datastore,e.asyncQueue,{Yr:Ko.bind(null,e),Zr:Go.bind(null,e),Wo:$o.bind(null,e)}),e.wu.push((async t=>{t?(e.pu.Mo(),qo(e)?Po(e):e.gu.set("Unknown")):(await e.pu.stop(),Bo(e))}))),e.pu}function ia(e){return e.Iu||(e.Iu=function(e,t,n){const r=T(e);return r.su(),new No(t,r.connection,r.authCredentials,r.appCheckCredentials,r.It,n)}(e.datastore,e.asyncQueue,{Yr:Zo.bind(null,e),Zr:ta.bind(null,e),tu:Jo.bind(null,e),Zo:ea.bind(null,e)}),e.wu.push((async t=>{t?(e.Iu.Mo(),await jo(e)):(await e.Iu.stop(),e.fu.length>0&&(g("RemoteStore",`Stopping write stream with ${e.fu.length} pending writes`),e.fu=[]))}))),e.Iu}class oa{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new x,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,o=new oa(e,t,i,r,s);return o.start(n),o}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new S(E.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function aa(e,t){if(p("AsyncQueue",`${t}: ${e}`),ce(e))return new S(E.UNAVAILABLE,`${t}: ${e}`);throw e}class ua{constructor(e){this.comparator=e?(t,n)=>e(t,n)||Q.comparator(t.key,n.key):(e,t)=>Q.comparator(e.key,t.key),this.keyedMap=Pn(),this.sortedSet=new Ie(this.comparator)}static emptySet(e){return new ua(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof ua))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new ua;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class ca{constructor(){this.Tu=new Ie(Q.comparator)}track(e){const t=e.doc.key,n=this.Tu.get(t);n?0!==e.type&&3===n.type?this.Tu=this.Tu.insert(t,e):3===e.type&&1!==n.type?this.Tu=this.Tu.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Tu=this.Tu.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Tu=this.Tu.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Tu=this.Tu.remove(t):1===e.type&&2===n.type?this.Tu=this.Tu.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Tu=this.Tu.insert(t,{type:2,doc:e.doc}):v():this.Tu=this.Tu.insert(t,e)}Eu(){const e=[];return this.Tu.inorderTraversal(((t,n)=>{e.push(n)})),e}}class la{constructor(e,t,n,r,s,i,o,a,u){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=u}static fromInitialDocuments(e,t,n,r,s){const i=[];return t.forEach((e=>{i.push({type:0,doc:e})})),new la(e,t,ua.emptySet(t),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Gt(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0}}class ha{constructor(){this.Au=void 0,this.listeners=[]}}class da{constructor(){this.queries=new Ln((e=>$t(e)),Gt),this.onlineState="Unknown",this.Ru=new Set}}async function fa(e,t){const n=T(e),r=t.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new ha),s)try{i.Au=await n.onListen(r)}catch(e){const n=aa(e,`Initialization of query '${Qt(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,i),i.listeners.push(t),t.bu(n.onlineState),i.Au&&t.Pu(i.Au)&&ya(n)}async function ma(e,t){const n=T(e),r=t.query;let s=!1;const i=n.queries.get(r);if(i){const e=i.listeners.indexOf(t);e>=0&&(i.listeners.splice(e,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function ga(e,t){const n=T(e);let r=!1;for(const s of t){const e=s.query,t=n.queries.get(e);if(t){for(const e of t.listeners)e.Pu(s)&&(r=!0);t.Au=s}}r&&ya(n)}function pa(e,t,n){const r=T(e),s=r.queries.get(t);if(s)for(const i of s.listeners)i.onError(n);r.queries.delete(t)}function ya(e){e.Ru.forEach((e=>{e.next()}))}class wa{constructor(e,t,n){this.query=e,this.vu=t,this.Vu=!1,this.Su=null,this.onlineState="Unknown",this.options=n||{}}Pu(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new la(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Vu?this.Du(e)&&(this.vu.next(e),t=!0):this.Cu(e,this.onlineState)&&(this.xu(e),t=!0),this.Su=e,t}onError(e){this.vu.error(e)}bu(e){this.onlineState=e;let t=!1;return this.Su&&!this.Vu&&this.Cu(this.Su,e)&&(this.xu(this.Su),t=!0),t}Cu(e,t){if(!e.fromCache)return!0;const n="Offline"!==t;return(!this.options.Nu||!n)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Du(e){if(e.docChanges.length>0)return!0;const t=this.Su&&this.Su.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}xu(e){e=la.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Vu=!0,this.vu.next(e)}}class va{constructor(e,t){this.ku=e,this.byteLength=t}Ou(){return"metadata"in this.ku}}class Ia{constructor(e){this.It=e}Ji(e){return fr(this.It,e)}Yi(e){return e.metadata.exists?vr(this.It,e.document,!1):lt.newNoDocument(this.Ji(e.metadata.name),this.Xi(e.metadata.readTime))}Xi(e){return cr(e)}}class ba{constructor(e,t,n){this.Mu=e,this.localStore=t,this.It=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Ta(e)}Fu(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.ku.namedQuery)this.queries.push(e.ku.namedQuery);else if(e.ku.documentMetadata){this.documents.push({metadata:e.ku.documentMetadata}),e.ku.documentMetadata.exists||++t;const n=K.fromString(e.ku.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.ku.document&&(this.documents[this.documents.length-1].document=e.ku.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}$u(e){const t=new Map,n=new Ia(this.It);for(const r of e)if(r.metadata.queries){const e=n.Ji(r.metadata.name);for(const n of r.metadata.queries){const r=(t.get(n)||Qn()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=T(e);let i=Qn(),o=Fn();for(const c of n){const e=t.Ji(c.metadata.name);c.document&&(i=i.add(e));const n=t.Yi(c);n.setReadTime(t.Xi(c.metadata.readTime)),o=o.insert(e,n)}const a=s.Gi.newChangeBuffer({trackRemovals:!0}),u=await Ji(s,function(e){return Bt(Mt(K.fromString(`__bundle__/docs/${e}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",(e=>Xi(e,a,o).next((t=>(a.apply(e),t))).next((t=>s.Cs.removeMatchingKeysForTargetId(e,u.targetId).next((()=>s.Cs.addMatchingKeys(e,i,u.targetId))).next((()=>s.localDocuments.getLocalViewOfDocuments(e,t.Wi,t.zi))).next((()=>t.Wi))))))}(this.localStore,new Ia(this.It),this.documents,this.Mu.id),t=this.$u(this.documents);for(const n of this.queries)await io(this.localStore,n,t.get(n.name));return this.progress.taskState="Success",{progress:this.progress,Bu:this.collectionGroups,Lu:e}}}function Ta(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class Ea{constructor(e){this.key=e}}class Sa{constructor(e){this.key=e}}class xa{constructor(e,t){this.query=e,this.Uu=t,this.qu=null,this.hasCachedResults=!1,this.current=!1,this.Ku=Qn(),this.mutatedKeys=Qn(),this.Gu=Wt(e),this.Qu=new ua(this.Gu)}get ju(){return this.Uu}Wu(e,t){const n=t?t.zu:new ca,r=t?t.Qu:this.Qu;let s=t?t.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,u="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal(((e,t)=>{const c=r.get(e),l=zt(this.query,t)?t:null,h=!!c&&this.mutatedKeys.has(c.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;c&&l?c.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.Hu(c,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.Gu(l,a)>0||u&&this.Gu(l,u)<0)&&(o=!0)):!c&&l?(n.track({type:0,doc:l}),f=!0):c&&!l&&(n.track({type:1,doc:c}),f=!0,(a||u)&&(o=!0)),f&&(l?(i=i.add(l),s=d?s.add(e):s.delete(e)):(i=i.delete(e),s=s.delete(e)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const e="F"===this.query.limitType?i.last():i.first();i=i.delete(e.key),s=s.delete(e.key),n.track({type:1,doc:e})}return{Qu:i,zu:n,$i:o,mutatedKeys:s}}Hu(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){const r=this.Qu;this.Qu=e.Qu,this.mutatedKeys=e.mutatedKeys;const s=e.zu.Eu();s.sort(((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return v()}};return n(e)-n(t)}(e.type,t.type)||this.Gu(e.doc,t.doc))),this.Ju(n);const i=t?this.Yu():[],o=0===this.Ku.size&&this.current?1:0,a=o!==this.qu;return this.qu=o,0!==s.length||a?{snapshot:new la(this.query,e.Qu,r,s,e.mutatedKeys,0===o,a,!1,!!n&&n.resumeToken.approximateByteSize()>0),Xu:i}:{Xu:i}}bu(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Qu:this.Qu,zu:new ca,mutatedKeys:this.mutatedKeys,$i:!1},!1)):{Xu:[]}}Zu(e){return!this.Uu.has(e)&&!!this.Qu.has(e)&&!this.Qu.get(e).hasLocalMutations}Ju(e){e&&(e.addedDocuments.forEach((e=>this.Uu=this.Uu.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.Uu=this.Uu.delete(e))),this.current=e.current)}Yu(){if(!this.current)return[];const e=this.Ku;this.Ku=Qn(),this.Qu.forEach((e=>{this.Zu(e.key)&&(this.Ku=this.Ku.add(e.key))}));const t=[];return e.forEach((e=>{this.Ku.has(e)||t.push(new Sa(e))})),this.Ku.forEach((n=>{e.has(n)||t.push(new Ea(n))})),t}tc(e){this.Uu=e.Hi,this.Ku=Qn();const t=this.Wu(e.documents);return this.applyChanges(t,!0)}ec(){return la.fromInitialDocuments(this.query,this.Qu,this.mutatedKeys,0===this.qu,this.hasCachedResults)}}class Da{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class _a{constructor(e){this.key=e,this.nc=!1}}class Na{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.sc={},this.ic=new Ln((e=>$t(e)),Gt),this.rc=new Map,this.oc=new Set,this.uc=new Ie(Q.comparator),this.cc=new Map,this.ac=new Ai,this.hc={},this.lc=new Map,this.fc=ii.vn(),this.onlineState="Unknown",this.dc=void 0}get isPrimaryClient(){return!0===this.dc}}async function Aa(e,t){const n=tu(e);let r,s;const i=n.ic.get(t);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.ec();else{const e=await Ji(n.localStore,Bt(t));n.isPrimaryClient&&Lo(n.remoteStore,e);const i=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,s=await Ca(n,t,r,"current"===i,e.resumeToken)}return s}async function Ca(e,t,n,r,s){e._c=(t,n,r)=>async function(e,t,n,r){let s=t.view.Wu(n);s.$i&&(s=await to(e.localStore,t.query,!1).then((({documents:e})=>t.view.Wu(e,s))));const i=r&&r.targetChanges.get(t.targetId),o=t.view.applyChanges(s,e.isPrimaryClient,i);return Ba(e,t.targetId,o.Xu),o.snapshot}(e,t,n,r);const i=await to(e.localStore,t,!0),o=new xa(t,i.Hi),a=o.Wu(i.documents),u=Hn.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,s),c=o.applyChanges(a,e.isPrimaryClient,u);Ba(e,n,c.Xu);const l=new Da(t,n,o);return e.ic.set(t,l),e.rc.has(n)?e.rc.get(n).push(t):e.rc.set(n,[t]),c.snapshot}async function ka(e,t){const n=T(e),r=n.ic.get(t),s=n.rc.get(r.targetId);if(s.length>1)return n.rc.set(r.targetId,s.filter((e=>!Gt(e,t)))),void n.ic.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await eo(n.localStore,r.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(r.targetId),Mo(n.remoteStore,r.targetId),qa(n,r.targetId)})).catch(re)):(qa(n,r.targetId),await eo(n.localStore,r.targetId,!0))}async function Ra(e,t){const n=T(e);try{const e=await function(e,t){const n=T(e),r=t.snapshotVersion;let s=n.Ui;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const i=n.Gi.newChangeBuffer({trackRemovals:!0});s=n.Ui;const o=[];t.targetChanges.forEach(((i,a)=>{const u=s.get(a);if(!u)return;o.push(n.Cs.removeMatchingKeys(e,i.removedDocuments,a).next((()=>n.Cs.addMatchingKeys(e,i.addedDocuments,a))));let c=u.withSequenceNumber(e.currentSequenceNumber);t.targetMismatches.has(a)?c=c.withResumeToken(Ne.EMPTY_BYTE_STRING,U.min()).withLastLimboFreeSnapshotVersion(U.min()):i.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(i.resumeToken,r)),s=s.insert(a,c),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(u,c,i)&&o.push(n.Cs.updateTargetData(e,c))}));let a=Fn(),u=Qn();if(t.documentUpdates.forEach((r=>{t.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))})),o.push(Xi(e,i,t.documentUpdates).next((e=>{a=e.Wi,u=e.zi}))),!r.isEqual(U.min())){const t=n.Cs.getLastRemoteSnapshotVersion(e).next((t=>n.Cs.setTargetsMetadata(e,e.currentSequenceNumber,r)));o.push(t)}return se.waitFor(o).next((()=>i.apply(e))).next((()=>n.localDocuments.getLocalViewOfDocuments(e,a,u))).next((()=>a))})).then((e=>(n.Ui=s,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const r=n.cc.get(t);r&&(I(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?r.nc=!0:e.modifiedDocuments.size>0?I(r.nc):e.removedDocuments.size>0&&(I(r.nc),r.nc=!1))})),await $a(n,e,t)}catch(e){await re(e)}}function Va(e,t,n){const r=T(e);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const e=[];r.ic.forEach(((n,r)=>{const s=r.view.bu(t);s.snapshot&&e.push(s.snapshot)})),function(e,t){const n=T(e);n.onlineState=t;let r=!1;n.queries.forEach(((e,n)=>{for(const s of n.listeners)s.bu(t)&&(r=!0)})),r&&ya(n)}(r.eventManager,t),e.length&&r.sc.Wo(e),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}async function La(e,t,n){const r=T(e);r.sharedClientState.updateQueryState(t,"rejected",n);const s=r.cc.get(t),i=s&&s.key;if(i){let e=new Ie(Q.comparator);e=e.insert(i,lt.newNoDocument(i,U.min()));const n=Qn().add(i),s=new Wn(U.min(),new Map,new Ee(F),e,n);await Ra(r,s),r.uc=r.uc.remove(i),r.cc.delete(t),Ga(r)}else await eo(r.localStore,t,!1).then((()=>qa(r,t,n))).catch(re)}async function Ma(e,t){const n=T(e),r=t.batch.batchId;try{const e=await function(e,t){const n=T(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const r=t.batch.keys(),s=n.Gi.newChangeBuffer({trackRemovals:!0});return function(e,t,n,r){const s=n.batch,i=s.keys();let o=se.resolve();return i.forEach((e=>{o=o.next((()=>r.getEntry(t,e))).next((t=>{const i=n.docVersions.get(e);I(null!==i),t.version.compareTo(i)<0&&(s.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))}))})),o.next((()=>e.mutationQueue.removeMutationBatch(t,s)))}(n,e,t,s).next((()=>s.apply(e))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=Qn();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t)))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(n.localStore,t);Pa(n,r,null),Oa(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await $a(n,e)}catch(e){await re(e)}}async function Fa(e,t,n){const r=T(e);try{const e=await function(e,t){const n=T(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next((t=>(I(null!==t),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t)))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(r.localStore,t);Pa(r,t,n),Oa(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await $a(r,e)}catch(n){await re(n)}}function Oa(e,t){(e.lc.get(t)||[]).forEach((e=>{e.resolve()})),e.lc.delete(t)}function Pa(e,t,n){const r=T(e);let s=r.hc[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.hc[r.currentUser.toKey()]=s}}function qa(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.rc.get(t))e.ic.delete(r),n&&e.sc.wc(r,n);e.rc.delete(t),e.isPrimaryClient&&e.ac.ls(t).forEach((t=>{e.ac.containsKey(t)||Ua(e,t)}))}function Ua(e,t){e.oc.delete(t.path.canonicalString());const n=e.uc.get(t);null!==n&&(Mo(e.remoteStore,n),e.uc=e.uc.remove(t),e.cc.delete(n),Ga(e))}function Ba(e,t,n){for(const r of n)r instanceof Ea?(e.ac.addReference(r.key,t),Ka(e,r)):r instanceof Sa?(g("SyncEngine","Document no longer in limbo: "+r.key),e.ac.removeReference(r.key,t),e.ac.containsKey(r.key)||Ua(e,r.key)):v()}function Ka(e,t){const n=t.key,r=n.path.canonicalString();e.uc.get(n)||e.oc.has(r)||(g("SyncEngine","New document in limbo: "+n),e.oc.add(r),Ga(e))}function Ga(e){for(;e.oc.size>0&&e.uc.size<e.maxConcurrentLimboResolutions;){const t=e.oc.values().next().value;e.oc.delete(t);const n=new Q(K.fromString(t)),r=e.fc.next();e.cc.set(r,new _a(n)),e.uc=e.uc.insert(n,r),Lo(e.remoteStore,new ds(Bt(Mt(n.path)),r,2,pe.at))}}async function $a(e,t,n){const r=T(e),s=[],i=[],o=[];r.ic.isEmpty()||(r.ic.forEach(((e,a)=>{o.push(r._c(a,t,n).then((e=>{if((e||n)&&r.isPrimaryClient&&r.sharedClientState.updateQueryState(a.targetId,(null==e?void 0:e.fromCache)?"not-current":"current"),e){s.push(e);const t=Qi.Ci(a.targetId,e);i.push(t)}})))})),await Promise.all(o),r.sc.Wo(s),await async function(e,t){const n=T(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>se.forEach(t,(t=>se.forEach(t.Si,(r=>n.persistence.referenceDelegate.addReference(e,t.targetId,r))).next((()=>se.forEach(t.Di,(r=>n.persistence.referenceDelegate.removeReference(e,t.targetId,r)))))))))}catch(e){if(!ce(e))throw e;g("LocalStore","Failed to update sequence numbers: "+e)}for(const r of t){const e=r.targetId;if(!r.fromCache){const t=n.Ui.get(e),r=t.snapshotVersion,s=t.withLastLimboFreeSnapshotVersion(r);n.Ui=n.Ui.insert(e,s)}}}(r.localStore,i))}async function Qa(e,t){const n=T(e);if(!n.currentUser.isEqual(t)){g("SyncEngine","User change. New user:",t.toKey());const e=await Hi(n.localStore,t);n.currentUser=t,function(e,t){e.lc.forEach((e=>{e.forEach((e=>{e.reject(new S(E.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),e.lc.clear()}(n),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await $a(n,e.ji)}}function za(e,t){const n=T(e),r=n.cc.get(t);if(r&&r.nc)return Qn().add(r.key);{let e=Qn();const r=n.rc.get(t);if(!r)return e;for(const t of r){const r=n.ic.get(t);e=e.unionWith(r.view.ju)}return e}}async function ja(e,t){const n=T(e),r=await to(n.localStore,t.query,!0),s=t.view.tc(r);return n.isPrimaryClient&&Ba(n,t.targetId,s.Xu),s}async function Wa(e,t){const n=T(e);return ro(n.localStore,t).then((e=>$a(n,e)))}async function Ha(e,t,n,r){const s=T(e),i=await function(e,t){const n=T(e),r=T(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(e=>r.Tn(e,t).next((t=>t?n.localDocuments.getDocuments(e,t):se.resolve(null)))))}(s.localStore,t);null!==i?("pending"===n?await jo(s.remoteStore):"acknowledged"===n||"rejected"===n?(Pa(s,t,r||null),Oa(s,t),function(e,t){T(T(e).mutationQueue).An(t)}(s.localStore,t)):v(),await $a(s,i)):g("SyncEngine","Cannot apply mutation batch with id: "+t)}async function Ya(e,t,n){const r=T(e),s=[],i=[];for(const o of t){let e;const t=r.rc.get(o);if(t&&0!==t.length){e=await Ji(r.localStore,Bt(t[0]));for(const e of t){const t=r.ic.get(e),n=await ja(r,t);n.snapshot&&i.push(n.snapshot)}}else{const t=await no(r.localStore,o);e=await Ji(r.localStore,t),await Ca(r,Xa(t),o,!1,e.resumeToken)}s.push(e)}return r.sc.Wo(i),s}function Xa(e){return Lt(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Za(e){const t=T(e);return T(T(t.localStore).persistence).vi()}async function Ja(e,t,n,r){const s=T(e);if(s.dc)return void g("SyncEngine","Ignoring unexpected query state notification.");const i=s.rc.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{const e=await ro(s.localStore,jt(i[0])),r=Wn.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,Ne.EMPTY_BYTE_STRING);await $a(s,e,r);break}case"rejected":await eo(s.localStore,t,!0),qa(s,t,r);break;default:v()}}async function eu(e,t,n){const r=tu(e);if(r.dc){for(const e of t){if(r.rc.has(e)){g("SyncEngine","Adding an already active target "+e);continue}const t=await no(r.localStore,e),n=await Ji(r.localStore,t);await Ca(r,Xa(t),n.targetId,!1,n.resumeToken),Lo(r.remoteStore,n)}for(const e of n)r.rc.has(e)&&await eo(r.localStore,e,!1).then((()=>{Mo(r.remoteStore,e),qa(r,e)})).catch(re)}}function tu(e){const t=T(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=Ra.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=za.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=La.bind(null,t),t.sc.Wo=ga.bind(null,t.eventManager),t.sc.wc=pa.bind(null,t.eventManager),t}function nu(e){const t=T(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=Ma.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=Fa.bind(null,t),t}class ru{constructor(){this.synchronizeTabs=!1}async initialize(e){this.It=So(e.databaseInfo.databaseId),this.sharedClientState=this.gc(e),this.persistence=this.yc(e),await this.persistence.start(),this.localStore=this.Ic(e),this.gcScheduler=this.Tc(e,this.localStore),this.indexBackfillerScheduler=this.Ec(e,this.localStore)}Tc(e,t){return null}Ec(e,t){return null}Ic(e){return Wi(this.persistence,new zi,e.initialUser,this.It)}yc(e){return new Mi(Oi.Bs,this.It)}gc(e){return new po}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class su extends ru{constructor(e,t,n){super(),this.Ac=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Ac.initialize(this,e),await nu(this.Ac.syncEngine),await jo(this.Ac.remoteStore),await this.persistence.li((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}Ic(e){return Wi(this.persistence,new zi,e.initialUser,this.It)}Tc(e,t){const n=this.persistence.referenceDelegate.garbageCollector;return new di(n,e.asyncQueue,t)}Ec(e,t){const n=new ge(t,this.persistence);return new me(e.asyncQueue,n)}yc(e){const t=$i(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Xs.withCacheSize(this.cacheSizeBytes):Xs.DEFAULT;return new Bi(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,To(),Eo(),this.It,this.sharedClientState,!!this.forceOwnership)}gc(e){return new po}}class iu extends su{constructor(e,t){super(e,t,!1),this.Ac=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);const t=this.Ac.syncEngine;this.sharedClientState instanceof go&&(this.sharedClientState.syncEngine={Fr:Ha.bind(null,t),$r:Ja.bind(null,t),Br:eu.bind(null,t),vi:Za.bind(null,t),Mr:Wa.bind(null,t)},await this.sharedClientState.start()),await this.persistence.li((async e=>{await async function(e,t){const n=T(e);if(tu(n),nu(n),!0===t&&!0!==n.dc){const e=n.sharedClientState.getAllActiveQueryTargets(),t=await Ya(n,e.toArray());n.dc=!0,await ra(n.remoteStore,!0);for(const r of t)Lo(n.remoteStore,r)}else if(!1===t&&!1!==n.dc){const e=[];let t=Promise.resolve();n.rc.forEach(((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?e.push(s):t=t.then((()=>(qa(n,s),eo(n.localStore,s,!0)))),Mo(n.remoteStore,s)})),await t,await Ya(n,e),function(e){const t=T(e);t.cc.forEach(((e,n)=>{Mo(t.remoteStore,n)})),t.ac.fs(),t.cc=new Map,t.uc=new Ie(Q.comparator)}(n),n.dc=!1,await ra(n.remoteStore,!1)}}(this.Ac.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())}))}gc(e){const t=To();if(!go.C(t))throw new S(E.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=$i(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new go(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class ou{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Va(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=Qa.bind(null,this.syncEngine),await ra(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new da}createDatastore(e){const t=So(e.databaseInfo.databaseId),n=(r=e.databaseInfo,new bo(r));var r;return function(e,t,n,r){return new Ao(e,t,n,r)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,s=e=>Va(this.syncEngine,e,0),i=wo.C()?new wo:new yo,new ko(t,n,r,s,i);var t,n,r,s,i}createSyncEngine(e,t){return function(e,t,n,r,s,i,o){const a=new Na(e,t,n,r,s,i);return o&&(a.dc=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=T(e);g("RemoteStore","RemoteStore shutting down."),t._u.add(5),await Vo(t),t.mu.shutdown(),t.gu.set("Unknown")}(this.remoteStore)}}function au(e,t,n){if(!n)throw new S(E.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function uu(e,t,n,r){if(!0===t&&!0===r)throw new S(E.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function cu(e){if(!Q.isDocumentKey(e))throw new S(E.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function lu(e){if(Q.isDocumentKey(e))throw new S(E.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function hu(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":v()}function du(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new S(E.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=hu(e);throw new S(E.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function fu(e,t){if(t<=0)throw new S(E.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}const mu=new Map;class gu{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new S(E.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new S(E.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.useFetchStreams=!!e.useFetchStreams,uu("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling)}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class pu{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new gu({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new S(E.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new S(E.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new gu(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new _;switch(e.type){case"gapi":const t=e.client;return new k(t,e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new S(E.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=mu.get(e);t&&(g("ComponentProvider","Removing Datastore"),mu.delete(e),t.terminate())}(this),Promise.resolve()}}function yu(e,t,n,r={}){var s;const i=(e=du(e,pu))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==t&&y("Host has been set in both settings() and useEmulator(), emulator host will be used"),e._setSettings(Object.assign(Object.assign({},i),{host:`${t}:${n}`,ssl:!1})),r.mockUserToken){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=l.MOCK_USER;else{t=(0,o.Sg)(r.mockUserToken,null===(s=e._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new S(E.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new l(i)}e._authCredentials=new N(new D(t,n))}}class wu{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Iu(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new wu(this.firestore,e,this._key)}}class vu{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new vu(this.firestore,e,this._query)}}class Iu extends vu{constructor(e,t,n){super(e,t,Mt(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new wu(this.firestore,null,new Q(e))}withConverter(e){return new Iu(this.firestore,e,this._path)}}function bu(e,t,...n){if(e=(0,o.m9)(e),au("collection","path",t),e instanceof pu){const r=K.fromString(t,...n);return lu(r),new Iu(e,null,r)}{if(!(e instanceof wu||e instanceof Iu))throw new S(E.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(K.fromString(t,...n));return lu(r),new Iu(e.firestore,null,r)}}function Tu(e,t){if(e=du(e,pu),au("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new S(E.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new vu(e,null,function(e){return new Vt(K.emptyPath(),e)}(t))}function Eu(e,t,...n){if(e=(0,o.m9)(e),1===arguments.length&&(t=M.R()),au("doc","path",t),e instanceof pu){const r=K.fromString(t,...n);return cu(r),new wu(e,null,new Q(r))}{if(!(e instanceof wu||e instanceof Iu))throw new S(E.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(K.fromString(t,...n));return cu(r),new wu(e.firestore,e instanceof Iu?e.converter:null,new Q(r))}}function Su(e,t){return e=(0,o.m9)(e),t=(0,o.m9)(t),(e instanceof wu||e instanceof Iu)&&(t instanceof wu||t instanceof Iu)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function xu(e,t){return e=(0,o.m9)(e),t=(0,o.m9)(t),e instanceof vu&&t instanceof vu&&e.firestore===t.firestore&&Gt(e._query,t._query)&&e.converter===t.converter}function Du(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){const r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class _u{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Rc(this.observer.next,e)}error(e){this.observer.error?this.Rc(this.observer.error,e):p("Uncaught Error in snapshot listener:",e)}bc(){this.muted=!0}Rc(e,t){this.muted||setTimeout((()=>{this.muted||e(t)}),0)}}class Nu{constructor(e,t){this.Pc=e,this.It=t,this.metadata=new x,this.buffer=new Uint8Array,this.vc=new TextDecoder("utf-8"),this.Vc().then((e=>{e&&e.Ou()?this.metadata.resolve(e.ku.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.ku)}`))}),(e=>this.metadata.reject(e)))}close(){return this.Pc.cancel()}async getMetadata(){return this.metadata.promise}async mc(){return await this.getMetadata(),this.Vc()}async Vc(){const e=await this.Sc();if(null===e)return null;const t=this.vc.decode(e),n=Number(t);isNaN(n)&&this.Dc(`length string (${t}) is not valid number`);const r=await this.Cc(n);return new va(JSON.parse(r),e.length+n)}xc(){return this.buffer.findIndex((e=>e==="{".charCodeAt(0)))}async Sc(){for(;this.xc()<0&&!(await this.Nc()););if(0===this.buffer.length)return null;const e=this.xc();e<0&&this.Dc("Reached the end of bundle when a length string is expected.");const t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async Cc(e){for(;this.buffer.length<e;)await this.Nc()&&this.Dc("Reached the end of bundle when more is expected.");const t=this.vc.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Dc(e){throw this.Pc.cancel(),new Error(`Invalid bundle format: ${e}`)}async Nc(){const e=await this.Pc.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class Au{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new S(E.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const n=T(e),r=pr(n.It)+"/documents",s={documents:t.map((e=>dr(n.It,e)))},i=await n._o("BatchGetDocuments",r,s,t.length),o=new Map;i.forEach((e=>{const t=function(e,t){return"found"in t?function(e,t){I(!!t.found),t.found.name,t.found.updateTime;const n=fr(e,t.found.name),r=cr(t.found.updateTime),s=new ut({mapValue:{fields:t.found.fields}});return lt.newFoundDocument(n,r,s)}(e,t):"missing"in t?function(e,t){I(!!t.missing),I(!!t.readTime);const n=fr(e,t.missing),r=cr(t.readTime);return lt.newNoDocument(n,r)}(e,t):v()}(n.It,e);o.set(t.key.toString(),t)}));const a=[];return t.forEach((e=>{const t=o.get(e.toString());I(!!t),a.push(t)})),a}(this.datastore,e);return t.forEach((e=>this.recordVersion(e))),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new _n(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const e=this.readVersions;this.mutations.forEach((t=>{e.delete(t.key.toString())})),e.forEach(((e,t)=>{const n=Q.fromPath(t);this.mutations.push(new Nn(n,this.precondition(n)))})),await async function(e,t){const n=T(e),r=pr(n.It)+"/documents",s={writes:t.map((e=>Ir(n.It,e)))};await n.ao("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw v();t=U.min()}const n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new S(E.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(U.min())?mn.exists(!1):mn.updateTime(t):mn.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(U.min()))throw new S(E.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return mn.updateTime(t)}return mn.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class Cu{constructor(e,t,n,r,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=s,this.kc=n.maxAttempts,this.xo=new xo(this.asyncQueue,"transaction_retry")}run(){this.kc-=1,this.Oc()}Oc(){this.xo.Ro((async()=>{const e=new Au(this.datastore),t=this.Mc(e);t&&t.then((t=>{this.asyncQueue.enqueueAndForget((()=>e.commit().then((()=>{this.deferred.resolve(t)})).catch((e=>{this.Fc(e)}))))})).catch((e=>{this.Fc(e)}))}))}Mc(e){try{const t=this.updateFunction(e);return!Pe(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Fc(e){this.kc>0&&this.$c(e)?(this.kc-=1,this.asyncQueue.enqueueAndForget((()=>(this.Oc(),Promise.resolve())))):this.deferred.reject(e)}$c(e){if("FirebaseError"===e.name){const t=e.code;return"aborted"===t||"failed-precondition"===t||!Rn(t)}return!1}}class ku{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=l.UNAUTHENTICATED,this.clientId=M.R(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async e=>{g("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>(g("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new S(E.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const e=new x;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=aa(t,"Failed to shutdown persistence");e.reject(n)}})),e.promise}}async function Ru(e,t){e.asyncQueue.verifyOperationInProgress(),g("FirestoreClient","Initializing OfflineComponentProvider");const n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener((async e=>{r.isEqual(e)||(await Hi(t.localStore,e),r=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e.offlineComponents=t}async function Vu(e,t){e.asyncQueue.verifyOperationInProgress();const n=await Lu(e);g("FirestoreClient","Initializing OnlineComponentProvider");const r=await e.getConfiguration();await t.initialize(n,r),e.setCredentialChangeListener((e=>na(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>na(t.remoteStore,n))),e.onlineComponents=t}async function Lu(e){return e.offlineComponents||(g("FirestoreClient","Using default OfflineComponentProvider"),await Ru(e,new ru)),e.offlineComponents}async function Mu(e){return e.onlineComponents||(g("FirestoreClient","Using default OnlineComponentProvider"),await Vu(e,new ou)),e.onlineComponents}function Fu(e){return Lu(e).then((e=>e.persistence))}function Ou(e){return Lu(e).then((e=>e.localStore))}function Pu(e){return Mu(e).then((e=>e.remoteStore))}function qu(e){return Mu(e).then((e=>e.syncEngine))}function Uu(e){return Mu(e).then((e=>e.datastore))}async function Bu(e){const t=await Mu(e),n=t.eventManager;return n.onListen=Aa.bind(null,t.syncEngine),n.onUnlisten=ka.bind(null,t.syncEngine),n}function Ku(e,t,n={}){const r=new x;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new _u({next:i=>{t.enqueueAndForget((()=>ma(e,o)));const a=i.docs.has(n);!a&&i.fromCache?s.reject(new S(E.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&r&&"server"===r.source?s.reject(new S(E.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(i)},error:e=>s.reject(e)}),o=new wa(Mt(n.path),i,{includeMetadataChanges:!0,Nu:!0});return fa(e,o)}(await Bu(e),e.asyncQueue,t,n,r))),r.promise}function Gu(e,t,n={}){const r=new x;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new _u({next:n=>{t.enqueueAndForget((()=>ma(e,o))),n.fromCache&&"server"===r.source?s.reject(new S(E.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:e=>s.reject(e)}),o=new wa(n,i,{includeMetadataChanges:!0,Nu:!0});return fa(e,o)}(await Bu(e),e.asyncQueue,t,n,r))),r.promise}function $u(e,t,n,r){const s=function(e,t){let n;return n="string"==typeof e?(new TextEncoder).encode(e):e,function(e,t){return new Nu(e,t)}(function(e,t){if(e instanceof Uint8Array)return Du(e,t);if(e instanceof ArrayBuffer)return Du(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),t)}(n,So(t));e.asyncQueue.enqueueAndForget((async()=>{!function(e,t,n){const r=T(e);(async function(e,t,n){try{const r=await t.getMetadata();if(await function(e,t){const n=T(e),r=cr(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(e=>n.Ns.getBundleMetadata(e,t.id))).then((e=>!!e&&e.createTime.compareTo(r)>=0))}(e.localStore,r))return await t.close(),n._completeWith(function(e){return{taskState:"Success",documentsLoaded:e.totalDocuments,bytesLoaded:e.totalBytes,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}(r)),Promise.resolve(new Set);n._updateProgress(Ta(r));const s=new ba(r,e.localStore,t.It);let i=await t.mc();for(;i;){const e=await s.Fu(i);e&&n._updateProgress(e),i=await t.mc()}const o=await s.complete();return await $a(e,o.Lu,void 0),await function(e,t){const n=T(e);return n.persistence.runTransaction("Save bundle","readwrite",(e=>n.Ns.saveBundleMetadata(e,t)))}(e.localStore,r),n._completeWith(o.progress),Promise.resolve(o.Bu)}catch(e){return y("SyncEngine",`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(r,t,n).then((e=>{r.sharedClientState.notifyBundleLoaded(e)}))}(await qu(e),s,r)}))}class Qu{constructor(){this.Bc=Promise.resolve(),this.Lc=[],this.Uc=!1,this.qc=[],this.Kc=null,this.Gc=!1,this.Qc=!1,this.jc=[],this.xo=new xo(this,"async_queue_retry"),this.Wc=()=>{const e=Eo();e&&g("AsyncQueue","Visibility state changed to "+e.visibilityState),this.xo.Po()};const e=Eo();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Wc)}get isShuttingDown(){return this.Uc}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.zc(),this.Hc(e)}enterRestrictedMode(e){if(!this.Uc){this.Uc=!0,this.Qc=e||!1;const t=Eo();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Wc)}}enqueue(e){if(this.zc(),this.Uc)return new Promise((()=>{}));const t=new x;return this.Hc((()=>this.Uc&&this.Qc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.Lc.push(e),this.Jc())))}async Jc(){if(0!==this.Lc.length){try{await this.Lc[0](),this.Lc.shift(),this.xo.reset()}catch(e){if(!ce(e))throw e;g("AsyncQueue","Operation failed with retryable error: "+e)}this.Lc.length>0&&this.xo.Ro((()=>this.Jc()))}}Hc(e){const t=this.Bc.then((()=>(this.Gc=!0,e().catch((e=>{this.Kc=e,this.Gc=!1;throw p("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e)),e})).then((e=>(this.Gc=!1,e))))));return this.Bc=t,t}enqueueAfterDelay(e,t,n){this.zc(),this.jc.indexOf(e)>-1&&(t=0);const r=oa.createAndSchedule(this,e,t,n,(e=>this.Yc(e)));return this.qc.push(r),r}zc(){this.Kc&&v()}verifyOperationInProgress(){}async Xc(){let e;do{e=this.Bc,await e}while(e!==this.Bc)}Zc(e){for(const t of this.qc)if(t.timerId===e)return!0;return!1}ta(e){return this.Xc().then((()=>{this.qc.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this.qc)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Xc()}))}ea(e){this.jc.push(e)}Yc(e){const t=this.qc.indexOf(e);this.qc.splice(t,1)}}function zu(e){return function(e,t){if("object"!=typeof e||null===e)return!1;const n=e;for(const r of["next","error","complete"])if(r in n&&"function"==typeof n[r])return!0;return!1}(e)}class ju{constructor(){this._progressObserver={},this._taskCompletionResolver=new x,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}const Wu=-1;class Hu extends pu{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new Qu,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||Xu(this),this._firestoreClient.terminate()}}function Yu(e){return e._firestoreClient||Xu(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Xu(e){var t;const n=e._freezeSettings(),r=function(e,t,n,r){return new Fe(e,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,r.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,n);e._firestoreClient=new ku(e._authCredentials,e._appCheckCredentials,e._queue,r)}function Zu(e,t){ac(e=du(e,Hu));const n=Yu(e),r=e._freezeSettings(),s=new ou;return ec(n,s,new su(s,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}function Ju(e){ac(e=du(e,Hu));const t=Yu(e),n=e._freezeSettings(),r=new ou;return ec(t,r,new iu(r,n.cacheSizeBytes))}function ec(e,t,n){const r=new x;return e.asyncQueue.enqueue((async()=>{try{await Ru(e,n),await Vu(e,t),r.resolve()}catch(e){const n=e;if(!function(e){return"FirebaseError"===e.name?e.code===E.FAILED_PRECONDITION||e.code===E.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||(22===e.code||20===e.code||11===e.code)}(n))throw n;y("Error enabling offline persistence. Falling back to persistence disabled: "+n),r.reject(n)}})).then((()=>r.promise))}function tc(e){if(e._initialized&&!e._terminated)throw new S(E.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new x;return e._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(e){if(!oe.C())return Promise.resolve();const t=e+"main";await oe.delete(t)}($i(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}})),t.promise}function nc(e){return function(e){const t=new x;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t){const n=T(e);Uo(n.remoteStore)||g("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(e){const t=T(e);return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e)))}(n.localStore);if(-1===e)return void t.resolve();const r=n.lc.get(e)||[];r.push(t),n.lc.set(e,r)}catch(e){const n=aa(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await qu(e),t))),t.promise}(Yu(e=du(e,Hu)))}function rc(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await Fu(e),n=await Pu(e);return t.setNetworkEnabled(!0),function(e){const t=T(e);return t._u.delete(0),Ro(t)}(n)}))}(Yu(e=du(e,Hu)))}function sc(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await Fu(e),n=await Pu(e);return t.setNetworkEnabled(!1),async function(e){const t=T(e);t._u.add(0),await Vo(t),t.gu.set("Offline")}(n)}))}(Yu(e=du(e,Hu)))}function ic(e,t){const n=Yu(e=du(e,Hu)),r=new ju;return $u(n,e._databaseId,t,r),r}function oc(e,t){return function(e,t){return e.asyncQueue.enqueue((async()=>function(e,t){const n=T(e);return n.persistence.runTransaction("Get named query","readonly",(e=>n.Ns.getNamedQuery(e,t)))}(await Ou(e),t)))}(Yu(e=du(e,Hu)),t).then((t=>t?new vu(e,null,t.query):null))}function ac(e){if(e._initialized||e._terminated)throw new S(E.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class uc{constructor(e){this._byteString=e}static fromBase64String(e){try{return new uc(Ne.fromBase64String(e))}catch(e){throw new S(E.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new uc(Ne.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class cc{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new S(E.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new $(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class lc{constructor(e){this._methodName=e}}class hc{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new S(E.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new S(E.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return F(this._lat,e._lat)||F(this._long,e._long)}}const dc=/^__.*__$/;class fc{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new En(e,this.data,this.fieldMask,t,this.fieldTransforms):new Tn(e,this.data,t,this.fieldTransforms)}}class mc{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new En(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function gc(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw v()}}class pc{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.It=n,this.ignoreUndefinedProperties=r,void 0===s&&this.na(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get sa(){return this.settings.sa}ia(e){return new pc(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.It,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ra(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ia({path:n,oa:!1});return r.ua(e),r}ca(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ia({path:n,oa:!1});return r.na(),r}aa(e){return this.ia({path:void 0,oa:!0})}ha(e){return Fc(e,this.settings.methodName,this.settings.la||!1,this.path,this.settings.fa)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}na(){if(this.path)for(let e=0;e<this.path.length;e++)this.ua(this.path.get(e))}ua(e){if(0===e.length)throw this.ha("Document fields must not be empty");if(gc(this.sa)&&dc.test(e))throw this.ha('Document fields cannot begin and end with "__"')}}class yc{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.It=n||So(e)}da(e,t,n,r=!1){return new pc({sa:e,methodName:t,fa:n,path:$.emptyPath(),oa:!1,la:r},this.databaseId,this.It,this.ignoreUndefinedProperties)}}function wc(e){const t=e._freezeSettings(),n=So(e._databaseId);return new yc(e._databaseId,!!t.ignoreUndefinedProperties,n)}function vc(e,t,n,r,s,i={}){const o=e.da(i.merge||i.mergeFields?2:0,t,n,s);Rc("Data must be an object, but it was:",o,r);const a=Cc(r,o);let u,c;if(i.merge)u=new De(o.fieldMask),c=o.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=Vc(t,r,n);if(!o.contains(s))throw new S(E.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);Oc(e,s)||e.push(s)}u=new De(e),c=o.fieldTransforms.filter((e=>u.covers(e.field)))}else u=null,c=o.fieldTransforms;return new fc(new ut(a),u,c)}class Ic extends lc{_toFieldTransform(e){if(2!==e.sa)throw 1===e.sa?e.ha(`${this._methodName}() can only appear at the top level of your update data`):e.ha(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof Ic}}function bc(e,t,n){return new pc({sa:3,fa:t.settings.fa,methodName:e._methodName,oa:n},t.databaseId,t.It,t.ignoreUndefinedProperties)}class Tc extends lc{_toFieldTransform(e){return new dn(e.path,new rn)}isEqual(e){return e instanceof Tc}}class Ec extends lc{constructor(e,t){super(e),this._a=t}_toFieldTransform(e){const t=bc(this,e,!0),n=this._a.map((e=>Ac(e,t))),r=new sn(n);return new dn(e.path,r)}isEqual(e){return this===e}}class Sc extends lc{constructor(e,t){super(e),this._a=t}_toFieldTransform(e){const t=bc(this,e,!0),n=this._a.map((e=>Ac(e,t))),r=new an(n);return new dn(e.path,r)}isEqual(e){return this===e}}class xc extends lc{constructor(e,t){super(e),this.wa=t}_toFieldTransform(e){const t=new cn(e.It,Zt(e.It,this.wa));return new dn(e.path,t)}isEqual(e){return this===e}}function Dc(e,t,n,r){const s=e.da(1,t,n);Rc("Data must be an object, but it was:",s,r);const i=[],a=ut.empty();we(r,((e,r)=>{const u=Mc(t,e,n);r=(0,o.m9)(r);const c=s.ca(u);if(r instanceof Ic)i.push(u);else{const e=Ac(r,c);null!=e&&(i.push(u),a.set(u,e))}}));const u=new De(i);return new mc(a,u,s.fieldTransforms)}function _c(e,t,n,r,s,i){const a=e.da(1,t,n),u=[Vc(t,r,n)],c=[s];if(i.length%2!=0)throw new S(E.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let o=0;o<i.length;o+=2)u.push(Vc(t,i[o])),c.push(i[o+1]);const l=[],h=ut.empty();for(let f=u.length-1;f>=0;--f)if(!Oc(l,u[f])){const e=u[f];let t=c[f];t=(0,o.m9)(t);const n=a.ca(e);if(t instanceof Ic)l.push(e);else{const r=Ac(t,n);null!=r&&(l.push(e),h.set(e,r))}}const d=new De(l);return new mc(h,d,a.fieldTransforms)}function Nc(e,t,n,r=!1){return Ac(n,e.da(r?4:3,t))}function Ac(e,t){if(kc(e=(0,o.m9)(e)))return Rc("Unsupported field value:",t,e),Cc(e,t);if(e instanceof lc)return function(e,t){if(!gc(t.sa))throw t.ha(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.ha(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.oa&&4!==t.sa)throw t.ha("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const s of e){let e=Ac(s,t.aa(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=(0,o.m9)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return Zt(t.It,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=q.fromDate(e);return{timestampValue:or(t.It,n)}}if(e instanceof q){const n=new q(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:or(t.It,n)}}if(e instanceof hc)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof uc)return{bytesValue:ar(t.It,e._byteString)};if(e instanceof wu){const n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.ha(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:lr(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.ha(`Unsupported field value: ${hu(e)}`)}(e,t)}function Cc(e,t){const n={};return ve(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):we(e,((e,r)=>{const s=Ac(r,t.ra(e));null!=s&&(n[e]=s)})),{mapValue:{fields:n}}}function kc(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof q||e instanceof hc||e instanceof uc||e instanceof wu||e instanceof lc)}function Rc(e,t,n){if(!kc(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const r=hu(n);throw"an object"===r?t.ha(e+" a custom object"):t.ha(e+" "+r)}}function Vc(e,t,n){if((t=(0,o.m9)(t))instanceof cc)return t._internalPath;if("string"==typeof t)return Mc(e,t);throw Fc("Field path arguments must be of type string or ",e,!1,void 0,n)}const Lc=new RegExp("[~\\*/\\[\\]]");function Mc(e,t,n){if(t.search(Lc)>=0)throw Fc(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new cc(...t.split("."))._internalPath}catch(r){throw Fc(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function Fc(e,t,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(i||o)&&(u+=" (found",i&&(u+=` in field ${r}`),o&&(u+=` in document ${s}`),u+=")"),new S(E.INVALID_ARGUMENT,a+e+u)}function Oc(e,t){return e.some((e=>e.isEqual(t)))}class Pc{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new wu(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new qc(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(Uc("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class qc extends Pc{data(){return super.data()}}function Uc(e,t){return"string"==typeof t?Mc(e,t):t instanceof cc?t._internalPath:t._delegate._internalPath}function Bc(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new S(E.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Kc{}function Gc(e,...t){for(const n of t)e=n._apply(e);return e}class $c extends Kc{constructor(e,t,n){super(),this.ma=e,this.ga=t,this.ya=n,this.type="where"}_apply(e){const t=wc(e.firestore),n=function(e,t,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new S(E.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){il(o,i);const t=[];for(const n of o)t.push(sl(r,e,n));a={arrayValue:{values:t}}}else a=sl(r,e,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||il(o,i),a=Nc(n,"where",o,"in"===i||"not-in"===i);const u=vt.create(s,i,a);return function(e,t){if(t.dt()){const n=Pt(e);if(null!==n&&!n.isEqual(t.field))throw new S(E.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${t.field.toString()}'`);const r=Ot(e);null!==r&&ol(e,t.field,r)}const n=function(e,t){for(const n of e.filters)if(t.indexOf(n.op)>=0)return n.op;return null}(e,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new S(E.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new S(E.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}(e,u),u}(e._query,0,t,e.firestore._databaseId,this.ma,this.ga,this.ya);return new vu(e.firestore,e.converter,function(e,t){const n=e.filters.concat([t]);return new Vt(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}(e._query,n))}}function Qc(e,t,n){const r=t,s=Uc("where",e);return new $c(s,r,n)}class zc extends Kc{constructor(e,t){super(),this.ma=e,this.pa=t,this.type="orderBy"}_apply(e){const t=function(e,t,n){if(null!==e.startAt)throw new S(E.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new S(E.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const r=new At(t,n);return function(e,t){if(null===Ot(e)){const n=Pt(e);null!==n&&ol(e,n,t.field)}}(e,r),r}(e._query,this.ma,this.pa);return new vu(e.firestore,e.converter,function(e,t){const n=e.explicitOrderBy.concat([t]);return new Vt(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}function jc(e,t="asc"){const n=t,r=Uc("orderBy",e);return new zc(r,n)}class Wc extends Kc{constructor(e,t,n){super(),this.type=e,this.Ia=t,this.Ta=n}_apply(e){return new vu(e.firestore,e.converter,Kt(e._query,this.Ia,this.Ta))}}function Hc(e){return fu("limit",e),new Wc("limit",e,"F")}function Yc(e){return fu("limitToLast",e),new Wc("limitToLast",e,"L")}class Xc extends Kc{constructor(e,t,n){super(),this.type=e,this.Ea=t,this.Aa=n}_apply(e){const t=rl(e,this.type,this.Ea,this.Aa);return new vu(e.firestore,e.converter,function(e,t){return new Vt(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)}(e._query,t))}}function Zc(...e){return new Xc("startAt",e,!0)}function Jc(...e){return new Xc("startAfter",e,!1)}class el extends Kc{constructor(e,t,n){super(),this.type=e,this.Ea=t,this.Aa=n}_apply(e){const t=rl(e,this.type,this.Ea,this.Aa);return new vu(e.firestore,e.converter,function(e,t){return new Vt(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)}(e._query,t))}}function tl(...e){return new el("endBefore",e,!1)}function nl(...e){return new el("endAt",e,!0)}function rl(e,t,n,r){if(n[0]=(0,o.m9)(n[0]),n[0]instanceof Pc)return function(e,t,n,r,s){if(!r)throw new S(E.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const o of Ut(e))if(o.field.isKeyField())i.push(Ye(t,r.key));else{const e=r.data.field(o.field);if(Ve(e))throw new S(E.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+o.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=o.field.canonicalString();throw new S(E.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new Nt(i,s)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{const s=wc(e.firestore);return function(e,t,n,r,s,i){const o=e.explicitOrderBy;if(s.length>o.length)throw new S(E.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let u=0;u<s.length;u++){const i=s[u];if(o[u].field.isKeyField()){if("string"!=typeof i)throw new S(E.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof i}`);if(!qt(e)&&-1!==i.indexOf("/"))throw new S(E.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${i}' contains a slash.`);const n=e.path.child(K.fromString(i));if(!Q.isDocumentKey(n))throw new S(E.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new Q(n);a.push(Ye(t,s))}else{const e=Nc(n,r,i);a.push(e)}}return new Nt(a,i)}(e._query,e.firestore._databaseId,s,t,n,r)}}function sl(e,t,n){if("string"==typeof(n=(0,o.m9)(n))){if(""===n)throw new S(E.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!qt(t)&&-1!==n.indexOf("/"))throw new S(E.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=t.path.child(K.fromString(n));if(!Q.isDocumentKey(r))throw new S(E.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Ye(e,new Q(r))}if(n instanceof wu)return Ye(e,n._key);throw new S(E.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${hu(n)}.`)}function il(e,t){if(!Array.isArray(e)||0===e.length)throw new S(E.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`);if(e.length>10)throw new S(E.INVALID_ARGUMENT,`Invalid Query. '${t.toString()}' filters support a maximum of 10 elements in the value array.`)}function ol(e,t,n){if(!n.isEqual(t))throw new S(E.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class al{convertValue(e,t="none"){switch(Ge(e)){case 0:return null;case 1:return e.booleanValue;case 2:return ke(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Re(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw v()}}convertObject(e,t){const n={};return we(e.fields,((e,r)=>{n[e]=this.convertValue(r,t)})),n}convertGeoPoint(e){return new hc(ke(e.latitude),ke(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const n=Le(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Me(e));default:return null}}convertTimestamp(e){const t=Ce(e);return new q(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=K.fromString(e);I(Vr(n));const r=new Oe(n.get(1),n.get(3)),s=new Q(n.popFirst(5));return r.isEqual(t)||p(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function ul(e,t,n){let r;return r=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,r}class cl extends al{constructor(e){super(),this.firestore=e}convertBytes(e){return new uc(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new wu(this.firestore,null,t)}}class ll{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class hl extends Pc{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new dl(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(Uc("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class dl extends hl{data(e={}){return super.data(e)}}class fl{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new ll(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach((t=>e.push(t))),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach((n=>{e.call(t,new dl(this._firestore,this._userDataWriter,n.key,n,new ll(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new S(E.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map((n=>{const r=new dl(e._firestore,e._userDataWriter,n.doc.key,n.doc,new ll(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}}))}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((e=>t||3!==e.type)).map((t=>{const r=new dl(e._firestore,e._userDataWriter,t.doc.key,t.doc,new ll(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let s=-1,i=-1;return 0!==t.type&&(s=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),i=n.indexOf(t.doc.key)),{type:ml(t.type),doc:r,oldIndex:s,newIndex:i}}))}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function ml(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return v()}}function gl(e,t){return e instanceof hl&&t instanceof hl?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof fl&&t instanceof fl&&e._firestore===t._firestore&&xu(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function pl(e){e=du(e,wu);const t=du(e.firestore,Hu);return Ku(Yu(t),e._key).then((n=>Cl(t,e,n)))}class yl extends al{constructor(e){super(),this.firestore=e}convertBytes(e){return new uc(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new wu(this.firestore,null,t)}}function wl(e){e=du(e,wu);const t=du(e.firestore,Hu),n=Yu(t),r=new yl(t);return function(e,t){const n=new x;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await function(e,t){const n=T(e);return n.persistence.runTransaction("read document","readonly",(e=>n.localDocuments.getDocument(e,t)))}(e,t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new S(E.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){const r=aa(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await Ou(e),t,n))),n.promise}(n,e._key).then((n=>new hl(t,r,e._key,n,new ll(null!==n&&n.hasLocalMutations,!0),e.converter)))}function vl(e){e=du(e,wu);const t=du(e.firestore,Hu);return Ku(Yu(t),e._key,{source:"server"}).then((n=>Cl(t,e,n)))}function Il(e){e=du(e,vu);const t=du(e.firestore,Hu),n=Yu(t),r=new yl(t);return Bc(e._query),Gu(n,e._query).then((n=>new fl(t,r,e,n)))}function bl(e){e=du(e,vu);const t=du(e.firestore,Hu),n=Yu(t),r=new yl(t);return function(e,t){const n=new x;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await to(e,t,!0),s=new xa(t,r.Hi),i=s.Wu(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(e){const r=aa(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await Ou(e),t,n))),n.promise}(n,e._query).then((n=>new fl(t,r,e,n)))}function Tl(e){e=du(e,vu);const t=du(e.firestore,Hu),n=Yu(t),r=new yl(t);return Gu(n,e._query,{source:"server"}).then((n=>new fl(t,r,e,n)))}function El(e,t,n){e=du(e,wu);const r=du(e.firestore,Hu),s=ul(e.converter,t,n);return Al(r,[vc(wc(r),"setDoc",e._key,s,null!==e.converter,n).toMutation(e._key,mn.none())])}function Sl(e,t,n,...r){e=du(e,wu);const s=du(e.firestore,Hu),i=wc(s);let a;return a="string"==typeof(t=(0,o.m9)(t))||t instanceof cc?_c(i,"updateDoc",e._key,t,n,r):Dc(i,"updateDoc",e._key,t),Al(s,[a.toMutation(e._key,mn.exists(!0))])}function xl(e){return Al(du(e.firestore,Hu),[new _n(e._key,mn.none())])}function Dl(e,t){const n=du(e.firestore,Hu),r=Eu(e),s=ul(e.converter,t);return Al(n,[vc(wc(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,mn.exists(!1))]).then((()=>r))}function _l(e,...t){var n,r,s;e=(0,o.m9)(e);let i={includeMetadataChanges:!1},a=0;"object"!=typeof t[a]||zu(t[a])||(i=t[a],a++);const u={includeMetadataChanges:i.includeMetadataChanges};if(zu(t[a])){const e=t[a];t[a]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[a+1]=null===(r=e.error)||void 0===r?void 0:r.bind(e),t[a+2]=null===(s=e.complete)||void 0===s?void 0:s.bind(e)}let c,l,h;if(e instanceof wu)l=du(e.firestore,Hu),h=Mt(e._key.path),c={next:n=>{t[a]&&t[a](Cl(l,e,n))},error:t[a+1],complete:t[a+2]};else{const n=du(e,vu);l=du(n.firestore,Hu),h=n._query;const r=new yl(l);c={next:e=>{t[a]&&t[a](new fl(l,r,n,e))},error:t[a+1],complete:t[a+2]},Bc(e._query)}return function(e,t,n,r){const s=new _u(r),i=new wa(t,s,n);return e.asyncQueue.enqueueAndForget((async()=>fa(await Bu(e),i))),()=>{s.bc(),e.asyncQueue.enqueueAndForget((async()=>ma(await Bu(e),i)))}}(Yu(l),h,u,c)}function Nl(e,t){return function(e,t){const n=new _u(t);return e.asyncQueue.enqueueAndForget((async()=>function(e,t){T(e).Ru.add(t),t.next()}(await Bu(e),n))),()=>{n.bc(),e.asyncQueue.enqueueAndForget((async()=>function(e,t){T(e).Ru.delete(t)}(await Bu(e),n)))}}(Yu(e=du(e,Hu)),zu(t)?t:{next:t})}function Al(e,t){return function(e,t){const n=new x;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const r=nu(e);try{const e=await function(e,t){const n=T(e),r=q.now(),s=t.reduce(((e,t)=>e.add(t.key)),Qn());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>{let a=Fn(),u=Qn();return n.Gi.getEntries(e,s).next((e=>{a=e,a.forEach(((e,t)=>{t.isValidDocument()||(u=u.add(e))}))})).next((()=>n.localDocuments.getOverlayedDocuments(e,a))).next((s=>{i=s;const o=[];for(const e of t){const t=In(e,i.get(e.key).overlayedDocument);null!=t&&o.push(new En(e.key,t,ct(t.value.mapValue),mn.exists(!0)))}return n.mutationQueue.addMutationBatch(e,r,o,t)})).next((t=>{o=t;const r=t.applyToLocalDocumentSet(i,u);return n.documentOverlayCache.saveOverlays(e,t.batchId,r)}))})).then((()=>({batchId:o.batchId,changes:qn(i)})))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.hc[e.currentUser.toKey()];r||(r=new Ie(F)),r=r.insert(t,n),e.hc[e.currentUser.toKey()]=r}(r,e.batchId,n),await $a(r,e.changes),await jo(r.remoteStore)}catch(e){const t=aa(e,"Failed to persist write");n.reject(t)}}(await qu(e),t,n))),n.promise}(Yu(e),t)}function Cl(e,t,n){const r=n.docs.get(t._key),s=new yl(e);return new hl(e,s,t._key,r,new ll(n.hasPendingWrites,n.fromCache),t.converter)}const kl={maxAttempts:5};class Rl{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=wc(e)}set(e,t,n){this._verifyNotCommitted();const r=Vl(e,this._firestore),s=ul(r.converter,t,n),i=vc(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,mn.none())),this}update(e,t,n,...r){this._verifyNotCommitted();const s=Vl(e,this._firestore);let i;return i="string"==typeof(t=(0,o.m9)(t))||t instanceof cc?_c(this._dataReader,"WriteBatch.update",s._key,t,n,r):Dc(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,mn.exists(!0))),this}delete(e){this._verifyNotCommitted();const t=Vl(e,this._firestore);return this._mutations=this._mutations.concat(new _n(t._key,mn.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new S(E.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function Vl(e,t){if((e=(0,o.m9)(e)).firestore!==t)throw new S(E.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class Ll extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=wc(e)}get(e){const t=Vl(e,this._firestore),n=new cl(this._firestore);return this._transaction.lookup([t._key]).then((e=>{if(!e||1!==e.length)return v();const r=e[0];if(r.isFoundDocument())return new Pc(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new Pc(this._firestore,n,t._key,null,t.converter);throw v()}))}set(e,t,n){const r=Vl(e,this._firestore),s=ul(r.converter,t,n),i=vc(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(e,t,n,...r){const s=Vl(e,this._firestore);let i;return i="string"==typeof(t=(0,o.m9)(t))||t instanceof cc?_c(this._dataReader,"Transaction.update",s._key,t,n,r):Dc(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){const t=Vl(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=Vl(e,this._firestore),n=new yl(this._firestore);return super.get(e).then((e=>new hl(this._firestore,n,t._key,e._document,new ll(!1,!1),t.converter)))}}function Ml(e,t,n){e=du(e,Hu);const r=Object.assign(Object.assign({},kl),n);return function(e){if(e.maxAttempts<1)throw new S(E.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(e,t,n){const r=new x;return e.asyncQueue.enqueueAndForget((async()=>{const s=await Uu(e);new Cu(e.asyncQueue,s,n,t,r).run()})),r.promise}(Yu(e),(n=>t(new Ll(e,n))),r)}function Fl(){return new Ic("deleteField")}function Ol(){return new Tc("serverTimestamp")}function Pl(...e){return new Ec("arrayUnion",e)}function ql(...e){return new Sc("arrayRemove",e)}function Ul(e){return new xc("increment",e)}!function(e,t=!0){!function(e){h=e}(r.SDK_VERSION),(0,r._registerComponent)(new s.wA("firestore",((e,{instanceIdentifier:n,options:r})=>{const s=e.getProvider("app").getImmediate(),i=new Hu(new A(e.getProvider("auth-internal")),new V(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new S(E.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Oe(e.options.projectId,t)}(s,n),s);return r=Object.assign({useFetchStreams:t},r),i._setSettings(r),i}),"PUBLIC").setMultipleInstances(!0)),(0,r.registerVersion)(c,"3.7.2",e),(0,r.registerVersion)(c,"3.7.2","esm2017")}()}}]);